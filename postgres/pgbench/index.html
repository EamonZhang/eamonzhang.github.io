<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <title>pgbench å‹åŠ›æµ‹è¯• | Let&#39;s go ğŸŒ ğŸŒ ğŸŒ</title>
    <meta property="og:title" content="pgbench å‹åŠ›æµ‹è¯• - Let&#39;s go ğŸŒ ğŸŒ ğŸŒ">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2019-01-09T16:36:47&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2019-01-09T16:36:47&#43;08:00'>
        
    <meta name="Keywords" content="postgres ã€pythonã€pg ã€linix ã€dockerã€ kubernetesã€ cloudã€hadoopã€promethues ">
    <meta name="description" content="pgbench å‹åŠ›æµ‹è¯•">
        
    <meta name="author" content="Eamon">
    <meta property="og:url" content="https://zhangeamon.top/postgres/pgbench/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    
    
    <script type="text/javascript" src="/js/jquery.min.js"></script>
   
    
    
    
    
    
    
        <link rel="stylesheet" href='/css/douban.css'>
    
        <link rel="stylesheet" href='/css/other.css'>
    
   
        <a href=https://github.com/eamonzhang><img style="position: absolute; top: 0; left: 0; border: 0;" src="/images/forkme_left_red_aa0000.png" alt="Fork me on GitHub" data-canonical-src="/images/forkme_left_red_aa0000.png"></a>

   
        <script>
          var _hmt = _hmt || [];
            (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?1f6605a363a50554aa03adcc685b7699";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
          })();
       </script>
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://zhangeamon.top">
                        Let&#39;s go ğŸŒ ğŸŒ ğŸŒ
                    </a>
                
                <p class="description">Let&#39;s build our own cloud native together  </p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="" href="https://zhangeamon.top">é¦–é¡µ</a>
                    
                    <a  href="https://zhangeamon.top/archives" title="å½’æ¡£">å½’æ¡£</a>
                    
                    <a  href="https://zhangeamon.top/postgresql" title="Postgres">Postgres</a>
                    
                    <a  href="https://zhangeamon.top/linux" title="Linux">Linux</a>
                    
                    <a  href="https://zhangeamon.top/about/me" title="å…³äº">å…³äº</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    

    <article class="post">
        <header>
            <h1 class="post-title">pgbench å‹åŠ›æµ‹è¯•</h1>
        </header>
        <date class="post-meta meta-date">
            2019å¹´1æœˆ9æ—¥
        </date>
        
        
        
        <div class="post-content">
            <h4 id="ä»‹ç»">ä»‹ç»</h4>
<p>pgbenchæ˜¯ä¸€ç§åœ¨PostgreSQLä¸Šè¿è¡ŒåŸºå‡†æµ‹è¯•çš„ç®€å•ç¨‹åºã€‚<br>
<a href="http://www.postgres.cn/docs/9.6/pgbench.html">å®˜æ–¹æ–‡æ¡£</a></p>
<ul>
<li>é»˜è®¤æµ‹è¯•</li>
<li>è‡ªå®šä¹‰æµ‹è¯•</li>
</ul>
<h4 id="é»˜è®¤æµ‹è¯•">é»˜è®¤æµ‹è¯•</h4>
<p>pgbenchä¸­é»˜è®¤è‡ªå¸¦ä¸€å¥—æµ‹è¯•æ•°æ®åº“å’Œæµ‹è¯•sqlè„šæœ¬ã€‚</p>
<h6 id="åˆå§‹åŒ–é»˜è®¤æ•°æ®åº“">åˆå§‹åŒ–é»˜è®¤æ•°æ®åº“</h6>
<pre><code>ä½¿ç”¨ -i åˆå§‹åŒ–æ•°æ®åº“

#pgbench -U postgres -i -s 10 pgbenchdb
NOTICE:  table &quot;pgbench_history&quot; does not exist, skipping
NOTICE:  table &quot;pgbench_tellers&quot; does not exist, skipping
NOTICE:  table &quot;pgbench_accounts&quot; does not exist, skipping
NOTICE:  table &quot;pgbench_branches&quot; does not exist, skipping
creating tables...
100000 of 1000000 tuples (10%) done (elapsed 0.14 s, remaining 1.23 s)
200000 of 1000000 tuples (20%) done (elapsed 0.27 s, remaining 1.06 s)
300000 of 1000000 tuples (30%) done (elapsed 0.42 s, remaining 0.99 s)
400000 of 1000000 tuples (40%) done (elapsed 0.51 s, remaining 0.77 s)
500000 of 1000000 tuples (50%) done (elapsed 0.72 s, remaining 0.72 s)
600000 of 1000000 tuples (60%) done (elapsed 0.87 s, remaining 0.58 s)
700000 of 1000000 tuples (70%) done (elapsed 0.97 s, remaining 0.42 s)
800000 of 1000000 tuples (80%) done (elapsed 1.15 s, remaining 0.29 s)
900000 of 1000000 tuples (90%) done (elapsed 1.30 s, remaining 0.14 s)
1000000 of 1000000 tuples (100%) done (elapsed 1.46 s, remaining 0.00 s)
set primary keys...
done.

å‚æ•°è¯´æ˜ï¼š
-i --initialize è¡¨ç¤ºåˆå§‹åŒ–æ•°æ®,æ³¨æ„åŸæ¥çš„æ•°æ®å¦‚æœå­˜åœ¨å°†è¢«è¦†ç›–ã€‚
-s scale_factor è§„æ¨¡å› å­ æ•°æ®é‡è§„æ¨¡

æŸ¥çœ‹åˆå§‹åŒ–åçš„æ•°æ®åº“

psql -U postgres -d pgbenchdb
pgbenchdb=# \d+
                               å…³è”åˆ—è¡¨
 æ¶æ„æ¨¡å¼ |        åç§°        |  ç±»å‹  |  æ‹¥æœ‰è€…  |    å¤§å°    | æè¿° 
----------+--------------------+--------+----------+------------+------
 public   | pg_stat_statements | è§†å›¾   | postgres | 0 bytes    | 
 public   | pgbench_accounts   | æ•°æ®è¡¨ | postgres | 128 MB     | 
 public   | pgbench_branches   | æ•°æ®è¡¨ | postgres | 8192 bytes | 
 public   | pgbench_history    | æ•°æ®è¡¨ | postgres | 0 bytes    | 
 public   | pgbench_tellers    | æ•°æ®è¡¨ | postgres | 8192 bytes | 
(5 è¡Œè®°å½•)

</code></pre><h5 id="å¼€å§‹æµ‹è¯•">å¼€å§‹æµ‹è¯•</h5>
<pre><code>pgbench -M prepared -r -n -c 100 -j 100 -T 100 -U postgres   pgbenchdb 
transaction type: &lt;builtin: TPC-B (sort of)&gt;
scaling factor: 10
query mode: prepared
number of clients: 100
number of threads: 100
duration: 100 s
number of transactions actually processed: 375474
latency average = 26.667 ms
tps = 3749.964314 (including connections establishing)
tps = 3754.003534 (excluding connections establishing)
script statistics:
 - statement latencies in milliseconds:
         0.002  \set aid random(1, 100000 * :scale)
         0.000  \set bid random(1, 1 * :scale)
         0.000  \set tid random(1, 10 * :scale)
         0.000  \set delta random(-5000, 5000)
         0.252  BEGIN;
         0.299  UPDATE pgbench_accounts SET abalance = abalance + :delta WHERE aid = :aid;
         0.199  SELECT abalance FROM pgbench_accounts WHERE aid = :aid;
        13.609  UPDATE pgbench_tellers SET tbalance = tbalance + :delta WHERE tid = :tid;
         9.879  UPDATE pgbench_branches SET bbalance = bbalance + :delta WHERE bid = :bid;
         0.252  INSERT INTO pgbench_history (tid, bid, aid, delta, mtime) VALUES (:tid, :bid, :aid, :delta, CURRENT_TIMESTAMP);
         2.100  END;

å‚æ•°è¯´æ˜ï¼š
-M æ¨¡å¼ simple extended prepared
-r æ¯ä¸€ä¸ªè¯­å¥èŠ±è´¹çš„äº‹åŠ¡æ—¶é—´
-n è¿è¡Œå‰ä¸æ‰§è¡Œvaccumun ,è‡ªå®šä¹‰çš„è„šæœ¬è¿è¡Œä¸­å¿…é¡»è¦ä½¿ç”¨
-c å®¢æˆ·ç«¯æ•°é‡
-j çº¿ç¨‹æ•°é‡ å®¢æˆ·ç«¯å…±ç”¨æ‰€æœ‰çš„çº¿ç¨‹ -j &lt;= -c 
-T è¿è¡Œçš„æ—¶é—´ å•ä½ç§’ ã€‚ æ—¶é—´å¤ªçŸ­ä¼šå¯¼è‡´ç»“æœä¸æ˜¯å¾ˆå‡†ç¡®ï¼Œè‡³å°‘è¦è¿è¡Œå‡ åˆ†é’Ÿï¼Œæ¶ˆé™¤å™ªå£°å¯¹ç»“æœçš„å½±å“ã€‚
-t è¿è¡Œçš„äº‹åŠ¡æ•° æ¯ä¸ªå®¢æˆ·ç«¯
</code></pre><h5 id="ç»“æœè§£è¯»">ç»“æœè§£è¯»</h5>
<p>ç•¥ ï¼Œä¸€çœ‹å°±æ‡‚</p>
<h4 id="è‡ªå®šä¹‰æµ‹è¯•">è‡ªå®šä¹‰æµ‹è¯•</h4>
<p>ç¤ºä¾‹è¯´æ˜</p>
<pre><code>pgbench -M prepared -n -r -c 32 -j 32 -P 5 -C -f ./test.sql -U postgres pgbenchdb -T 300
</code></pre><p>æ³¨æ„äº‹é¡¹: pgbenchä¸pgä¸è¦åœ¨åŒä¸€å°æœºå™¨ä¸Š</p>
<p>å„ç§åœºæ™¯å‹åŠ›æµ‹è¯•
<a href="https://github.com/digoal/blog/blob/362b84417ca8b7aaf1add31fe7689c347642bb9a/201706/20170601_02.md">https://github.com/digoal/blog/blob/362b84417ca8b7aaf1add31fe7689c347642bb9a/201706/20170601_02.md</a></p>
<h4 id="é‡è§é—®é¢˜">é‡è§é—®é¢˜</h4>
<p>æµ‹è¯• -C å‚æ•°æ—¶ ä½¿ç”¨çš„pgbouncerä½œä¸ºè¿æ¥æ± å‡ºç°å¦‚ä¸‹é”™è¯¯</p>
<pre><code>Cannot assign requested address
</code></pre><p>åŸå› å®¢æˆ·ç«¯é¢‘ç¹çš„è¿æœåŠ¡å™¨ï¼Œç”±äºæ¯æ¬¡è¿æ¥éƒ½åœ¨å¾ˆçŸ­çš„æ—¶é—´å†…ç»“æŸï¼Œå¯¼è‡´å¾ˆå¤šçš„TIME_WAITï¼Œä»¥è‡³äºç”¨å…‰äº†å¯ç”¨çš„ç«¯å£å·ï¼Œæ‰€ä»¥æ–°çš„è¿æ¥æ²¡åŠæ³•ç»‘å®šç«¯å£ï¼Œå³â€œCannot assign requested addressâ€ã€‚<br>
æ˜¯å®¢æˆ·ç«¯çš„é—®é¢˜ä¸æ˜¯æœåŠ¡å™¨ç«¯çš„é—®é¢˜ã€‚é€šè¿‡netstatï¼Œçš„ç¡®çœ‹åˆ°å¾ˆå¤šTIME_WAITçŠ¶æ€çš„è¿æ¥ã€‚</p>
<p>clientç«¯é¢‘ç¹å»ºç«‹è¿æ¥ï¼Œè€Œç«¯å£é‡Šæ”¾è¾ƒæ…¢ï¼Œå¯¼è‡´å»ºç«‹æ–°è¿æ¥æ—¶æ— å¯ç”¨ç«¯å£ã€‚</p>
<p>è§£å†³æ–¹æ³•ï¼š</p>
<p>æ‰§è¡Œå‘½ä»¤ä¿®æ”¹å¦‚ä¸‹2ä¸ªå†…æ ¸å‚æ•° ï¼ˆéœ€è¦rootæƒé™ï¼‰<br>
sysctl -w net.ipv4.tcp_timestamps=1  å¼€å¯å¯¹äºTCPæ—¶é—´æˆ³çš„æ”¯æŒ,è‹¥è¯¥é¡¹è®¾ç½®ä¸º0ï¼Œåˆ™ä¸‹é¢ä¸€é¡¹è®¾ç½®ä¸èµ·ä½œç”¨<br>
sysctl -w net.ipv4.tcp_tw_recycle=1  è¡¨ç¤ºå¼€å¯TCPè¿æ¥ä¸­TIME-WAIT socketsçš„å¿«é€Ÿå›æ”¶</p>

        </div>

        


        

<div class="post-archive">
    <h2>å…¶ä»–æ–‡ç« </h2>
    <ul class="listing">
        
        <li><a href="/linux/at-crontab/">å®šæ—¶ä»»åŠ¡</a></li>
        
        <li><a href="/linux/nospace-device/">no space left on device</a></li>
        
        <li><a href="/linux/meminfo/">meminfo Linux å†…å­˜ä¿¡æ¯</a></li>
        
    </ul>
</div>



        <div class="post-meta meta-tags">
            
            æ²¡æœ‰æ ‡ç­¾
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "your github repo"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2018 - 2021 <a href="https://zhangeamon.top"> By Eamon</a>
        
    </div>
    <br />
  
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>






    <script src='/js/douban.js'></script>


                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://zhangeamon.top/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://zhangeamon.top">
      <button type="submit" class="submit icon-search"></button>
</form>

    </section>
    
    <section class="widget">
        <h3 class="widget-title">æœ€è¿‘æ–‡ç« </h3>
<ul class="widget-list">
    
    <li>
        <a href="https://zhangeamon.top/redis/automated-keyword/" title="è”æƒ³æœç´¢">è”æƒ³æœç´¢</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/python/push_messages/" title="æ¶ˆæ¯æ¨é€">æ¶ˆæ¯æ¨é€</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/postgres/pg_elk/" title="æ•°æ®åº“æ—¥å¿—åˆ†æ">æ•°æ®åº“æ—¥å¿—åˆ†æ</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/linux/findhidpid/" title="Linux æ‰¾å‡ºéšè—è¿›ç¨‹">Linux æ‰¾å‡ºéšè—è¿›ç¨‹</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/network-security/wazuh/" title="Wazuh åŠŸèƒ½ç®€ä»‹">Wazuh åŠŸèƒ½ç®€ä»‹</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/linux/last/" title="Linux ç³»ç»Ÿç™»é™†è®°å½•">Linux ç³»ç»Ÿç™»é™†è®°å½•</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/linux/ubuntu2004-qa/" title="Ubuntu20.04 è£…æœºå">Ubuntu20.04 è£…æœºå</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/mysql/master-slave/" title="ä¸»ä»å¤åˆ¶">ä¸»ä»å¤åˆ¶</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/mysql/connections/" title="è¿æ¥æ•°ç®¡ç†">è¿æ¥æ•°ç®¡ç†</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/redis/pubsub/" title="å‘å¸ƒè®¢é˜…">å‘å¸ƒè®¢é˜…</a>
    </li>
    
</ul>

    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories'>åˆ†ç±»</a></h3>
<ul class="widget-list">
    
    <li><a href="https://zhangeamon.top/categories/ansible/">ansible (4)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/docker/">docker (1)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/etcd/">etcd (1)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/linux/">linux (15)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/mysql/">mysql (4)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/postgres/">postgres (20)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/python/">python (15)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/rabbitmq/">rabbitmq (2)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/redis/">redis (8)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">ä¸­é—´ä»¶ (10)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E5%AD%98%E5%82%A8/">å­˜å‚¨ (3)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E5%AE%89%E5%85%A8/">å®‰å…¨ (2)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E6%95%B0%E4%BB%93/">æ•°ä»“ (3)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E7%9B%91%E6%8E%A7/">ç›‘æ§ (2)</a></li>
    
</ul>

    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags.html'>æ ‡ç­¾</a></h3>
<div class="tagcloud">
    
    <a href="https://zhangeamon.top/tags/%E4%BC%98%E5%8C%96/">ä¼˜åŒ–</a>
    
    <a href="https://zhangeamon.top/tags/%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/">é…ç½®ç®¡ç†</a>
    
    <a href="https://zhangeamon.top/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/">é«˜å¯ç”¨</a>
    
</div>

    </section>

    
<section class="widget">
    <h3 class="widget-title">å‹æƒ…é“¾æ¥</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="http://www.cnblogs.com/zhangeamon" title="å†å²åšå®¢">å†å²åšå®¢</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">å…¶å®ƒ</h3>
        <ul class="widget-list">
            <li><a href="https://zhangeamon.top/index.xml">æ–‡ç«  RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
   
</body>

</html>
