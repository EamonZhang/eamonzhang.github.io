<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <title>æ•°æ®åº“è§†å›¾ä¹‹ pg_stat_activity | Let&#39;s go ğŸŒ ğŸŒ ğŸŒ</title>
    <meta property="og:title" content="æ•°æ®åº“è§†å›¾ä¹‹ pg_stat_activity - Let&#39;s go ğŸŒ ğŸŒ ğŸŒ">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2019-08-23T13:47:12&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2019-08-23T13:47:12&#43;08:00'>
        
    <meta name="Keywords" content="postgres ã€pythonã€pg ã€linix ã€dockerã€ kubernetesã€ cloudã€hadoopã€promethues ">
    <meta name="description" content="æ•°æ®åº“è§†å›¾ä¹‹ pg_stat_activity">
        
    <meta name="author" content="Eamon">
    <meta property="og:url" content="https://zhangeamon.top/postgres/view_pg_stat_activity/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    
    
    <script type="text/javascript" src="/js/jquery.min.js"></script>
   
    
    
    
    
    
    
        <link rel="stylesheet" href='/css/douban.css'>
    
        <link rel="stylesheet" href='/css/other.css'>
    
   
        <a href=https://github.com/eamonzhang><img style="position: absolute; top: 0; left: 0; border: 0;" src="/images/forkme_left_red_aa0000.png" alt="Fork me on GitHub" data-canonical-src="/images/forkme_left_red_aa0000.png"></a>

   
        <script>
          var _hmt = _hmt || [];
            (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?1f6605a363a50554aa03adcc685b7699";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
          })();
       </script>
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://zhangeamon.top">
                        Let&#39;s go ğŸŒ ğŸŒ ğŸŒ
                    </a>
                
                <p class="description">Let&#39;s build our own cloud native together  </p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="" href="https://zhangeamon.top">é¦–é¡µ</a>
                    
                    <a  href="https://zhangeamon.top/archives" title="å½’æ¡£">å½’æ¡£</a>
                    
                    <a  href="https://zhangeamon.top/postgresql" title="Postgres">Postgres</a>
                    
                    <a  href="https://zhangeamon.top/linux" title="Linux">Linux</a>
                    
                    <a  href="https://zhangeamon.top/about/me" title="å…³äº">å…³äº</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    

    <article class="post">
        <header>
            <h1 class="post-title">æ•°æ®åº“è§†å›¾ä¹‹ pg_stat_activity</h1>
        </header>
        <date class="post-meta meta-date">
            2019å¹´8æœˆ23æ—¥
        </date>
        
        
        
        <div class="post-content">
            <h2 id="ä»‹ç»">ä»‹ç»</h2>
<p>å½“éœ€è¦äº†è§£æ•°æ®åº“å½“å‰è¿è¡ŒçŠ¶æ€æˆ–éœ€è¦æ’æŸ¥é—®é¢˜æ—¶ï¼Œé¦–å…ˆéœ€è¦æŸ¥çœ‹çš„å°±æ˜¯pg_stat_activityã€‚è¯¥è§†å›¾ä¸­åŒ…å«äº†ä½ æƒ³çŸ¥é“çš„æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼Œæ­£åœ¨æ‰§è¡Œçš„æœ‰å“ªäº›sqlï¼Œå¹¶å¤„äºä½•çŠ¶æ€ã€‚</p>
<p>One row per server process, showing information related to the current activity of that process, such as state and current query.</p>
<p>æ¯ä¸€è¡Œéƒ½è¡¨ç¤ºä¸€ä¸ªç³»ç»Ÿè¿›ç¨‹ï¼Œæ˜¾ç¤ºä¸å½“å‰ä¼šè¯çš„æ´»åŠ¨è¿›ç¨‹çš„ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚å½“å‰å›è¯çš„çŠ¶æ€å’ŒæŸ¥è¯¢ç­‰ã€‚</p>
<h2 id="å­—æ®µè§£è¯»">å­—æ®µè§£è¯»</h2>
<table>
<thead>
<tr>
<th style="text-align:left">Column</th>
<th style="text-align:left">Type</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">datid</td>
<td style="text-align:left">oid</td>
<td style="text-align:left">OID of the database this backend is connected to</td>
</tr>
<tr>
<td style="text-align:left">datname</td>
<td style="text-align:left">name</td>
<td style="text-align:left">Name of the database this backend is connected to</td>
</tr>
<tr>
<td style="text-align:left">pid</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">Process ID of this backend</td>
</tr>
<tr>
<td style="text-align:left">usesysid</td>
<td style="text-align:left">oid</td>
<td style="text-align:left">OID of the user logged into this backend</td>
</tr>
<tr>
<td style="text-align:left">usename</td>
<td style="text-align:left">name</td>
<td style="text-align:left">Name of the user logged into this backend</td>
</tr>
<tr>
<td style="text-align:left">application_name</td>
<td style="text-align:left">text</td>
<td style="text-align:left">Name of the application that is connected to this backend</td>
</tr>
<tr>
<td style="text-align:left">client_addr</td>
<td style="text-align:left">inet</td>
<td style="text-align:left">IP address of the client connected to this backend. If this field is null, itindicates(è¡¨æ˜) either that the client is connected via a Unixsocket(æ’åº§) on the server machine or that this is aninternal(å†…éƒ¨çš„) process such as autovacuum.</td>
</tr>
<tr>
<td style="text-align:left">client_hostname</td>
<td style="text-align:left">text</td>
<td style="text-align:left">Host name of the connected client, as reported by a reverse(ç›¸å) DNS lookup(æŸ¥æ‰¾) of client_addr. This field will only be non-null for IP connections, and only whenlog_hostname is enabled.</td>
</tr>
<tr>
<td style="text-align:left">client_port</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">TCP port number that the client is using for communication with this backend, or-1 if a Unixsocket(æ’åº§) is used</td>
</tr>
<tr>
<td style="text-align:left">backend_start</td>
<td style="text-align:left">timestamp(æ—¶é—´æˆ³) with time zone</td>
<td style="text-align:left">Time when this process was started, i.e., when the client connected to the server</td>
</tr>
<tr>
<td style="text-align:left">xact_start</td>
<td style="text-align:left">timestamp with time zone</td>
<td style="text-align:left">Time when this process' current transaction(äº¤æ˜“) was started, or null if no transaction is active. If the current query is the first of its transaction, this column is equal to the query_start column.</td>
</tr>
<tr>
<td style="text-align:left">query_start</td>
<td style="text-align:left">timestamp with time zone</td>
<td style="text-align:left">Time when the currently active query was started, or if state is not active, when the last query was started</td>
</tr>
<tr>
<td style="text-align:left">state_change</td>
<td style="text-align:left">timestamp(æ—¶é—´æˆ³) with time zone</td>
<td style="text-align:left">Time when the state was last changed</td>
</tr>
<tr>
<td style="text-align:left">waiting</td>
<td style="text-align:left">boolean</td>
<td style="text-align:left">True if this backend is currently waiting on a lock</td>
</tr>
<tr>
<td style="text-align:left">state</td>
<td style="text-align:left">text</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">query</td>
<td style="text-align:left">text</td>
<td style="text-align:left">Text of this backend&rsquo;s most recent query. Ifstate isactive this field shows the currently executing query. In all other states, it shows the last query that was executed.</td>
</tr>
</tbody>
</table>
<h2 id="state-å­—æ®µè¯¦è§£">state å­—æ®µè¯¦è§£</h2>
<ul>
<li>active: The backend isexecuting(å®è¡Œ) a query. æ­£åœ¨æ‰§è¡Œä¸­</li>
<li>idle: The backend is waiting for a new client command. è¿æ¥å·²ç»å»ºç«‹ç­‰å¾…å®¢æˆ·ç«¯å‘½ä»¤</li>
<li>idle in transaction: The backend is in atransaction(äº¤æ˜“), but is not currentlyexecuting(å®è¡Œ) a query. äº‹åŠ¡å·²ç»begin å°šæœªcommit</li>
<li>idleÂ in transaction (aborted): This state is similar toidle in transaction, except one of thestatements(å£°æ˜) in the transaction caused an error. äº‹åŠ¡ä¸­æ–­</li>
<li>fastpath function call: The backend is executing a fast-path function.</li>
<li>disabled: This state is reported iftrack_activities is disabled in this backend.</li>
</ul>
<h2 id="å½“å‰æ­£åœ¨æ‰§è¡Œçš„æŸ¥è¯¢æ‰€å¤„çš„çŠ¶æ€">å½“å‰æ­£åœ¨æ‰§è¡Œçš„æŸ¥è¯¢æ‰€å¤„çš„çŠ¶æ€</h2>
<pre><code>select datname, count(*) AS open,count(*) FILTER (WHERE state = 'active') AS active,
                count(*) FILTER(WHERE state = 'idle') AS idle ,
                count(*) FILTER(WHERE state = 'idle in transaction') AS idle_in_trans
                FROM pg_stat_activity GROUP BY ROLLUP(1);
</code></pre><h2 id="ä¸€ç›´æœ‰è¿æ¥é•¿æ—¶é—´å¤„äºidle-in-transactionçš„é—®é¢˜">ä¸€ç›´æœ‰è¿æ¥é•¿æ—¶é—´å¤„äºidle in transactionçš„é—®é¢˜</h2>
<p>é…ç½®postgresql.conf</p>
<pre><code>idle_in_transaction_session_timeout=30000
</code></pre><h2 id="query-å†…å®¹æ˜¾ç¤ºä¸å…¨">query å†…å®¹æ˜¾ç¤ºä¸å…¨</h2>
<p>é…ç½®postgresql.conf</p>
<pre><code>track_activity_query_size=32768
</code></pre><h2 id="æ€æ­»å·²æŒ‚æ‰çš„è¿æ¥">æ€æ­»å·²æŒ‚æ‰çš„è¿æ¥</h2>
<pre><code>select pg_terminate_backend(pid)
</code></pre><h2 id="å–æ¶ˆæ­£åœ¨æ‰§è¡Œçš„sql-pid-ä¸ä¼šé‡Šæ”¾è¿æ¥åªä¼šå–æ¶ˆsqlæŸ¥è¯¢è¯­å¥">å–æ¶ˆæ­£åœ¨æ‰§è¡Œçš„sql pid (ä¸ä¼šé‡Šæ”¾è¿æ¥ï¼Œåªä¼šå–æ¶ˆsqlæŸ¥è¯¢è¯­å¥)</h2>
<pre><code>SELECT pg_cancel_backend(pid);
</code></pre><h2 id="è¿›ä¸€æ­¥åŠŸèƒ½æ‰©å±•">è¿›ä¸€æ­¥åŠŸèƒ½æ‰©å±•</h2>
<p><a href="https://github.com/pgsentinel/pgsentinel">https://github.com/pgsentinel/pgsentinel</a></p>
<ul>
<li>postgresql extension providing Active session history</li>
</ul>
<p>ç±»ä¼¼ Oracleä¸­çš„ASH(Active Session History)ï¼ŒASHé€šè¿‡æ¯ç§’é’ŸæŠ½å–æ´»åŠ¨ä¼šè¯æ ·æœ¬ï¼Œä¸ºåˆ†æåœ¨æœ€è¿‘æ—¶åˆ»çš„æ€§èƒ½é—®é¢˜æä¾›æœ€ç›´æ¥æœ‰æ•ˆçš„ä¾æ®ã€‚</p>
<p>åº”ç”¨åœºæ™¯ï¼š å½“ç›‘æ§æ˜¾ç¤ºï¼ŒæŸä¸ªç¬é—´æ•°æ®åº“è¿æ¥æ•°è¶…è¿‡é˜€å€¼ã€‚ æŸ¥çœ‹æ—¥å¿—æ˜¾ç¤ºtoo many connentions ã€‚ ä½¿ç”¨pg_stat_activity è§†å›¾æ—¶åªèƒ½æŸ¥çœ‹å½“å‰çš„æ´»åŠ¨è¿æ¥ã€‚æ•…éšœç¬é—´æŠ“å–ä¸åˆ°ã€‚</p>
<p>pgsentinel è®°å½•äº†å†å²æ´»åŠ¨çŠ¶æ€ï¼Œå¸®åŠ©å¯¹å†å²é—®é¢˜çš„è¿½æº¯ã€‚</p>
<h2 id="pg_top">pg_top</h2>
<p>ç±»ä¼¼ Linux top</p>
<p>å®‰è£…</p>
<pre><code>yum install pg_top
</code></pre><p>ä½¿ç”¨ (æœ¬æœº &amp; è¿œç¨‹)</p>
<pre><code>#pg_top -U postgres -h **** 

last pid: 55852;  load avg:  1.55,  1.25,  0.93;       up 0+23:44:48                                                                                                                09:17:30
7 processes: 5 sleeping, 2 uninterruptable
CPU states:  1.1% user,  0.0% nice,  0.5% system, 96.8% idle,  1.6% iowait
Memory: 125G used, 561M free, 240K buffers, 117G cached
DB activity: 242 tps, 12 rollbs/s,  12 buffer r/s, 99 hit%,  82120 row r/s,    0 row w/s
DB I/O:     0 reads/s,     0 KB/s,     0 writes/s,     0 KB/s
DB disk: 7450.0 GB total, 7055.5 GB free (5% used)
Swap: 4096M free

  PID USERNAME PRI NICE  SIZE   RES STATE   TIME   WCPU    CPU COMMAND
40030 postgres  20    0   17G 5624K sleep   0:07  0.68%  0.60% postmaster
40022 postgres  20    0   17G  946M sleep   0:05  0.42%  0.40% postmaster
40023 postgres  20    0   17G 1061M sleep   0:02  0.25%  0.00% postmaster
54528 postgres  20    0   17G 1220M disk    0:01  1.38%  0.00% postmaster
54963 postgres  20    0   17G  747M disk    0:01  1.27%  0.00% postmaster
40024 postgres  20    0   17G  130M sleep   0:00  0.03%  0.00% postmaster
55853 postgres  20    0   17G 6900K sleep   0:00  0.00%  0.00% postmaster
</code></pre>
        </div>

        


        

<div class="post-archive">
    <h2>å…¶ä»–æ–‡ç« </h2>
    <ul class="listing">
        
        <li><a href="/network-security/jumpserver/">Jumpserver è·³æ¿æœº</a></li>
        
        <li><a href="/postgres/citus01/">citus ç®€å•åº”ç”¨</a></li>
        
        <li><a href="/postgres/tpch/">tpch APæµ‹è¯•</a></li>
        
    </ul>
</div>



        <div class="post-meta meta-tags">
            
            æ²¡æœ‰æ ‡ç­¾
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "your github repo"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2018 - 2021 <a href="https://zhangeamon.top"> By Eamon</a>
        
    </div>
    <br />
  
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>






    <script src='/js/douban.js'></script>


                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://zhangeamon.top/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://zhangeamon.top">
      <button type="submit" class="submit icon-search"></button>
</form>

    </section>
    
    <section class="widget">
        <h3 class="widget-title">æœ€è¿‘æ–‡ç« </h3>
<ul class="widget-list">
    
    <li>
        <a href="https://zhangeamon.top/redis/pubsub/" title="å‘å¸ƒè®¢é˜…">å‘å¸ƒè®¢é˜…</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/redis/distributedlock/" title="åŸºäºRedis çš„åˆ†å¸ƒå¼é”å®ç°">åŸºäºRedis çš„åˆ†å¸ƒå¼é”å®ç°</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/postgres/libpg/" title="å®¢æˆ·ç«¯æ•…éšœè½¬ç§»">å®¢æˆ·ç«¯æ•…éšœè½¬ç§»</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/postgres/prepare/" title="ä½¿ç”¨prepareé¢„ç¼–è¯‘SQL">ä½¿ç”¨prepareé¢„ç¼–è¯‘SQL</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/postgres/materialized/" title="ç‰©åŒ–è§†å›¾">ç‰©åŒ–è§†å›¾</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/python/requests/" title="Requests">Requests</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/asr/c/" title="C è¯­è¨€ç¯å¢ƒ">C è¯­è¨€ç¯å¢ƒ</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/linux/lightdm/" title="å…³äºUbuntu20.04ä¸‹å‘æ—¥è‘µè¿œç¨‹è½¯ä»¶è¿æ¥ä¸­æ–­çš„è§£å†³æ–¹æ³•">å…³äºUbuntu20.04ä¸‹å‘æ—¥è‘µè¿œç¨‹è½¯ä»¶è¿æ¥ä¸­æ–­çš„è§£å†³æ–¹æ³•</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/linux/so/" title="åŠ¨æ€åº“">åŠ¨æ€åº“</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/python/ctypes/" title="python ä¸ C äº¤äº’ç¼–ç¨‹">python ä¸ C äº¤äº’ç¼–ç¨‹</a>
    </li>
    
</ul>

    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories'>åˆ†ç±»</a></h3>
<ul class="widget-list">
    
    <li><a href="https://zhangeamon.top/categories/ansible/">ansible (4)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/etcd/">etcd (1)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/linux/">linux (12)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/mysql/">mysql (1)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/postgres/">postgres (19)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/python/">python (13)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/rabbitmq/">rabbitmq (2)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/redis/">redis (4)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">ä¸­é—´ä»¶ (10)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E6%95%B0%E4%BB%93/">æ•°ä»“ (3)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E7%9B%91%E6%8E%A7/">ç›‘æ§ (2)</a></li>
    
</ul>

    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags.html'>æ ‡ç­¾</a></h3>
<div class="tagcloud">
    
    <a href="https://zhangeamon.top/tags/%E4%BC%98%E5%8C%96/">ä¼˜åŒ–</a>
    
    <a href="https://zhangeamon.top/tags/%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/">é…ç½®ç®¡ç†</a>
    
    <a href="https://zhangeamon.top/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/">é«˜å¯ç”¨</a>
    
</div>

    </section>

    
<section class="widget">
    <h3 class="widget-title">å‹æƒ…é“¾æ¥</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="http://www.cnblogs.com/zhangeamon" title="å†å²åšå®¢">å†å²åšå®¢</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">å…¶å®ƒ</h3>
        <ul class="widget-list">
            <li><a href="https://zhangeamon.top/index.xml">æ–‡ç«  RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
   
</body>

</html>
