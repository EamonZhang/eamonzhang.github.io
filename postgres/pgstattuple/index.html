<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <title>è¡¨ç©ºé—´è†¨èƒ€ | Let&#39;s go ğŸŒ ğŸŒ ğŸŒ</title>
    <meta property="og:title" content="è¡¨ç©ºé—´è†¨èƒ€ - Let&#39;s go ğŸŒ ğŸŒ ğŸŒ">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2019-05-22T17:26:45&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2019-05-22T17:26:45&#43;08:00'>
        
    <meta name="Keywords" content="postgres ã€pythonã€pg ã€linix ã€dockerã€ kubernetesã€ cloudã€hadoopã€promethues ">
    <meta name="description" content="è¡¨ç©ºé—´è†¨èƒ€">
        
    <meta name="author" content="Eamon">
    <meta property="og:url" content="https://zhangeamon.top/postgres/pgstattuple/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    
    
    <script type="text/javascript" src="/js/jquery.min.js"></script>
   
    
    
    
    
    
    
        <link rel="stylesheet" href='/css/douban.css'>
    
        <link rel="stylesheet" href='/css/other.css'>
    
   
        <a href=https://github.com/eamonzhang><img style="position: absolute; top: 0; left: 0; border: 0;" src="/images/forkme_left_red_aa0000.png" alt="Fork me on GitHub" data-canonical-src="/images/forkme_left_red_aa0000.png"></a>

   
        <script>
          var _hmt = _hmt || [];
            (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?1f6605a363a50554aa03adcc685b7699";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
          })();
       </script>
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://zhangeamon.top">
                        Let&#39;s go ğŸŒ ğŸŒ ğŸŒ
                    </a>
                
                <p class="description">Let&#39;s build our own cloud native together  </p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="" href="https://zhangeamon.top">é¦–é¡µ</a>
                    
                    <a  href="https://zhangeamon.top/archives" title="å½’æ¡£">å½’æ¡£</a>
                    
                    <a  href="https://zhangeamon.top/postgresql" title="Postgres">Postgres</a>
                    
                    <a  href="https://zhangeamon.top/linux" title="Linux">Linux</a>
                    
                    <a  href="https://zhangeamon.top/about/me" title="å…³äº">å…³äº</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    

    <article class="post">
        <header>
            <h1 class="post-title">è¡¨ç©ºé—´è†¨èƒ€</h1>
        </header>
        <date class="post-meta meta-date">
            2019å¹´5æœˆ22æ—¥
        </date>
        
        
        
        <div class="post-content">
            <h4 id="èƒŒæ™¯ä»‹ç»">èƒŒæ™¯ä»‹ç»</h4>
<p>ç”±äºmvccæœºåˆ¶ï¼Œæ•°æ®è¢«åˆ é™¤ååªæ˜¯è¢«æ ‡è®°ä¸ºåˆ é™¤ï¼Œå®é™…ç©ºé—´æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œè¿™æ˜¯è¡¨ç©ºé—´è†¨èƒ€çš„æ ¹æœ¬åŸå› ã€‚</p>
<p>ç›®å‰ç”¨äºè§£å†³è¡¨ç©ºé—´è†¨èƒ€æ–¹å¼æœ‰å¦‚ä¸‹æ–¹å¼</p>
<p>1 åˆ é™¤dead tuple</p>
<ul>
<li>vacuum  ,tupleè¢«æ¸…ç†ã€‚æ•°æ®åº“å¯ä»¥è‡ªåŠ¨æ‰§è¡Œautovacuum</li>
<li>vacuum full ,tupleè¢«æ¸…ç†å¹¶ä¸”ç©ºé—´è¿ç»­ç´§å‡‘ã€‚å¼Šç«¯ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šé”è¡¨ã€‚åº”ç”¨ä¸å¯ç”¨</li>
<li>ä¸ºäº†é¿å…é”è¡¨çš„å½±å“ï¼Œæä¾›çš„<a href="https://github.com/cybertec-postgresql/pg_squeeze">pg_squeeze</a>æ‹“å±•,ä½¿ç”¨é€»è¾‘å¤åˆ¶ã€‚<a href="https://www.timbotetsu.com/blog/postgresql-bloatbusters/">pg_repackæ‹“å±•</a>ï¼Œä½¿ç”¨äº†è§¦å‘å™¨ï¼Œå½±å“ä¸šåŠ¡çš„æ€§èƒ½ã€‚</li>
</ul>
<p>2 fillfactor</p>
<p>3 vacuum_defer_cleanup_age &gt; 0, æ˜¯ä»¥äº‹åŠ¡ä¸ºå•ä½ã€‚é…åˆpg_resetwal å¯ä»¥åšåˆ°flashback</p>
<pre><code>ä»£ä»·1ï¼Œä¸»åº“è†¨èƒ€ï¼Œå› ä¸ºåƒåœ¾ç‰ˆæœ¬è¦å»¶è¿Ÿè‹¥å¹²ä¸ªäº‹åŠ¡åæ‰èƒ½è¢«å›æ”¶ã€‚
ä»£ä»·2ï¼Œé‡å¤æ‰«æåƒåœ¾ç‰ˆæœ¬ï¼Œé‡å¤è€—è´¹åƒåœ¾å›æ”¶è¿›ç¨‹çš„CPUèµ„æºã€‚ï¼ˆn_dead_tupä¼šä¸€ç›´å¤„äºè¶…è¿‡åƒåœ¾å›æ”¶é˜ˆå€¼çš„çŠ¶æ€ï¼Œä»è€Œautovacuum ä¸æ–­å”¤é†’workerè¿›è¡Œå›æ”¶åŠ¨ä½œï¼‰ã€‚
å½“ä¸»åº“çš„ autovacuum_naptime=å¾ˆå°çš„å€¼ï¼ŒåŒæ—¶autovacuum_vacuum_scale_factor=å¾ˆå°çš„å€¼æ—¶ï¼Œå°¤ä¸ºæ˜æ˜¾ã€‚
ä»£ä»·3ï¼Œå¦‚æœæœŸé—´å‘ç”Ÿå¤§é‡åƒåœ¾ï¼Œåƒåœ¾ç‰ˆæœ¬å¯èƒ½ä¼šåœ¨äº‹åŠ¡åˆ°è¾¾å¹¶è§£ç¦åï¼Œçˆ†ç‚¸æ€§çš„è¢«å›æ”¶ï¼Œäº§ç”Ÿå¤§é‡çš„WALæ—¥å¿—ï¼Œä»è€Œé€ æˆWALçš„å†™IOå°–åˆºã€‚
</code></pre><p>4 reindex ä»æ–°å»ºç«‹ç´¢å¼•ï¼Œä¸è¦å¿½ç•¥è¡¨è†¨èƒ€ä¸­ç´¢å¼•çš„å½±å“ï¼Œé€šå¸¸æ¥è¯´ç´¢å¼•æ‰€å çš„ç©ºé—´å’Œç»´æŠ¤æˆæœ¬è¦é«˜äºæ•°æ®è¡¨ï¼Œåœ¨pg version 12ç‰ˆæœ¬ä¸­é¢„è®¡reindexæ—¶ä¸éœ€è¦é”è¡¨ã€‚</p>
<h6 id="å¤„ç†å®Œæ¯•åéœ€è¦é‡æ–°ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯">å¤„ç†å®Œæ¯•åéœ€è¦é‡æ–°ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯</h6>
<pre><code> ANALYZE;
</code></pre><p>åœ¨æ‰§è¡Œä»¥ä¸Šæ“ä½œæ—¶å»ºè®®è®¾ç½®</p>
<pre><code>set maintenance_work_mem = '10GB';
</code></pre><h4 id="ç›‘æ§è¡¨ç©ºé—´è†¨èƒ€">ç›‘æ§è¡¨ç©ºé—´è†¨èƒ€</h4>
<p>pgstattupleæä¾›äº†pgstatetuple()å’Œpgstatindex()ä¸¤ä¸ªç»Ÿè®¡è¡¨å’Œç´¢å¼•çš„æ–¹æ³•ï¼Œè¾ƒPostgreSQLç³»ç»Ÿè¡¨pg_classçš„è¡¨ç»Ÿè®¡ä¿¡æ¯ï¼Œpgstatetuple()è¿˜ç»Ÿè®¡äº†è¡¨ä¸­çš„dead tuplesã€‚</p>
<p><a href="https://www.postgresql.org/docs/current/pgstattuple.html">https://www.postgresql.org/docs/current/pgstattuple.html</a></p>
<p>åˆ›å»ºæ‹“å±•</p>
<pre><code>create extension pgstattuple ;
</code></pre><pre><code>è¡¨
test=&gt; SELECT * FROM pgstattuple('tablename');
-[ RECORD 1 ]------+-------
table_len          | 458752
tuple_count        | 1470
tuple_len          | 438896
tuple_percent      | 95.67
dead_tuple_count   | 11
dead_tuple_len     | 3157
dead_tuple_percent | 0.69
free_space         | 8932
free_percent       | 1.95

å­—æ®µè¯´æ˜

table_len	bigint	Physical relation length in bytes ç­‰ä»·äº pg_relation_size()
tuple_count	bigint	Number of live tuples 
tuple_len	bigint	Total length of live tuples in bytes
tuple_percent	float8	Percentage of live tuples
dead_tuple_count	bigint	Number of dead tuples
dead_tuple_len	bigint	Total length of dead tuples in bytes
dead_tuple_percent	float8	Percentage of dead tuples
free_space	bigint	Total free space in bytes
free_percent	float8	Percentage of free space
ä¸‰éƒ¨åˆ† live(å­˜æ´»tuple) dead(è¢«æ ‡è®°åˆ é™¤tuple) free(å‰©ä½™ç©ºé—´ åº”è¯¥æ˜¯dead tuple ,vacuum åè¢«é‡Šæ”¾çš„, filltor è®¾ç½®)

æ‰€ç”¨è¡¨
select tablename, (x).* from pg_tables ,LATERAL (select * from pgstattuple(tablename)) as X where schemaname = 'public' order by tuple_percent asc;

ç´¢å¼•

test=&gt; SELECT * FROM pgstatindex('index_name');
-[ RECORD 1 ]------+------
version            | 2
tree_level         | 0
index_size         | 16384
root_block_no      | 1
internal_pages     | 0
leaf_pages         | 1
empty_pages        | 0
deleted_pages      | 0
avg_leaf_density   | 54.27 (fillfator é»˜è®¤90 ï¼Œè¯¥å€¼æ¥è¿‘90æ¯”è¾ƒæ­£å¸¸)
leaf_fragmentation | 0

å­—æ®µè¯´æ˜
version	integer	B-tree version number
tree_level	integer	Tree level of the root page
index_size	bigint	Total index size in bytes
root_block_no	bigint	Location of root page (zero if none)
internal_pages	bigint	Number of â€œinternalâ€ (upper-level) pages
leaf_pages	bigint	Number of leaf pages
empty_pages	bigint	Number of empty pages
deleted_pages	bigint	Number of deleted pages
avg_leaf_density	float8	Average density of leaf pages
leaf_fragmentation	float8	Leaf page fragmentation

</code></pre><h4 id="ç®€å•ä½¿ç”¨">ç®€å•ä½¿ç”¨</h4>
<pre><code>--- ç”Ÿæˆæµ‹è¯•æ•°æ®

test=# create  table tb3(id integer,name character varying);
CREATE TABLE
test=# \d+ tb3 
                                  æ•°æ®è¡¨ &quot;public.tb3&quot;
 æ ä½ |       ç±»å‹        | Collation | Nullable | Default |   å­˜å‚¨   | ç»Ÿè®¡ç›®æ ‡ | æè¿° 
------+-------------------+-----------+----------+---------+----------+----------+------
 id   | integer           |           |          |         | plain    |          | 
 name | character varying |           |          |         | extended |          | 

test=#  alter table tb3 add primary key(id);
ALTER TABLE
test=# \d+ tb3 
                                  æ•°æ®è¡¨ &quot;public.tb3&quot;
 æ ä½ |       ç±»å‹        | Collation | Nullable | Default |   å­˜å‚¨   | ç»Ÿè®¡ç›®æ ‡ | æè¿° 
------+-------------------+-----------+----------+---------+----------+----------+------
 id   | integer           |           | not null |         | plain    |          | 
 name | character varying |           |          |         | extended |          | 
ç´¢å¼•ï¼š
    &quot;tb3_pkey&quot; PRIMARY KEY, btree (id)

test=# insert into tb3 select generate_series(1,1000000),md5(random()::text);
INSERT 0 1000000

--- åˆ›å»ºæ‹“å±•

test=# create extension pgstattuple ;
CREATE EXTENSION
test=# select * from pgstattuple('tb3');
-[ RECORD 1 ]------+---------
table_len          | 68272128
tuple_count        | 1000000
tuple_len          | 61000000
tuple_percent      | 89.35
dead_tuple_count   | 0
dead_tuple_len     | 0
dead_tuple_percent | 0
free_space         | 38776
free_percent       | 0.06

test=# select * from pgstatindex('tb3_pkey');
-[ RECORD 1 ]------+---------
version            | 2
tree_level         | 2
index_size         | 22487040
root_block_no      | 412
internal_pages     | 11
leaf_pages         | 2733
empty_pages        | 0
deleted_pages      | 0
avg_leaf_density   | 90.06
leaf_fragmentation | 0

test=# delete from tb3 where id%5=0;
DELETE 200000
test=# select * from pgstatindex('tb3_pkey');
-[ RECORD 1 ]------+---------
version            | 2
tree_level         | 2
index_size         | 22487040
root_block_no      | 412
internal_pages     | 11
leaf_pages         | 2733
empty_pages        | 0
deleted_pages      | 0
avg_leaf_density   | 90.06
leaf_fragmentation | 0

test=# select * from pgstattuple('tb3');
-[ RECORD 1 ]------+---------
table_len          | 68272128
tuple_count        | 800000
tuple_len          | 48800000
tuple_percent      | 71.48
dead_tuple_count   | 200000
dead_tuple_len     | 12200000
dead_tuple_percent | 17.87
free_space         | 38776
free_percent       | 0.06

test=#  vacuum tb3;
VACUUM
test=# select * from pgstattuple('tb3');
-[ RECORD 1 ]------+---------
table_len          | 68272128
tuple_count        | 800000
tuple_len          | 48800000
tuple_percent      | 71.48
dead_tuple_count   | 0
dead_tuple_len     | 0
dead_tuple_percent | 0
free_space         | 12838776
free_percent       | 18.81

test=# select * from pgstatindex('tb3_pkey');
-[ RECORD 1 ]------+---------
version            | 2
tree_level         | 2
index_size         | 22487040
root_block_no      | 412
internal_pages     | 11
leaf_pages         | 2733
empty_pages        | 0
deleted_pages      | 0
avg_leaf_density   | 72.11
leaf_fragmentation | 0

test=# select * from pgstattuple('tb3');
-[ RECORD 1 ]------+---------
table_len          | 68272128
tuple_count        | 800000
tuple_len          | 48800000
tuple_percent      | 71.48
dead_tuple_count   | 0
dead_tuple_len     | 0
dead_tuple_percent | 0
free_space         | 12838776
free_percent       | 18.81

test=# vacuum full tb3;
VACUUM
test=# select * from pgstattuple('tb3');
-[ RECORD 1 ]------+---------
table_len          | 54616064
tuple_count        | 800000
tuple_len          | 48800000
tuple_percent      | 89.35
dead_tuple_count   | 0
dead_tuple_len     | 0
dead_tuple_percent | 0
free_space         | 29388
free_percent       | 0.05


</code></pre><h5 id="æŸ¥çœ‹æ¯ä¸€é¡µçš„ç©ºé—´åˆ©ç”¨">æŸ¥çœ‹æ¯ä¸€é¡µçš„ç©ºé—´åˆ©ç”¨</h5>
<p>åˆ›å»ºæ‹“å±•</p>
<pre><code>create extension pg_freespacemap;

</code></pre><p>æŸ¥çœ‹æ²¡ä¸ªé¡µçš„ç©ºé—´åˆ©ç”¨</p>
<pre><code>select * from pg_freespace('tablename');
</code></pre><p>æŸ¥çœ‹è¡¨çš„ç©ºé—´åˆ©ç”¨</p>
<pre><code>select count(*) as &quot;number of pages&quot;, pg_size_pretty(cast(avg(avail) as bigint)) as &quot;freespace size &quot;, round(100* avg(avail)/8192,2) as &quot;freespace ratio&quot; 
from pg_freespace('tablename');
</code></pre><p><a href="https://mp.weixin.qq.com/s/g6j3WsBTGQipgEfrkzObRw">å®æˆ˜</a></p>
<h5 id="è¡¨ç©ºé—´æ•°æ®è†¨èƒ€çš„ç›‘æ§ä¸å¤„ç†">è¡¨ç©ºé—´æ•°æ®è†¨èƒ€çš„ç›‘æ§ä¸å¤„ç†</h5>
<p>åœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œç”±äºæ•°æ®é‡éå¸¸å¤§ï¼Œä¼ ç»Ÿæ–¹å¼ç»Ÿè®¡è¡¨ç©ºé—´çš„è†¨èƒ€ç‡éå¸¸è€—æ—¶è€—èµ„æºã€‚</p>
<p>ç»“åˆç»Ÿè®¡æƒ…å†µï¼Œåˆ©ç”¨pg_repackå¯ä¸åœæœå¤„ç†ã€‚å¤„ç†å‰æŸ¥çœ‹æ˜¯å¦æœ‰vacuumè¿›ç¨‹æ­£åœ¨æ‰§è¡Œï¼Œé¿å…å†²çªã€‚</p>
<pre><code>-- @auth Vonng

CREATE SCHEMA IF NOT EXISTS monitor;
CREATE EXTENSION IF NOT EXISTS pg_repack WITH SCHEMA monitor;

-- Table bloat estimate
CREATE OR REPLACE VIEW monitor.pg_table_bloat AS
    SELECT CURRENT_CATALOG AS datname, nspname, relname , bs * tblpages AS size,
           CASE WHEN tblpages - est_tblpages_ff &gt; 0 THEN (tblpages - est_tblpages_ff)/tblpages::FLOAT ELSE 0 END AS ratio
    FROM (
             SELECT ceil( reltuples / ( (bs-page_hdr)*fillfactor/(tpl_size*100) ) ) + ceil( toasttuples / 4 ) AS est_tblpages_ff,
                    tblpages, fillfactor, bs, tblid, nspname, relname, is_na
             FROM (
                      SELECT
                          ( 4 + tpl_hdr_size + tpl_data_size + (2 * ma)
                              - CASE WHEN tpl_hdr_size % ma = 0 THEN ma ELSE tpl_hdr_size % ma END
                              - CASE WHEN ceil(tpl_data_size)::INT % ma = 0 THEN ma ELSE ceil(tpl_data_size)::INT % ma END
                              ) AS tpl_size, (heappages + toastpages) AS tblpages, heappages,
                          toastpages, reltuples, toasttuples, bs, page_hdr, tblid, nspname, relname, fillfactor, is_na
                      FROM (
                               SELECT
                                   tbl.oid AS tblid, ns.nspname , tbl.relname, tbl.reltuples,
                                   tbl.relpages AS heappages, coalesce(toast.relpages, 0) AS toastpages,
                                   coalesce(toast.reltuples, 0) AS toasttuples,
                                   coalesce(substring(array_to_string(tbl.reloptions, ' ') FROM 'fillfactor=([0-9]+)')::smallint, 100) AS fillfactor,
                                   current_setting('block_size')::numeric AS bs,
                                   CASE WHEN version()~'mingw32' OR version()~'64-bit|x86_64|ppc64|ia64|amd64' THEN 8 ELSE 4 END AS ma,
                                   24 AS page_hdr,
                                   23 + CASE WHEN MAX(coalesce(s.null_frac,0)) &gt; 0 THEN ( 7 + count(s.attname) ) / 8 ELSE 0::int END
                                       + CASE WHEN bool_or(att.attname = 'oid' and att.attnum &lt; 0) THEN 4 ELSE 0 END AS tpl_hdr_size,
                                   sum( (1-coalesce(s.null_frac, 0)) * coalesce(s.avg_width, 0) ) AS tpl_data_size,
                                   bool_or(att.atttypid = 'pg_catalog.name'::regtype)
                                       OR sum(CASE WHEN att.attnum &gt; 0 THEN 1 ELSE 0 END) &lt;&gt; count(s.attname) AS is_na
                               FROM pg_attribute AS att
                                        JOIN pg_class AS tbl ON att.attrelid = tbl.oid
                                        JOIN pg_namespace AS ns ON ns.oid = tbl.relnamespace
                                        LEFT JOIN pg_stats AS s ON s.schemaname=ns.nspname AND s.tablename = tbl.relname AND s.inherited=false AND s.attname=att.attname
                                        LEFT JOIN pg_class AS toast ON tbl.reltoastrelid = toast.oid
                               WHERE NOT att.attisdropped AND tbl.relkind = 'r' AND nspname NOT IN ('pg_catalog','information_schema')
                               GROUP BY 1,2,3,4,5,6,7,8,9,10
                           ) AS s
                  ) AS s2
         ) AS s3
    WHERE NOT is_na;

-- Index bloat estimate
CREATE OR REPLACE VIEW monitor.pg_index_bloat AS
    SELECT CURRENT_CATALOG AS datname, nspname, idxname AS relname, relpages::BIGINT * bs AS size,
           COALESCE((relpages - ( reltuples * (6 + ma - (CASE WHEN index_tuple_hdr % ma = 0 THEN ma ELSE index_tuple_hdr % ma END)
                                                   + nulldatawidth + ma - (CASE WHEN nulldatawidth % ma = 0 THEN ma ELSE nulldatawidth % ma END))
                                      / (bs - pagehdr)::FLOAT  + 1 )), 0) / relpages::FLOAT AS ratio
    FROM (
             SELECT nspname,
                    idxname,
                    reltuples,
                    relpages,
                    current_setting('block_size')::INTEGER                                                               AS bs,
                    (CASE WHEN version() ~ 'mingw32' OR version() ~ '64-bit|x86_64|ppc64|ia64|amd64' THEN 8 ELSE 4 END)  AS ma,
                    24                                                                                                   AS pagehdr,
                    (CASE WHEN max(COALESCE(pg_stats.null_frac, 0)) = 0 THEN 2 ELSE 6 END)                               AS index_tuple_hdr,
                    sum((1.0 - COALESCE(pg_stats.null_frac, 0.0)) *
                        COALESCE(pg_stats.avg_width, 1024))::INTEGER                                                     AS nulldatawidth
             FROM pg_attribute
                      JOIN (
                 SELECT pg_namespace.nspname,
                        ic.relname                                                   AS idxname,
                        ic.reltuples,
                        ic.relpages,
                        pg_index.indrelid,
                        pg_index.indexrelid,
                        tc.relname                                                   AS tablename,
                        regexp_split_to_table(pg_index.indkey::TEXT, ' ') :: INTEGER AS attnum,
                        pg_index.indexrelid                                          AS index_oid
                 FROM pg_index
                          JOIN pg_class ic ON pg_index.indexrelid = ic.oid
                          JOIN pg_class tc ON pg_index.indrelid = tc.oid
                          JOIN pg_namespace ON pg_namespace.oid = ic.relnamespace
                          JOIN pg_am ON ic.relam = pg_am.oid
                 WHERE pg_am.amname = 'btree' AND ic.relpages &gt; 0 AND nspname NOT IN ('pg_catalog', 'information_schema')
             ) ind_atts ON pg_attribute.attrelid = ind_atts.indexrelid AND pg_attribute.attnum = ind_atts.attnum
                      JOIN pg_stats ON pg_stats.schemaname = ind_atts.nspname
                 AND ((pg_stats.tablename = ind_atts.tablename AND pg_stats.attname = pg_get_indexdef(pg_attribute.attrelid, pg_attribute.attnum, TRUE))
                     OR (pg_stats.tablename = ind_atts.idxname AND pg_stats.attname = pg_attribute.attname))
             WHERE pg_attribute.attnum &gt; 0
             GROUP BY 1, 2, 3, 4, 5, 6
         ) est
    LIMIT 512;

-- index bloat overview
CREATE OR REPLACE VIEW monitor.pg_table_bloat_human AS
    SELECT nspname || '.' || relname AS name,
           pg_size_pretty(size)      AS size,
           pg_size_pretty((size * ratio)::BIGINT) AS wasted,
           round(100 * ratio::NUMERIC, 2)  as ratio
    FROM monitor.pg_table_bloat ORDER BY wasted DESC NULLS LAST;
    
CREATE OR REPLACE VIEW monitor.pg_index_bloat_human AS
    SELECT nspname || '.' || relname              AS name,
           pg_size_pretty(size)                   AS size,
           pg_size_pretty((size * ratio)::BIGINT) AS wasted,
           round(100 * ratio::NUMERIC, 2)         as ratio
    FROM monitor.pg_index_bloat;
</code></pre><h5 id="ä¸»è¦åŸå› åˆ†æåŠç›‘æ§æªæ–½">ä¸»è¦åŸå› åˆ†æåŠç›‘æ§æªæ–½</h5>
<h6 id="é•¿äº‹åŠ¡">é•¿äº‹åŠ¡</h6>
<pre><code>-- è·¨äº‹åŠ¡
SELECT pid, datname, usename, state, backend_xmin
FROM pg_stat_activity
WHERE backend_xmin IS NOT NULL
ORDER BY age(backend_xmin) DESC;
</code></pre><pre><code>-- è·¨æ—¶é—´
select * from pg_stat_activity 
where state&lt;&gt;'idle' and pg_backend_pid()!=pid and (backend_xid is not null or backend_xmin is not null) and 
extract(epoch from(now()-xact_start))&gt;6 
order by xact_start;
</code></pre><h6 id="åºŸå¼ƒçš„å¤åˆ¶æ§½">åºŸå¼ƒçš„å¤åˆ¶æ§½</h6>
<pre><code>SELECT slot_name, slot_type, database, xmin
FROM pg_replication_slots
ORDER BY age(xmin) DESC;
</code></pre><h6 id="ä¸¤é˜¶æ®µæäº¤">ä¸¤é˜¶æ®µæäº¤</h6>
<pre><code>SELECT gid, prepared, owner, database, transaction AS xmin
FROM pg_prepared_xacts
ORDER BY age(transaction) DESC;
</code></pre>
        </div>

        


        

<div class="post-archive">
    <h2>å…¶ä»–æ–‡ç« </h2>
    <ul class="listing">
        
        <li><a href="/middleware/nginx/">nginx</a></li>
        
        <li><a href="/middleware/bind9/">DNS Bind9 &amp; NamedManager </a></li>
        
        <li><a href="/about/design/">å…³äºè®¾è®¡ã€åˆ’åˆ†</a></li>
        
    </ul>
</div>



        <div class="post-meta meta-tags">
            
            æ²¡æœ‰æ ‡ç­¾
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "your github repo"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2018 - 2021 <a href="https://zhangeamon.top"> By Eamon</a>
        
    </div>
    <br />
  
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>






    <script src='/js/douban.js'></script>


                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://zhangeamon.top/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://zhangeamon.top">
      <button type="submit" class="submit icon-search"></button>
</form>

    </section>
    
    <section class="widget">
        <h3 class="widget-title">æœ€è¿‘æ–‡ç« </h3>
<ul class="widget-list">
    
    <li>
        <a href="https://zhangeamon.top/redis/pubsub/" title="å‘å¸ƒè®¢é˜…">å‘å¸ƒè®¢é˜…</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/redis/distributedlock/" title="åŸºäºRedis çš„åˆ†å¸ƒå¼é”å®ç°">åŸºäºRedis çš„åˆ†å¸ƒå¼é”å®ç°</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/postgres/libpg/" title="å®¢æˆ·ç«¯æ•…éšœè½¬ç§»">å®¢æˆ·ç«¯æ•…éšœè½¬ç§»</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/postgres/prepare/" title="ä½¿ç”¨prepareé¢„ç¼–è¯‘SQL">ä½¿ç”¨prepareé¢„ç¼–è¯‘SQL</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/postgres/materialized/" title="ç‰©åŒ–è§†å›¾">ç‰©åŒ–è§†å›¾</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/python/requests/" title="Requests">Requests</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/asr/c/" title="C è¯­è¨€ç¯å¢ƒ">C è¯­è¨€ç¯å¢ƒ</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/linux/lightdm/" title="å…³äºUbuntu20.04ä¸‹å‘æ—¥è‘µè¿œç¨‹è½¯ä»¶è¿æ¥ä¸­æ–­çš„è§£å†³æ–¹æ³•">å…³äºUbuntu20.04ä¸‹å‘æ—¥è‘µè¿œç¨‹è½¯ä»¶è¿æ¥ä¸­æ–­çš„è§£å†³æ–¹æ³•</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/linux/so/" title="åŠ¨æ€åº“">åŠ¨æ€åº“</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/python/ctypes/" title="python ä¸ C äº¤äº’ç¼–ç¨‹">python ä¸ C äº¤äº’ç¼–ç¨‹</a>
    </li>
    
</ul>

    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories'>åˆ†ç±»</a></h3>
<ul class="widget-list">
    
    <li><a href="https://zhangeamon.top/categories/ansible/">ansible (4)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/etcd/">etcd (1)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/linux/">linux (12)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/mysql/">mysql (1)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/postgres/">postgres (19)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/python/">python (13)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/rabbitmq/">rabbitmq (2)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/redis/">redis (7)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">ä¸­é—´ä»¶ (10)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E6%95%B0%E4%BB%93/">æ•°ä»“ (3)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E7%9B%91%E6%8E%A7/">ç›‘æ§ (2)</a></li>
    
</ul>

    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags.html'>æ ‡ç­¾</a></h3>
<div class="tagcloud">
    
    <a href="https://zhangeamon.top/tags/%E4%BC%98%E5%8C%96/">ä¼˜åŒ–</a>
    
    <a href="https://zhangeamon.top/tags/%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/">é…ç½®ç®¡ç†</a>
    
    <a href="https://zhangeamon.top/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/">é«˜å¯ç”¨</a>
    
</div>

    </section>

    
<section class="widget">
    <h3 class="widget-title">å‹æƒ…é“¾æ¥</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="http://www.cnblogs.com/zhangeamon" title="å†å²åšå®¢">å†å²åšå®¢</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">å…¶å®ƒ</h3>
        <ul class="widget-list">
            <li><a href="https://zhangeamon.top/index.xml">æ–‡ç«  RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
   
</body>

</html>
