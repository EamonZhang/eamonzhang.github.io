<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <title>repmgrdä»‹ç» | Let&#39;s go ğŸŒ ğŸŒ ğŸŒ</title>
    <meta property="og:title" content="repmgrdä»‹ç» - Let&#39;s go ğŸŒ ğŸŒ ğŸŒ">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2023-03-24T16:20:16&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2023-03-24T16:20:16&#43;08:00'>
        
    <meta name="Keywords" content="postgres ã€pythonã€pg ã€linix ã€dockerã€ kubernetesã€ cloudã€hadoopã€promethues ">
    <meta name="description" content="repmgrdä»‹ç»">
        
    <meta name="author" content="Eamon">
    <meta property="og:url" content="https://zhangeamon.top/postgres/repmgrd/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    
    
    <script type="text/javascript" src="/js/jquery.min.js"></script>
   
    
    
    
    
    
    
        <link rel="stylesheet" href='/css/douban.css'>
    
        <link rel="stylesheet" href='/css/other.css'>
    
   
        <a href=https://github.com/eamonzhang><img style="position: absolute; top: 0; left: 0; border: 0;" src="/images/forkme_left_red_aa0000.png" alt="Fork me on GitHub" data-canonical-src="/images/forkme_left_red_aa0000.png"></a>

   
        <script>
          var _hmt = _hmt || [];
            (function() {
            var hm = document.createElement("script");
            <!-- hm.src = "https://hm.baidu.com/hm.js?1f6605a363a50554aa03adcc685b7699"; -->
            hm.src = "https://hm.baidu.com/hm.js?0010600e9ae6ff8f5814bb7ec6b36072";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
          })();
       </script>
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://zhangeamon.top">
                        Let&#39;s go ğŸŒ ğŸŒ ğŸŒ
                    </a>
                
                <p class="description">Let&#39;s build our own cloud native together  </p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="" href="https://zhangeamon.top">é¦–é¡µ</a>
                    
                    <a  href="https://zhangeamon.top/archives" title="å½’æ¡£">å½’æ¡£</a>
                    
                    <a  href="https://zhangeamon.top/postgresql" title="Postgres">Postgres</a>
                    
                    <a  href="https://zhangeamon.top/linux" title="Linux">Linux</a>
                    
                    <a  href="https://zhangeamon.top/about/me" title="å…³äº">å…³äº</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    <style type="text/css">
    .post-toc {
        position: fixed;
        width: 200px;
        margin-left: -210px;
        padding: 5px 10px;
        font-family: Athelas, STHeiti, Microsoft Yahei, serif;
        font-size: 12px;
        border: 1px solid rgba(0, 0, 0, .07);
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.98);
        background-clip: padding-box;
        -webkit-box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        word-wrap: break-word;
        white-space: nowrap;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        z-index: 999;
        cursor: pointer;
        max-height: 70%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .post-toc .post-toc-title {
        width: 100%;
        margin: 0 auto;
        font-size: 20px;
        font-weight: 400;
        text-transform: uppercase;
        text-align: center;
    }

    .post-toc .post-toc-content {
        font-size: 15px;
    }

    .post-toc .post-toc-content>nav>ul {
        margin: 10px 0;
    }

    .post-toc .post-toc-content ul {
        padding-left: 20px;
        list-style: square;
        margin: 0.5em;
        line-height: 1.8em;
    }

    .post-toc .post-toc-content ul ul {
        padding-left: 15px;
        display: none;
    }

    @media print,
    screen and (max-width:1057px) {
        .post-toc {
            display: none;
        }
    }
</style>
<div class="post-toc" style="position: absolute; top: 188px;">
    <h2 class="post-toc-title">ç›®å½•</h2>
    <div class="post-toc-content">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#repmgrdä»‹ç»">repmgrdä»‹ç»</a></li>
    <li><a href="#repmgrd-æ•…éšœè½¬ç§»">repmgrd æ•…éšœè½¬ç§»</a>
      <ul>
        <li><a href="#è§è¯èŠ‚ç‚¹ä»‹ç»">è§è¯èŠ‚ç‚¹ä»‹ç»</a></li>
        <li><a href="#æ·»åŠ è§è¯èŠ‚ç‚¹">æ·»åŠ è§è¯èŠ‚ç‚¹</a></li>
        <li><a href="#è§£å†³è„‘è£‚é—®é¢˜">è§£å†³è„‘è£‚é—®é¢˜</a></li>
        <li><a href="#ä¸»æœåŠ¡å¯è§æ€§å…±è¯†">ä¸»æœåŠ¡å¯è§æ€§å…±è¯†</a></li>
        <li><a href="#ä»èŠ‚ç‚¹æ–­å¼€è¿æ¥">ä»èŠ‚ç‚¹æ–­å¼€è¿æ¥</a></li>
        <li><a href="#æ•…éšœè½¬ç§»éªŒè¯">æ•…éšœè½¬ç§»éªŒè¯</a></li>
        <li><a href="#çº§è”å¤åˆ¶">çº§è”å¤åˆ¶</a></li>
        <li><a href="#ä¸»èŠ‚ç‚¹æ£€æµ‹ä»åº“è¿æ¥">ä¸»èŠ‚ç‚¹æ£€æµ‹ä»åº“è¿æ¥</a></li>
        <li><a href="#æ£€æµ‹è¿‡ç¨‹å’Œæ ‡å‡†">æ£€æµ‹è¿‡ç¨‹å’Œæ ‡å‡†</a></li>
        <li><a href="#æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹</a></li>
        <li><a href="#é…ç½®å‚æ•°">é…ç½®å‚æ•°</a></li>
        <li><a href="#äº‹ä»¶ç±»å‹">äº‹ä»¶ç±»å‹</a></li>
        <li><a href="#æŸ¥çœ‹äº‹ä»¶">æŸ¥çœ‹äº‹ä»¶</a></li>
      </ul>
    </li>
    <li><a href="#repmgrd-é…ç½®">repmgrd é…ç½®</a>
      <ul>
        <li><a href="#å¿…é¡»è®¾ç½®çš„å‚æ•°">å¿…é¡»è®¾ç½®çš„å‚æ•°</a></li>
        <li><a href="#å¯é€‰å‚æ•°">å¯é€‰å‚æ•°</a></li>
        <li><a href="#å…¶ä»–å‚æ•°">å…¶ä»–å‚æ•°</a></li>
        <li><a href="#æ—¥å¿—è‡ªåŠ¨åˆ‡å‰²">æ—¥å¿—è‡ªåŠ¨åˆ‡å‰²</a></li>
      </ul>
    </li>
    <li><a href="#repmgrd-æ“ä½œ">repmgrd æ“ä½œ</a>
      <ul>
        <li><a href="#repmgrd-ç»´æŠ¤æ¨¡å¼">repmgrd ç»´æŠ¤æ¨¡å¼</a></li>
        <li><a href="#é™çº§æ¨¡å¼">é™çº§æ¨¡å¼</a></li>
        <li><a href="#ç›‘æ§æ•°æ®å­˜å‚¨">ç›‘æ§æ•°æ®å­˜å‚¨</a></li>
      </ul>
    </li>
    <li><a href="#é€‰ä¸¾æµç¨‹ç®€ä»‹">é€‰ä¸¾æµç¨‹ç®€ä»‹</a>
      <ul>
        <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
      </ul>
    </li>
    <li><a href="#æµç¨‹å›¾">æµç¨‹å›¾</a></li>
    <li><a href="#åŠŸèƒ½å¢å¼º">åŠŸèƒ½å¢å¼º</a>
      <ul>
        <li><a href="#virtual-ip"><strong>Virtual IP</strong></a></li>
        <li><a href="#ä¸»èŠ‚ç‚¹å¼‚å¸¸åæ¢å¤å¤„ç†">ä¸»èŠ‚ç‚¹å¼‚å¸¸åæ¢å¤å¤„ç†</a></li>
        <li><a href="#ä»èŠ‚ç‚¹æ•…éšœåŠæ¢å¤">ä»èŠ‚ç‚¹æ•…éšœåŠæ¢å¤</a></li>
        <li><a href="#å¯¹å¤–æœåŠ¡ç®¡ç†">å¯¹å¤–æœåŠ¡ç®¡ç†</a></li>
      </ul>
    </li>
    <li><a href="#æ•…éšœåˆ‡æ¢æ—¶é—´é¢„ä¼°">æ•…éšœåˆ‡æ¢æ—¶é—´é¢„ä¼°</a></li>
    <li><a href="#åªæœ‰ä¸¤ä¸ªèŠ‚ç‚¹">åªæœ‰ä¸¤ä¸ªèŠ‚ç‚¹</a></li>
  </ul>
</nav>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var postToc = $(".post-toc");
        if (postToc.length) {
            var leftPos = $("#main").offset().left;
            if(leftPos<220){
                postToc.css({"width":leftPos-10,"margin-left":(0-leftPos)})
            }

            var t = postToc.offset().top - 20,
                a = {
                    start: {
                        position: "absolute",
                        top: t
                    },
                    process: {
                        position: "fixed",
                        top: 20
                    },
                };
            $(window).scroll(function () {
                var e = $(window).scrollTop();
                e < t ? postToc.css(a.start) : postToc.css(a.process)
            })
        }
    })
</script>

    <article class="post">
        <header>
            <h1 class="post-title">repmgrdä»‹ç»</h1>
        </header>
        <date class="post-meta meta-date">
            2023å¹´3æœˆ24æ—¥
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='/categories/postgres'>postgres</a></span>
            
        </div>
        
        
        
        <div class="clear" style="display: none">
            <div class="toc-article">
                <div class="toc-title">æ–‡ç« ç›®å½•</div>
            </div>
        </div>
        
        <div class="post-content">
            <h2 id="repmgrdä»‹ç»">repmgrdä»‹ç»</h2>
<p>repmgrd ä½œä¸ºè¿è¡Œåœ¨é›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„ä¸€ä¸ªç®¡ç†å’Œç›‘æ§çš„å®ˆæŠ¤ç¨‹åºï¼Œå¯ä»¥è‡ªåŠ¨è¿›è¡Œæ•…éšœè½¬ç§»å’Œç»´æŠ¤å¤åˆ¶å…³ç³»ï¼Œå¹¶æä¾›æœ‰å…³æ¯ä¸ªèŠ‚ç‚¹çŠ¶æ€çš„ç›‘æ§ä¿¡æ¯ã€‚</p>
<p>repmgrd ä¸ä¾èµ–å…¶ä»–æœåŠ¡</p>
<p>æä¾›çš„åŠŸèƒ½åŒ…æ‹¬:</p>
<ul>
<li>ä¼—å¤šçš„é…ç½®é¡¹æä¾›é€‰æ‹©</li>
<li>æ ¹æ®åœºæ™¯å¯è‡ªå®šä¹‰å¯¹åº”æ‰§è¡Œè„šæœ¬</li>
<li>ä¸€ä¸ªå‘½ä»¤è¿›å…¥ç»´æŠ¤æ¨¡å¼</li>
<li>å¤šæ•°æ®ä¸­å¿ƒåœºæ™¯ï¼Œé€šè¿‡locationé™åˆ¶å€™é€‰ä¸»èŠ‚ç‚¹</li>
<li>å¤šç§éªŒè¯Postgresqlå­˜æ´»çŠ¶æ€æ–¹æ³•ï¼ˆPostgreSQL ping, query execution or new connectionï¼‰</li>
<li>ä¿ç•™ç›‘æ§æ•°æ®ï¼ˆå¯é€‰ï¼‰</li>
</ul>
<h2 id="repmgrd-æ•…éšœè½¬ç§»">repmgrd æ•…éšœè½¬ç§»</h2>
<h3 id="è§è¯èŠ‚ç‚¹ä»‹ç»">è§è¯èŠ‚ç‚¹ä»‹ç»</h3>
<p>æ˜¯ä¸€ä¸ªç‹¬ç«‹äºå½“å‰ä¸»ä»å¤åˆ¶æ•°æ®åº“çš„Postgresqlæ•°æ®åº“ã€‚</p>
<p>ç›®çš„æ˜¯å½“å‘ç”Ÿfailoveråœºæ™¯æ—¶ï¼Œç”¨æ¥è¯æ˜ä¸»æœåŠ¡è‡ªèº«ä¸å¯ç”¨è¿˜æ˜¯æ•°æ®ä¸­å¿ƒç½‘ç»œé—®é¢˜</p>
<p>ä¸€ä¸ªå…¸å‹çš„åœºæ™¯</p>
<p>ä½äºä¸¤ä¸ªæ•°æ®ä¸­å¿ƒçš„ä¸»ä»å¤åˆ¶ç»“æ„ã€‚å’Œä¸»æœåŠ¡åŒä¸€ä¸ªæ•°æ®ä¸­å¿ƒä¸Šåˆ›å»ºä¸€ä¸ªè§è¯æœåŠ¡ã€‚å½“ä¸»æœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œä»èŠ‚ç‚¹åˆ¤æ–­é€»è¾‘ï¼Œå¦‚æœä¸»æœåŠ¡å’Œè§è¯èŠ‚ç‚¹éƒ½ä¸å¯è§åˆ™è®¤ä¸ºæ˜¯ç½‘ç»œé—®é¢˜ã€‚å¦‚æœä¸»æœåŠ¡ä¸å¯è§ï¼Œè§è¯èŠ‚ç‚¹å¯è§åˆ™è®¤ä¸ºæ˜¯ä¸»æœåŠ¡å‘ç”Ÿé—®é¢˜ã€‚</p>
<p>æ³¨æ„äº‹é¡¹:</p>
<p>ä¸è¦å°†è§è¯èŠ‚ç‚¹ä¸ä¸»ä»æœåŠ¡å®‰è£…åœ¨åŒä¸€ä¸ªç‰©ç†æœºä¸Šã€‚</p>
<p>å¤šæ•°æ®ä¸­å¿ƒåœºæ™¯å»ºè®®ä½¿ç”¨localitonæ¥é¢„é˜²è„‘è£‚é—®é¢˜</p>
<p>è§è¯èŠ‚ç‚¹åªåœ¨repmgrdå¯ç”¨æ—¶æœ‰æ•ˆã€‚</p>
<h3 id="æ·»åŠ è§è¯èŠ‚ç‚¹">æ·»åŠ è§è¯èŠ‚ç‚¹</h3>
<p>å®‰è£…ä¸€ä¸ªç‹¬ç«‹çš„Postgresqlå®ä¾‹ï¼Œé…ç½®å‚è€ƒæ™®é€šçš„repmgrã€‚</p>
<p>æ³¨å†Œè§è¯èŠ‚ç‚¹</p>
<pre><code>repmgr -f /etc/repmgr.conf witness register -h node1
</code></pre><p>æ€è€ƒ: è§è¯èŠ‚ç‚¹æ˜¯å¦éœ€è¦è¿è¡Œrepmgrdã€‚ è§è¯èŠ‚ç‚¹ä¸åŒäºå…¶ä»–ä»èŠ‚ç‚¹ï¼Œå…ƒæ•°æ®å¯ä»¥é€šè¿‡æµå¤åˆ¶ç›´æ¥è·å–åˆ°ã€‚éœ€è¦repmgrdæ¥ç»´æŠ¤ã€‚</p>
<h3 id="è§£å†³è„‘è£‚é—®é¢˜">è§£å†³è„‘è£‚é—®é¢˜</h3>
<p>å¤šæ•°æ®ä¸­å¿ƒå¸¦æ¥çš„è„‘è£‚é—®é¢˜ï¼Œå½“ä¸åŒæ•°æ®ä¸­å¿ƒçš„èŠ‚ç‚¹å½¼æ­¤ä¸å¯è§æ—¶ï¼Œä»åº“çš„æœåŠ¡å‘ç”Ÿfailover äº§ç”Ÿä¸€ä¸ªæ–°çš„ä¸»èŠ‚ç‚¹ã€‚æ­¤æ—¶æ•´ä¸ªé›†ç¾¤åŒæ—¶æ‹¥æœ‰ä¸¤ä¸ªä¸»æœåŠ¡ã€‚</p>
<p>è™½ç„¶è§è¯æœåŠ¡å¯ä»¥åœ¨ä»²è£ã€‚ä½†æ˜¯è§è¯æœåŠ¡å­˜åœ¨å¦‚ä¸‹å¼Šç«¯ã€‚</p>
<ul>
<li>éœ€è¦ä¿è¯è§è¯èŠ‚ç‚¹ä¸ä¸»æœåŠ¡èŠ‚ç‚¹ä½äºåŒä¸€ä¸ªæ•°æ®ä¸­å¿ƒã€‚</li>
<li>å½“é›†ç¾¤ä¸­å¤šæ•°èŠ‚ç‚¹ä¸ä¸»æœåŠ¡èŠ‚ç‚¹ä¸åœ¨åŒä¸€ä¸ªæ•°æ®ä¸­å¿ƒæ—¶ï¼Œå¢åŠ é¢å¤–çš„ç»´æŠ¤æˆæœ¬ï¼Œä¸”ä¸ä¾¿æ‰©å±•ï¼Œå°¤å…¶æ˜¯å¤§è§„æ¨¡åº”ç”¨æ—¶ã€‚</li>
</ul>
<p>repmgr4 æå‡ºlocationçš„æ¦‚å¿µï¼Œé€šè¿‡é…ç½®locationæ¥æŒ‡å®šèŠ‚ç‚¹çš„ç‰©ç†ä½ç½®ã€‚</p>
<p>å½“å‘ç”Ÿfailoveræ—¶ã€‚repmgré¦–å…ˆæ£€æµ‹æ˜¯å¦å­˜åœ¨ä¸ä¸»æœåŠ¡ä½äºåŒä¸€ä¸ªlocaltionçš„æœåŠ¡æ˜¯å¯è§çš„ã€‚å¦‚æœä¸å­˜ï¼ˆå³æ•´ä¸ªä¸ä¸»æœåŠ¡ä½äºåŒä¸€ä¸ªæ•°æ®ä¸­å¿ƒçš„èŠ‚ç‚¹éƒ½ä¸å¯è§ï¼‰åœ¨åˆ™è®¤ä¸ºæ˜¯ç½‘ç»œé—®é¢˜ã€‚ä¸æå‡æ–°ä¸»åº“ï¼Œå¹¶ä¸”è¿›å…¥é™çº§æ¨¡å¼ã€‚</p>
<h3 id="ä¸»æœåŠ¡å¯è§æ€§å…±è¯†">ä¸»æœåŠ¡å¯è§æ€§å…±è¯†</h3>
<p>æ›´å¤æ‚çš„é›†ç¾¤ç»“æ„ï¼Œå½“ä»èŠ‚ç‚¹æœåŠ¡è¿æ¥ä¸åˆ°ä¸»æœåŠ¡æ—¶ï¼Œè¯¢é—®å…¶ä»–ä»æœåŠ¡æœ€åä¸€æ¬¡çœ‹åˆ°ä¸»æœåŠ¡çš„æ—¶é—´ã€‚å½“å­˜åœ¨èŠ‚ç‚¹å¯ä»¥è¿æ¥åˆ°ä¸»æœåŠ¡åˆ™è¯æ˜ä¸»æœåŠ¡è¿˜å­˜æ´»ï¼Œå¹¶ä¸”å¯ä»¥æ­£å¸¸æä¾›å†™æœåŠ¡ã€‚æ­¤æ—¶ä¸å‘ç”Ÿæ–°çš„é€‰ä¸¾ã€‚</p>
<p>é…ç½®å‚æ•°</p>
<pre><code> primary_visibility_consensus=true
</code></pre><p>æ³¨æ„äº‹é¡¹ã€‚å¿…é¡»æ¯ä¸ªæœåŠ¡éƒ½è®¾ç½®ä¸ºtrueæ‰ç”Ÿæ•ˆ</p>
<h3 id="ä»èŠ‚ç‚¹æ–­å¼€è¿æ¥">ä»èŠ‚ç‚¹æ–­å¼€è¿æ¥</h3>
<p>å½“standby_disconnect_on_failoverè®¾ç½®ä¸ºtrueæ—¶ï¼Œåœ¨å‘ç”Ÿæ•…éšœè½¬ç§»æ—¶é¦–å…ˆä»èŠ‚ç‚¹æ–­å¼€æœ¬åœ°çš„wal receiver,å¹¶ä¸”ç­‰å¾…æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹æ–­å¼€è‡ªå·±çš„wal receiverã€‚</p>
<p>è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºç¡®ä¿åœ¨æ•…éšœè½¬ç§»æ—¶ï¼Œæ‰€æœ‰çš„èŠ‚ç‚¹lsnå¤„äºé™æ­¢çŠ¶æ€ã€‚</p>
<p>é‡è¦æç¤º:</p>
<ul>
<li>
<p>Postgresql9.5 åŠä»¥ä¸Šï¼Œrepmgr çš„æ•°æ®åº“ç”¨æˆ·å…·æœ‰è¶…çº§ç”¨æˆ·æƒé™</p>
</li>
<li>
<p><code>standby_disconnect_on_failover</code> å¿…é¡»è¦æ‰€æœ‰èŠ‚ç‚¹æœåŠ¡éƒ½è®¾ç½®æ‰ç”Ÿæ•ˆ</p>
</li>
<li>
<p>æ³¨æ„è®¾ç½®æ­¤å‚æ•°åå°†å¸¦æ¥çš„å»¶è¿Ÿï¼ŒåŒ…æ‹¬ç¡®å®šè‡ªå·±wal receiveræ˜¯å¦å·²ç»å…³é—­ã€‚ç­‰ä»–ç¡®è®¤å…¶ä»–èŠ‚ç‚¹wal receiver æ˜¯å¦å·²ç»å®Œå…¨å…³é—­</p>
</li>
<li>
<p>å¼€å¯æ­¤å‚æ•°å»ºè®®åŒæ—¶å¼€å¯   <code>primary_visibility_consensus</code></p>
</li>
</ul>
<h3 id="æ•…éšœè½¬ç§»éªŒè¯">æ•…éšœè½¬ç§»éªŒè¯</h3>
<p>åœ¨å‘ç”Ÿæ•…éšœè½¬ç§»æ—¶ï¼ŒæŸä¸ªèŠ‚ç‚¹è¢«é€‰ä¸¾ä¸ºæ–°çš„ä¸»èŠ‚ç‚¹æ—¶ï¼Œå¯ä»¥é€šè¿‡é…ç½®è‡ªå®šä¹‰åˆ¤æ–­è„šæœ¬ï¼Œè¿›ä¸€æ­¥å†³å®šå½“å‰æ˜¯å¦å¯ä»¥è¢«æå‡ä¸ºä¸»èŠ‚ç‚¹ï¼ˆç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰è¾…åŠ©é€»è¾‘ï¼‰ã€‚  å¿…é¡»åœ¨æ‰€æœ‰èŠ‚ç‚¹è¿›è¡Œé…ç½®ã€‚</p>
<p>é…ç½®å¦‚ä¸‹ï¼š</p>
<pre><code>failover_validation_command=/path/to/script.sh %n     
</code></pre><p>å¯ä½¿ç”¨å‚æ•°ï¼š</p>
<ul>
<li><code>%n</code>: node ID</li>
<li><code>%a</code>: node name</li>
<li><code>%v</code>: å¯è§èŠ‚ç‚¹æ•°</li>
<li><code>%u</code>: number of shared upstream nodes</li>
<li><code>%t</code>: æ€»èŠ‚ç‚¹æ•°</li>
</ul>
<p>æ ¹æ®è„šæœ¬è¿”å›ç ï¼ˆæ˜¯å¦é0ï¼‰å†³å®šæ˜¯å¦å¯ä»¥å°†å½“å‰èŠ‚ç‚¹æå‡ä¸ºä¸»èŠ‚ç‚¹ï¼Œå¦‚æœä¸ç¬¦åˆæ¡ä»¶ï¼Œä¸­æ–­æœ¬æ¬¡æ•…éšœè½¬ç§»æµç¨‹ï¼Œ<code>election_rerun_interval</code> ç§’åè¿›å…¥ä¸‹ä¸€è½®æ•…éšœè½¬ç§»æµç¨‹ã€‚</p>
<h3 id="çº§è”å¤åˆ¶">çº§è”å¤åˆ¶</h3>
<p>Postgresql 9.2 æ•°æ®åº“å…·æœ‰äº†çº§è”å¤åˆ¶åŠŸèƒ½ã€‚repmgr å¯ä»¥æä¾›çº§è”å¤åˆ¶æ”¯æŒã€‚</p>
<p>å½“å‘ç”Ÿæ•…éšœè½¬ç§»æ—¶ï¼Œrepmgrä¿æŒçº§è”å…³ç³»ä¸å˜ã€‚</p>
<p>åœ¨ä¸Šæ¸¸èŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ä¸‹æ¸¸èŠ‚ç‚¹è‡ªåŠ¨é‡æ–°å°è¯•è¿æ¥åŸä¸Šæ¸¸èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ã€‚</p>
<h3 id="ä¸»èŠ‚ç‚¹æ£€æµ‹ä»åº“è¿æ¥">ä¸»èŠ‚ç‚¹æ£€æµ‹ä»åº“è¿æ¥</h3>
<p>ä»¥ä¸Šçš„è€ƒè™‘æƒ…å½¢å¤§å¤šæ˜¯é€šè¿‡ä»èŠ‚ç‚¹æ£€æµ‹ä¸»èŠ‚ç‚¹çš„è¿è¡Œæƒ…å†µæ¥å†³å®šæ˜¯å¦å‘ç”Ÿæ•…éšœè½¬ç§»ã€‚åœ¨repmgrä¸­ä¸»èŠ‚ç‚¹ä¹Ÿå¯ä»¥æ£€æµ‹åˆ°ä»èŠ‚ç‚¹çš„è¿æ¥æƒ…å†µã€‚</p>
<p>é€šè¿‡ä¸»æœºç‚¹ä¸æ–­çš„æ£€æµ‹ä»èŠ‚ç‚¹çš„è¿æ¥æƒ…å†µï¼Œå½“æ»¡è¶³æŸäº›çŠ¶å†µæ—¶å¯ä»¥æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ã€‚å¦‚å‘ç”Ÿæ•…éšœè½¬ç§»åäº§ç”Ÿä¸€ä¸ªæ–°çš„ä¸»æœåŠ¡æ—¶ï¼Œå…¶ä»–çš„ä»èŠ‚ç‚¹ä¹Ÿéƒ½è·Ÿç€æŒ‡å‘äº†æ–°ä¸»èŠ‚ç‚¹ï¼ŒåŸä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ä¸ªæ•°å˜ä¸ºé›¶ã€‚è¿™æ—¶å¯ä»¥é€šè¿‡æ‰§è¡Œä¸€ä¸ªç‰¹æ®Šçš„å‘½ä»¤æ¥é˜»æ­¢åº”ç”¨å†™å…¥åŸä¸»èŠ‚ç‚¹ã€‚</p>
<h3 id="æ£€æµ‹è¿‡ç¨‹å’Œæ ‡å‡†">æ£€æµ‹è¿‡ç¨‹å’Œæ ‡å‡†</h3>
<ul>
<li>é—´éš”æ—¶é—´<code>child_nodes_check_interval</code> é»˜è®¤5ç§’æŸ¥è¯¢ä¸€æ¬¡pg_stat_replication è§†å›¾ï¼Œå¹¶ä¸æ³¨å†Œrepmgræ—¶æŒ‡å®šupstream nodeä¸ºä¸»åŠèŠ‚ç‚¹çš„åˆ—è¡¨è¿›è¡Œå¯¹æ¯”</li>
<li>å¦‚æœæ£€æµ‹åˆ°ä»èŠ‚ç‚¹ä¸åœ¨pg_stat_replication è§†å›¾ä¸­ã€‚è®°å½•æ£€æµ‹åˆ°çš„æ—¶é—´å¹¶è§¦å‘   <code>child_node_disconnect</code> äº‹ä»¶</li>
<li>å¦‚æœä»èŠ‚ç‚¹é‡æ–°å‡ºç°åœ¨pg_stat_repliationè§†å›¾ä¸­ï¼Œæ¸…é™¤ä¸Šé¢çš„æ£€æµ‹æ—¶é—´è®°å½•ï¼Œå¹¶è§¦å‘  <code>child_node_reconnect</code>äº‹ä»¶</li>
<li>å¦‚æœæ£€æµ‹åˆ°ä¸€ä¸ªæ–°çš„ä»èŠ‚ç‚¹åŠ å…¥ï¼Œå°†æ–°èŠ‚ç‚¹åŠ å…¥åˆ°å†…éƒ¨åˆ—è¡¨ä¸­å¹¶è§¦å‘<code>child_node_new_connect</code> äº‹ä»¶</li>
<li>å¦‚æœåœ¨repmgr.confä¸­é…ç½®äº†å‚æ•°<code>child_nodes_disconnect_command</code>ï¼Œrepmgrdä¼šå¾ªç¯æ£€æµ‹æ‰€æœ‰èŠ‚ç‚¹ï¼Œå¦‚æœæ£€æµ‹åˆ°è¿æ¥çš„ä»èŠ‚ç‚¹æ•°å°äº<code>child_nodes_connected_min_count</code> ï¼ˆé»˜è®¤é›¶ï¼‰å¹¶ä¸”è¶…è¿‡<code>child_nodes_disconnect_timeout</code>ï¼ˆé»˜è®¤30sï¼‰æ‰€æŒ‡å®šçš„æ—¶é—´æ—¶ï¼Œè§¦å‘          <code>child_nodes_disconnect_command</code> äº‹ä»¶</li>
<li>æ³¨æ„äº‹é¡¹ï¼Œåœ¨ repmgrd å¯åŠ¨æ—¶æ²¡æœ‰è¿æ¥çš„å­èŠ‚ç‚¹ä¸ä¼šè¢«è®¤ä¸ºæ˜¯ä¸¢å¤±çš„ï¼Œå› ä¸º repmgrd æ— æ³•çŸ¥é“å®ƒä»¬ä¸ºä»€ä¹ˆæ²¡æœ‰è¢«è¿æ¥ã€‚</li>
</ul>
<h3 id="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹</h3>
<ul>
<li>
<p>å­èŠ‚ç‚¹é…ç½®ä¸ºå½’æ¡£å¤åˆ¶æ—¶</p>
</li>
<li>
<p>å­èŠ‚ç‚¹çš„primary_conninfoä¿¡æ¯ä¸­çš„application_nameä¸èŠ‚ç‚¹çš„ repmgr.confæ–‡ä»¶ä¸­å®šä¹‰çš„èŠ‚ç‚¹åç§°ç›¸åŒã€‚æ­¤å¤–ï¼Œè¿™ä¸ªapplication_nameåœ¨æ•´ä¸ªå¤åˆ¶é›†ç¾¤ä¸­å¿…é¡»æ˜¯å”¯ä¸€çš„ã€‚å¦‚æœä½¿ç”¨è‡ªå®šä¹‰çš„application_nameï¼Œæˆ–è€…application_nameåœ¨æ•´ä¸ªå¤åˆ¶é›†ç¾¤ä¸­ä¸æ˜¯å”¯ä¸€çš„ï¼Œrepmgrå°†æ— æ³•å¯é åœ°ç›‘æ§å­èŠ‚ç‚¹çš„è¿æ¥ã€‚</p>
</li>
</ul>
<h3 id="é…ç½®å‚æ•°">é…ç½®å‚æ•°</h3>
<ul>
<li>child_nodes_check_interval  æ£€æµ‹é—´éš”æ—¶é—´ é»˜è®¤å€¼5s</li>
<li>child_nodes_disconnect_command è‡ªå®šä¹‰è„šæœ¬</li>
<li>child_nodes_disconnect_timeout  è¶…æ—¶æ—¶é—´ é»˜è®¤å€¼30s</li>
<li>child_nodes_connected_min_count  å­˜æ´»ä»åº“çš„æœ€å°å€¼ã€‚å½“æ£€æµ‹åˆ°å­˜æ´»çš„ä»èŠ‚ç‚¹æ•°å°äºè¯¥å€¼æ—¶ï¼Œè§¦å‘child_nodes_disconnect_command äº‹ä»¶ã€‚</li>
<li>child_nodes_disconnect_min_count ä¸¢å¤±èŠ‚ç‚¹çš„æœ€å°å€¼ï¼Œå½“ä¸¢å¤±çš„èŠ‚ç‚¹æ•°å¤§äºè¯¥å€¼æ—¶è§¦å‘child_nodes_disconnect_command äº‹ä»¶ã€‚</li>
</ul>
<p>æ³¨æ„child_nodes_connected_min_count å€¼ä¼šè¦†ç›–child_nodes_disconnect_min_countã€‚å½“è¿™ä¸¤ä¸ªå‚æ•°éƒ½æœªè®¾ç½®æ—¶ã€‚æ£€æµ‹åˆ°ä»èŠ‚ç‚¹å­˜åœ¨ä¸ªæ•°ä¸ºé›¶æ—¶è§¦å‘child_nodes_disconnect_command äº‹ä»¶ã€‚</p>
<h3 id="äº‹ä»¶ç±»å‹">äº‹ä»¶ç±»å‹</h3>
<ul>
<li>child_node_disconnect</li>
<li>child_node_reconnect</li>
<li>child_node_new_connect</li>
<li>child_nodes_disconnect_command</li>
</ul>
<h3 id="æŸ¥çœ‹äº‹ä»¶">æŸ¥çœ‹äº‹ä»¶</h3>
<pre><code>repmgr cluster event --event=xxxxx (äº‹ä»¶ç±»å‹)
</code></pre><h2 id="repmgrd-é…ç½®">repmgrd é…ç½®</h2>
<p>Postgresql é…ç½® postgressql.conf  éœ€è¦é‡å¯æœåŠ¡</p>
<pre><code>shared_preload_libraries = 'repmgr'
</code></pre><ul>
<li>
<p>monitor_interval_secs æ£€æµ‹ä¸Šæ¸¸èŠ‚ç‚¹æ—¶é—´é—´éš” é»˜è®¤2ç§’</p>
</li>
<li>
<p>connection_check_type æ£€æµ‹ç±»å‹ PQping (default)ã€connectionã€query</p>
</li>
<li>
<p>reconnect_attempts é‡è¿å°è¯•æ¬¡æ•° é»˜è®¤6æ¬¡</p>
</li>
<li>
<p>reconnect_interval é‡è¿å°è¯•é—´éš”æ—¶é—´</p>
</li>
<li>
<p>degraded_monitoring_timeout é»˜è®¤-1 ç¦æ­¢ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œrepmgrdå°†æ— é™æœŸåœ°ç»§ç»­å¤„äºé™çº§ç›‘è§†æ¨¡å¼ã€‚è®¾ç½®è¯¥å‚æ•°è¶…æ—¶ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ï¼Œä¹‹årepmgrdå°†ç»ˆæ­¢ã€‚</p>
</li>
</ul>
<h3 id="å¿…é¡»è®¾ç½®çš„å‚æ•°">å¿…é¡»è®¾ç½®çš„å‚æ•°</h3>
<ul>
<li><code>failover</code>      =automatic</li>
<li><code>promote_command</code>   =/&lsquo;usr/bin/repmgr standby promote -f /etc/repmgr.conf &ndash;log-to-file&rsquo;</li>
<li><code>follow_command</code>=  &lsquo;/usr/bin/repmgr standby follow -f /etc/repmgr.conf &ndash;log-to-file &ndash;upstream-node-id=%n&rsquo;</li>
</ul>
<h3 id="å¯é€‰å‚æ•°">å¯é€‰å‚æ•°</h3>
<pre><code>priority
failover_validation_command
primary_visibility_consensus
always_promote
standby_disconnect_on_failover
election_rerun_interval
sibling_nodes_disconnect_timeout
</code></pre><h3 id="å…¶ä»–å‚æ•°">å…¶ä»–å‚æ•°</h3>
<p>é™¤äº†ä»¥ä¸Šé…ç½®ï¼Œconninfo ä¹Ÿä¼šå½±å“ repmgr å¦‚ä½•ä¸ PostgreSQL è¿›è¡Œç½‘ç»œè¿æ¥ï¼Œå¦‚å‚æ•°connect_timeoutã€‚åŒæ—¶ä¹Ÿå—åˆ°ç³»ç»Ÿç½‘ç»œè®¾ç½®  <code>tcp_syn_retries</code>å°†å½±å“ã€‚</p>
<h3 id="æ—¥å¿—è‡ªåŠ¨åˆ‡å‰²">æ—¥å¿—è‡ªåŠ¨åˆ‡å‰²</h3>
<pre><code>  /var/log/repmgr/repmgrd.log {
        missingok
        compress
        rotate 52
        maxsize 100M
        weekly
        create 0600 postgres postgres
        postrotate
            /usr/bin/killall -HUP repmgrd
        endscript
    }
</code></pre><h2 id="repmgrd-æ“ä½œ">repmgrd æ“ä½œ</h2>
<h3 id="repmgrd-ç»´æŠ¤æ¨¡å¼">repmgrd ç»´æŠ¤æ¨¡å¼</h3>
<p>è¿›å…¥ç»´æŠ¤æ¨¡å¼åï¼Œå°†ä¸ä¼šå‘ç”Ÿè‡ªåŠ¨æ•…éšœè½¬ç§»ã€‚</p>
<pre><code># ç»´æŠ¤æ¨¡å¼
repmgr -f /etc/repmgr.conf service pause
# è§£é™¤ç»´æŠ¤æ¨¡å¼
repmgr -f /etc/repmgr.conf service unpause
# æŸ¥çœ‹å½“å‰æ¨¡å¼
repmgr -f /etc/repmgr.conf service status
</code></pre><p>æ³¨æ„: ç»´æŠ¤æ¨¡å¼çš„çŠ¶æ€ä¸ä¼šå› ä¸ºé‡å¯repmgrdæˆ–PostgresqlæœåŠ¡è€Œæ”¹å˜ã€‚</p>
<p>å½“è¿›è¡ŒPostgresql ç‰ˆæœ¬å‡çº§æ—¶ï¼Œè¦å®Œå…¨å…³é—­repmgrd æœåŠ¡ã€‚å¹¶ä¸”å®‰è£…ä¸æ•°æ®åº“å¯¹åº”çš„æ–°ç‰ˆæœ¬repmgrã€‚</p>
<p>æ‰‹åŠ¨æ•…éšœè½¬ç§»<code>repmgr standby switchover</code> ä¼šè‡ªåŠ¨è¿›è¡Œ pause/unpause çŠ¶æ€åˆ‡æ¢ã€‚</p>
<p>å½“Postgresqlæ•°æ®åº“é€šè¿‡<code>pg_wal_replay_pause</code>å¤„äºæš‚åœwalæ—¥å¿—å›æ”¾çŠ¶æ€æ—¶ï¼Œæ•…éšœè½¬ç§»ä¼šè‡ªåŠ¨æ¢å¤walå›æ”¾ã€‚</p>
<p>æ³¨æ„æ‰§è¡Œrepmgr_standby_promote å°†è¢«æ‹’ç»ï¼Œç›´åˆ°ç®¡ç†å‘˜wal resumedæ¢å¤å›æ”¾ã€‚</p>
<h3 id="é™çº§æ¨¡å¼">é™çº§æ¨¡å¼</h3>
<p>å½“é‡åˆ°æŸäº›æƒ…å†µæ—¶å°†è¿›å…¥ &ldquo;é™çº§ç›‘æ§ &ldquo;æ¨¡å¼ï¼Œå³ repmgrd ä»å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œä½†åœ¨ç­‰å¾…æƒ…å†µçš„è§£å†³ã€‚</p>
<p>æƒ…å†µåŒ…æ‹¬: å½“å‘ç”Ÿæ•…éšœæ—¶</p>
<ul>
<li>ä¸ä¸»èŠ‚ç‚¹ä½äºåŒä¸€ä¸ªæ•°æ®ä¸­çš„çš„å…¶ä»–èŠ‚ç‚¹éƒ½ä¸å¯è§ã€‚æ ¹æ®locationå‚æ•°</li>
<li>æ²¡æœ‰å¯ä»¥æå‡ä¸ºä¸»èŠ‚ç‚¹çš„å€™é€‰èŠ‚ç‚¹</li>
<li>å€™é€‰èŠ‚ç‚¹ä¸èƒ½è¢«æå‡ä¸»èŠ‚ç‚¹</li>
<li>èŠ‚ç‚¹ä¸èƒ½ä½œä¸ºæ–°ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹</li>
<li>èŠ‚ç‚¹æ²¡æœ‰è®¾ç½®è‡ªåŠ¨æ•…éšœè½¬ç§»</li>
<li>ä¸»èŠ‚ç‚¹æ•…éšœï¼Œä½†æ˜¯æ²¡å…¶ä»–èŠ‚ç‚¹è¢«æå‡ä¸ºä¸»èŠ‚ç‚¹</li>
</ul>
<p>é»˜è®¤æƒ…å†µï¼Œé™çº§æ¨¡å¼å°†ä¸€è‡´æŒç»­ä¸‹å»ã€‚ä½†å¦‚æœè®¾ç½®äº†degraded_monitoring_timeoutå‚æ•°ï¼Œè¶…è¿‡æŒ‡å®šå€¼ï¼Œrepmgrdå°†åœæ­¢è¿è¡Œã€‚</p>
<h3 id="ç›‘æ§æ•°æ®å­˜å‚¨">ç›‘æ§æ•°æ®å­˜å‚¨</h3>
<p>å½“å‚æ•°monitoring_history=trueæ—¶ï¼Œç›‘æ§è®°å½•æ•°æ®å°†ä¼šä¸æ–­çš„å†™å…¥åˆ°<code>repmgr.monitoring_history</code>è¡¨ä¸­ã€‚ å¯ä»¥ä½¿ç”¨å‘½ä»¤<code>repmgr cluster cleanup -k/ --keep-history</code> (é€‰æ‹©éœ€è¦ä¿ç•™è®°å½•å¤©æ•°) å®šæœŸæ¸…ç†æ•°æ®ã€‚</p>
<p>è¿™äº›æ•°æ®ä¹Ÿä¼šå¤åˆ¶åˆ°ä»èŠ‚ç‚¹ä¸­ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®<code> ALTER TABLE repmgr.monitoring_history SET UNLOGGED;</code> ä½¿æ•°æ®ä¸å¤åˆ¶åˆ°ä»èŠ‚ç‚¹ã€‚</p>
<h2 id="é€‰ä¸¾æµç¨‹ç®€ä»‹">é€‰ä¸¾æµç¨‹ç®€ä»‹</h2>
<p>æºç ä½ç½® <code>repmgrd-physical.c</code></p>
<p>å½“primary èŠ‚ç‚¹è¢«æ£€æµ‹åˆ°å‘ç”Ÿæ•…éšœï¼Œè¿›å…¥é€‰ä¸¾é˜¶æ®µæ—¶çš„å¤§æ¦‚æµç¨‹ã€‚</p>
<pre><code>/*
 * Failover decision for nodes attached to the current primary.
 *
 * NB: this function sets &quot;sibling_nodes&quot;; caller (do_primary_failover)
 * expects to be able to read this list
 */
# é€‰ä¸¾æµç¨‹ Postgresql æ”¯æŒçº§è”å¤åˆ¶ã€‚æ–°çš„ä¸»èŠ‚ç‚¹åªèƒ½åœ¨ä¸€çº§å­èŠ‚ç‚¹ä¸­äº§ç”Ÿã€‚
#  sibling_nodes å…„å¼ŸèŠ‚ç‚¹
static ElectionResult
do_election(NodeInfoList *sibling_nodes, int *new_primary_id)
{
	int			electoral_term = -1;
    #
	NodeInfoListCell *cell = NULL;
# 
	t_node_info *candidate_node = NULL;
# é€‰ä¸¾çŠ¶æ€
	election_stats stats;

	ReplInfo	local_replication_info;

	/* To collate details of nodes with primary visible for logging purposes */
	PQExpBufferData nodes_with_primary_visible;

	/*
	 * Check if at least one server in the primary's location is visible; if
	 * not we'll assume a network split between this node and the primary
	 * location, and not promote any standby.
	 *
	 * NOTE: this function is only ever called by standbys attached to the
	 * current (unreachable) primary, so &quot;upstream_node_info&quot; will always
	 * contain the primary node record.
	 */
	# æ ¹æ®æ˜¯å¦å­˜åœ¨ä¸æ•…éšœèŠ‚ç‚¹ä½ç½®ç›¸åŒçš„å¯è§èŠ‚ç‚¹ã€‚å¦‚æœéƒ½ä¸ºä¸å¯è§çŠ¶æ€ï¼Œåˆ™è®¤ä¸ºæ˜¯ç½‘ç»œé—®é¢˜ã€‚PS: æ¯ä¸ªèŠ‚ç‚¹å¯é…ç½®location å‚æ•°æŒ‡å®šæ‰€åœ¨çš„ç‰©ç†ä½ç½®ã€‚å¦‚å¤šæ•°æ®ä¸­å¿ƒåœºæ™¯
	bool		primary_location_seen = false;

	int			nodes_with_primary_still_visible = 0;

	if (config_file_options.failover_delay &gt; 0)
	{
		log_debug(&quot;sleeping %i seconds (\&quot;failover_delay\&quot;) before initiating failover&quot;,
				  config_file_options.failover_delay);
		sleep(config_file_options.failover_delay);
	}

	/* we're visible */ 
	#å¯è§èŠ‚ç‚¹æ•°
	stats.visible_nodes = 1;
	#ä¸å½“å‰nodeä¸ºç›¸åŒä¸Šæ¸¸çš„èŠ‚ç‚¹æ•° shared_upstream_nodes = sibling_nodes + 1(å½“å‰èŠ‚ç‚¹)
	stats.shared_upstream_nodes = 0;
	# é›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹æ•°
	stats.all_nodes = 0;
    # SELECT term FROM repmgr.voting_term; åˆå§‹å€¼ä¸º1 , æ‰§è¡Œrepmgr standby promoteåŠ ä¸€
	electoral_term = get_current_term(local_conn);

	if (electoral_term == -1)
	{
		log_error(_(&quot;unable to determine electoral term&quot;));

		return ELECTION_NOT_CANDIDATE;
	}

	log_debug(&quot;do_election(): electoral term is %i&quot;, electoral_term);
   # å¦‚æœrepmgr.confä¸­failoverå‚æ•°è®¾ç½®ä¸ºmanual ,è¯¥èŠ‚ç‚¹ä¸å‚ä¸é€‰ä¸¾
	if (config_file_options.failover == FAILOVER_MANUAL)
	{
		log_notice(_(&quot;this node is not configured for automatic failover so will not be considered as promotion candidate, and will not follow the new primary&quot;));
		log_detail(_(&quot;\&quot;failover\&quot; is set to \&quot;manual\&quot; in repmgr.conf&quot;));
		log_hint(_(&quot;manually execute \&quot;repmgr standby follow\&quot; to have this node follow the new primary&quot;));

		return ELECTION_NOT_CANDIDATE;
	}
#å¦‚æœè®¾ç½®priorityä¸º0 ï¼Œè¯¥èŠ‚ç‚¹ä¸å‚ä¸é€‰ä¸¾ ã€‚è§è¯èŠ‚ç‚¹çš„priority=0ã€‚ åŠè§è¯èŠ‚ç‚¹åˆ°è¿™é‡Œå·²ç»å‡ºå±€
	/* node priority is set to zero - don't become a candidate, and lose by default */
	if (local_node_info.priority &lt;= 0)
	{
		log_notice(_(&quot;this node's priority is %i so will not be considered as an automatic promotion candidate&quot;),
				   local_node_info.priority);

		return ELECTION_LOST;
	}
    #è¯¥æ–¹æ³• SQL æŸ¥è¯¢ è§†å›¾repmgr.nodes ,è·å–å…„å¼ŸèŠ‚ç‚¹ã€‚ä½•ä¸ºå…„å¼Ÿï¼Œä¸å½“å‰èŠ‚ç‚¹ä¸Šæ¸¸èŠ‚ç‚¹ç›¸åŒçš„èŠ‚ç‚¹ï¼Œä¸åŒ…æ‹¬è‡ªèº«ã€‚
    # æ³¨æ„ä¸€ç‚¹ã€‚ è§è¯èŠ‚ç‚¹çš„ä¹Ÿç®—åœ¨å…„å¼ŸèŠ‚ç‚¹ä¸­ã€‚å› ä¸ºåœ¨nodesè¡¨ä¸­ä»–ä»¬çš„upstream_node_id ç›¸åŒ 
    # SELECT REPMGR_NODES_COLUMNS FROM repmgr.nodes n  WHERE n.upstream_node_id = %i  AND n.node_id != %i    AND n.active IS TRUE ORDER BY n.node_id  
	/* get all active nodes attached to upstream, excluding self */
	get_active_sibling_node_records(local_conn,
									local_node_info.node_id,
									upstream_node_info.node_id,
									sibling_nodes);

	log_info(_(&quot;%i active sibling nodes registered&quot;), sibling_nodes-&gt;node_count);

	stats.shared_upstream_nodes = sibling_nodes-&gt;node_count + 1;
    #è·å–é›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹æ•°é‡ SELECT count(*) FROM repmgr.nodes n 
	get_all_nodes_count(local_conn, &amp;stats.all_nodes);

	log_info(_(&quot;%i total nodes registered&quot;), stats.all_nodes);
    #åˆ¤æ–­è®°å½•å½“å‰èŠ‚ç‚¹ä½ç½®æ˜¯å¦ä¸ ä¸Šæ¸¸èŠ‚ç‚¹ï¼ˆä¸»èŠ‚ç‚¹ï¼‰ä½ç½®ç›¸åŒ
	if (strncmp(upstream_node_info.location, local_node_info.location, MAXLEN) != 0)
	{
		log_info(_(&quot;primary node \&quot;%s\&quot; (ID: %i) has location \&quot;%s\&quot;, this node's location is \&quot;%s\&quot;&quot;),
				 upstream_node_info.node_name,
				 upstream_node_info.node_id,
				 upstream_node_info.location,
				 local_node_info.location);
	}
	else 
	{
		log_info(_(&quot;primary node  \&quot;%s\&quot; (ID: %i) and this node have the same location (\&quot;%s\&quot;)&quot;),
				 upstream_node_info.node_name,
				 upstream_node_info.node_id,
				 local_node_info.location);
	}

	local_node_info.last_wal_receive_lsn = InvalidXLogRecPtr;
	# æ²¡æœ‰å…„å¼ŸèŠ‚ç‚¹ï¼Œæ²¡æœ‰è§è¯èŠ‚ç‚¹ï¼Œç‹¬ç”Ÿå­ã€‚å¦‚æœä¸ä¸»èŠ‚ç‚¹ä½ç½®ç›¸åŒç›´æ¥ç»§æ‰¿ç‹ä½ï¼Œæ±Ÿæ¹–ä¸­çš„æ‰“æ‰“æ€æ€åœ¨è¿™é‡Œä¸å­˜åœ¨ã€‚
	/* fast path if no other standbys (or witness) exists - normally win by default */
	if (sibling_nodes-&gt;node_count == 0)
	{	# æ¯”è¾ƒä¸Šæ¸¸èŠ‚ç‚¹ï¼ˆåŸä¸»èŠ‚ç‚¹ï¼‰ä¸å½“å‰èŠ‚ç‚¹çš„ä½ç½®ï¼Œå¦‚æœç›¸åŒ
		if (strncmp(upstream_node_info.location, local_node_info.location, MAXLEN) == 0)
		{# å‡çº§ä¸ºä¸»æœåŠ¡å‰çš„é…ç½®çš„éªŒè¯è„šæœ¬ï¼Œæ˜¯å¦è¿”å›å€¼ä¸º0
			if (config_file_options.failover_validation_command[0] != '\0')
			{ 
				return execute_failover_validation_command(&amp;local_node_info, &amp;stats);
			}

			log_info(_(&quot;no other sibling nodes - we win by default&quot;));
          # èƒœå‡ºï¼Œæ–°ç‹è¯ç”Ÿã€‚
			return ELECTION_WON;
		}
		else
		{
			/*
			 * If primary and standby have different locations set, the assumption
			 * is that no action should be taken as we can't tell whether there's
			 * been a network interruption or not.
			 *
			 * Normally a situation with primary and standby in different physical
			 * locations would be handled by leaving the location as &quot;default&quot; and
			 * setting up a witness server in the primary's location.
			 */
			log_debug(&quot;no other nodes, but primary and standby locations differ&quot;);
           # è™½ç„¶åªæœ‰ä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œä½†æ˜¯ä¸ä¸»èŠ‚ç‚¹çš„ä½ç½®ä¸åŒï¼Œä¸èƒ½è¿›è¡Œå‡çº§ã€‚é›†ç¾¤è¿›è¡Œé™çº§å¤„ç†ã€‚å¾ˆé—æ†¾ã€‚
           # ç›¸å½“äº ä¸»èŠ‚ç‚¹ç›¸åŒä½ç½®çš„èŠ‚ç‚¹éƒ½ä¸å¯è§ã€‚è¢«è®¤ä¸ºç½‘ç»œåˆ†åŒºæ•…éšœã€‚
			monitoring_state = MS_DEGRADED;
			INSTR_TIME_SET_CURRENT(degraded_monitoring_start);

			return ELECTION_NOT_CANDIDATE;
		}
	}
	# å½“æœ‰å¤šä¸ªå…„å¼Ÿçš„æ—¶å€™
	else 
	{
		/* standby nodes found - check if we're in the primary location before checking theirs */ # å½“å‰èŠ‚ç‚¹æ˜¯å¦ä¸ä¸»èŠ‚ç‚¹ä½ç½®ç›¸åŒ
		if (strncmp(upstream_node_info.location, local_node_info.location, MAXLEN) == 0)
		{   # å­˜åœ¨ä¸ä¸»èŠ‚ç‚¹ä½ç½®ç›¸åŒçš„ç›´æ¥ä»èŠ‚ç‚¹
			primary_location_seen = true;
		}
	}

	/* get our lsn */ # 
	if (get_replication_info(local_conn, STANDBY, &amp;local_replication_info) == false)
	{
		log_error(_(&quot;unable to retrieve replication information for local node&quot;));
		return ELECTION_LOST;
	}
     # wal å›æ”¾çŠ¶æ€ä¸º paused ï¼Œå°è¯•æ¢å¤walå›æ”¾çŠ¶æ€ , resumeå¤±è´¥ å½“å‰èŠ‚ç‚¹ä¸å‚ä¸é€‰ä¸¾
	/* check if WAL replay on local node is paused */
	if (local_replication_info.wal_replay_paused == true)
	{
		log_debug(&quot;WAL replay is paused&quot;);
		if (local_replication_info.last_wal_receive_lsn &gt; local_replication_info.last_wal_replay_lsn)
		{
			log_warning(_(&quot;WAL replay on this node is paused and WAL is pending replay&quot;));
			log_detail(_(&quot;replay paused at %X/%X; last WAL received is %X/%X&quot;),
					   format_lsn(local_replication_info.last_wal_replay_lsn),
					   format_lsn(local_replication_info.last_wal_receive_lsn));
		}
		# å°è¯•æ¢å¤walçŠ¶æ€
		/* attempt to resume WAL replay - unlikely this will fail, but just in case */
		if (resume_wal_replay(local_conn) == false)
		{
			log_error(_(&quot;unable to resume WAL replay&quot;));
			log_detail(_(&quot;this node cannot be reliably promoted&quot;));
			# resume å¤±è´¥ï¼Œè¯¥èŠ‚ç‚¹ä¸å‚ä¸é€‰ä¸¾
			return ELECTION_LOST;
		}

		log_notice(_(&quot;WAL replay forcibly resumed&quot;));
	}

	local_node_info.last_wal_receive_lsn = local_replication_info.last_wal_receive_lsn;

	log_info(_(&quot;local node's last receive lsn: %X/%X&quot;), format_lsn(local_node_info.last_wal_receive_lsn));

	/* pointer to &quot;winning&quot; node, initially self */
	candidate_node = &amp;local_node_info;

	initPQExpBuffer(&amp;nodes_with_primary_visible);
   # ä¼—å€™é€‰èŠ‚ç‚¹è¿›å…¥é€‰ä¸¾ä¼šåœºï¼Œå¼€å§‹å®æ€ã€‚
	for (cell = sibling_nodes-&gt;head; cell; cell = cell-&gt;next)
	{
		ReplInfo	sibling_replication_info;

		log_info(_(&quot;checking state of sibling node \&quot;%s\&quot; (ID: %i)&quot;),
				 cell-&gt;node_info-&gt;node_name,
				 cell-&gt;node_info-&gt;node_id);

		/* assume the worst case */
		cell-&gt;node_info-&gt;node_status = NODE_STATUS_UNKNOWN;

		cell-&gt;node_info-&gt;conn = establish_db_connection(cell-&gt;node_info-&gt;conninfo, false);

		if (PQstatus(cell-&gt;node_info-&gt;conn) != CONNECTION_OK)
		{
			close_connection(&amp;cell-&gt;node_info-&gt;conn);

			continue;
		}

		cell-&gt;node_info-&gt;node_status = NODE_STATUS_UP;

		stats.visible_nodes++;

		/*
		 * see if the node is in the primary's location (but skip the check if
		 * we've seen a node there already)
		 */
		if (primary_location_seen == false)
		{
			if (strncmp(cell-&gt;node_info-&gt;location, upstream_node_info.location, MAXLEN) == 0)
			{
				log_debug(&quot;node %i in primary location \&quot;%s\&quot;&quot;,
						  cell-&gt;node_info-&gt;node_id,
						  cell-&gt;node_info-&gt;location);
				primary_location_seen = true;
			}
		}

		/*
		 * check if repmgrd running - skip if not
		 *
		 * TODO: include pid query in replication info query?
		 *
		 * NOTE: from Pg12 we could execute &quot;pg_promote()&quot; from a running repmgrd;
		 * here we'll need to find a way of ensuring only one repmgrd does this
		 */
		if (repmgrd_get_pid(cell-&gt;node_info-&gt;conn) == UNKNOWN_PID)
		{
			log_warning(_(&quot;repmgrd not running on node \&quot;%s\&quot; (ID: %i), skipping&quot;),
						cell-&gt;node_info-&gt;node_name,
						cell-&gt;node_info-&gt;node_id);
			continue;
		}

		if (get_replication_info(cell-&gt;node_info-&gt;conn, cell-&gt;node_info-&gt;type, &amp;sibling_replication_info) == false)
		{
			log_warning(_(&quot;unable to retrieve replication information for node \&quot;%s\&quot; (ID: %i), skipping&quot;),
						cell-&gt;node_info-&gt;node_name,
						cell-&gt;node_info-&gt;node_id);
			continue;
		}

		/*
		 * Check if node is not in recovery - it may have been promoted
		 * outside of the failover mechanism, in which case we may be able
		 * to follow it.
		 */

		# æœ‰å…„å¼ŸèŠ‚ç‚¹è¢«æ‰‹åŠ¨æå‡ä¸ºä¸»èŠ‚ç‚¹
		if (sibling_replication_info.in_recovery == false &amp;&amp; cell-&gt;node_info-&gt;type != WITNESS)
		{
			bool can_follow;

			log_warning(_(&quot;node \&quot;%s\&quot; (ID: %i) is not in recovery&quot;),
						cell-&gt;node_info-&gt;node_name,
						cell-&gt;node_info-&gt;node_id);

			/*
			 * Node is not in recovery, but still reporting an upstream
			 * node ID; possible it was promoted manually (e.g. with &quot;pg_ctl promote&quot;),
			 * or (less likely) the node's repmgrd has just switched to primary
			 * monitoring node but has not yet unset the upstream node ID in
			 * shared memory. Either way, log this.
			 */
			if (sibling_replication_info.upstream_node_id != UNKNOWN_NODE_ID)
			{
				log_warning(_(&quot;node \&quot;%s\&quot; (ID: %i) still reports its upstream is node %i, last seen %i second(s) ago&quot;),
							cell-&gt;node_info-&gt;node_name,
							cell-&gt;node_info-&gt;node_id,
							sibling_replication_info.upstream_node_id,
							sibling_replication_info.upstream_last_seen);
			}
			#æ£€éªŒå½“å‰èŠ‚ç‚¹æ˜¯å¦èƒ½follow è¢«æå‡çš„å…„å¼ŸèŠ‚ç‚¹
			can_follow = check_node_can_follow(local_conn,
											   local_node_info.last_wal_receive_lsn,
											   cell-&gt;node_info-&gt;conn,
											   cell-&gt;node_info);
			# åœ¨é€‰ä¸¾ç»“æœå‰æœ‰èŠ‚ç‚¹æ‰‹åŠ¨æå‡èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹ã€‚å¹¶ä¸”å½“å‰èŠ‚ç‚¹å¯ä»¥followerã€‚å½“å‰èŠ‚ç‚¹ä¸åœ¨å‚ä¸é€‰ä¸¾
			if (can_follow == true)
			{
				*new_primary_id = cell-&gt;node_info-&gt;node_id;
				termPQExpBuffer(&amp;nodes_with_primary_visible);
				return ELECTION_CANCELLED;
			}
			# å¦‚æœä¸èƒ½followerä¸»èŠ‚ç‚¹ã€‚è¿™ç§æƒ…å†µä¼šå¾ˆæ£˜æ‰‹ã€‚
			/*
			 * Tricky situation here - we'll assume the node is a rogue primary
			 */
			log_warning(_(&quot;not possible to attach to node \&quot;%s\&quot; (ID: %i), ignoring&quot;),
						cell-&gt;node_info-&gt;node_name,
						cell-&gt;node_info-&gt;node_id);
			continue;
		}
		else
		{
			log_info(_(&quot;node \&quot;%s\&quot; (ID: %i) reports its upstream is node %i, last seen %i second(s) ago&quot;),
					 cell-&gt;node_info-&gt;node_name,
					 cell-&gt;node_info-&gt;node_id,
					 sibling_replication_info.upstream_node_id,
					 sibling_replication_info.upstream_last_seen);
		}

		/* check if WAL replay on node is paused */
		if (sibling_replication_info.wal_replay_paused == true)
		{
			/*
			 * Theoretically the repmgrd on the node should have resumed WAL play
			 * at this point.
			 */
			if (sibling_replication_info.last_wal_receive_lsn &gt; sibling_replication_info.last_wal_replay_lsn)
			{
				log_warning(_(&quot;WAL replay on node \&quot;%s\&quot; (ID: %i) is paused and WAL is pending replay&quot;),
							cell-&gt;node_info-&gt;node_name,
							cell-&gt;node_info-&gt;node_id);
			}
		}

		/*
		 * Check if node has seen primary &quot;recently&quot; - if so, we may have &quot;partial primary visibility&quot;.
		 * For now we'll assume the primary is visible if it's been seen less than
		 * monitor_interval_secs * 2 seconds ago. We may need to adjust this, and/or make the value
		 * configurable.
		 */

		if (sibling_replication_info.upstream_last_seen &gt;= 0 &amp;&amp; sibling_replication_info.upstream_last_seen &lt; (config_file_options.monitor_interval_secs * 2))
		{
			if (sibling_replication_info.upstream_node_id != upstream_node_info.node_id)
			{
				log_warning(_(&quot;assumed sibling node \&quot;%s\&quot; (ID: %i) monitoring different upstream node %i&quot;),
							cell-&gt;node_info-&gt;node_name,
							cell-&gt;node_info-&gt;node_id,
							sibling_replication_info.upstream_node_id);

			}
			else
			{
				nodes_with_primary_still_visible++;
				log_notice(_(&quot;%s node \&quot;%s\&quot; (ID: %i) last saw primary node %i second(s) ago, considering primary still visible&quot;),
						   get_node_type_string(cell-&gt;node_info-&gt;type),
						   cell-&gt;node_info-&gt;node_name,
						   cell-&gt;node_info-&gt;node_id,
						   sibling_replication_info.upstream_last_seen);
				appendPQExpBuffer(&amp;nodes_with_primary_visible,
								  &quot; - node \&quot;%s\&quot; (ID: %i): %i second(s) ago\n&quot;,
								  cell-&gt;node_info-&gt;node_name,
								  cell-&gt;node_info-&gt;node_id,
								  sibling_replication_info.upstream_last_seen);
			}
		}
		else
		{
			log_info(_(&quot;%s node \&quot;%s\&quot; (ID: %i) last saw primary node %i second(s) ago&quot;),
					 get_node_type_string(cell-&gt;node_info-&gt;type),
					 cell-&gt;node_info-&gt;node_name,
					 cell-&gt;node_info-&gt;node_id,
					 sibling_replication_info.upstream_last_seen);
		}

		# è§è¯èŠ‚ç‚¹ä¸å‚ä¸é€‰ä¸¾
		/* don't interrogate a witness server */
		if (cell-&gt;node_info-&gt;type == WITNESS)
		{
			log_debug(&quot;node %i is witness, not querying state&quot;, cell-&gt;node_info-&gt;node_id);
			continue;
		}
        # priority=0 çš„èŠ‚ç‚¹ä¸å‚ä¸é€‰ä¸¾
		/* don't check 0-priority nodes */
		if (cell-&gt;node_info-&gt;priority &lt;= 0)
		{
			log_info(_(&quot;node \&quot;%s\&quot; (ID: %i) has priority of %i, skipping&quot;),
					   cell-&gt;node_info-&gt;node_name,
					   cell-&gt;node_info-&gt;node_id,
					   cell-&gt;node_info-&gt;priority);
			continue;
		}


		/* get node's last receive LSN - if &quot;higher&quot; than current winner, current node is candidate */
		cell-&gt;node_info-&gt;last_wal_receive_lsn = sibling_replication_info.last_wal_receive_lsn;

		log_info(_(&quot;last receive LSN for sibling node \&quot;%s\&quot; (ID: %i) is: %X/%X&quot;),
				 cell-&gt;node_info-&gt;node_name,
				 cell-&gt;node_info-&gt;node_id,
				 format_lsn(cell-&gt;node_info-&gt;last_wal_receive_lsn));

		/* compare LSN */ # æ¯”è¾ƒLSN
		if (cell-&gt;node_info-&gt;last_wal_receive_lsn &gt; candidate_node-&gt;last_wal_receive_lsn)
		{
			/* other node is ahead */
			log_info(_(&quot;node \&quot;%s\&quot; (ID: %i) is ahead of current candidate \&quot;%s\&quot; (ID: %i)&quot;),
					 cell-&gt;node_info-&gt;node_name,
					 cell-&gt;node_info-&gt;node_id,
					 candidate_node-&gt;node_name,
					 candidate_node-&gt;node_id);

			candidate_node = cell-&gt;node_info;
		}
		# LSN ç›¸åŒæ¯”è¾ƒ priority,priorityä¹Ÿç›¸åŒç„¶åæ¯”è¾ƒ node_id
		/* LSN is same - tiebreak on priority, then node_id */
		#LSN å¯¹æ¯”
		else if (cell-&gt;node_info-&gt;last_wal_receive_lsn == candidate_node-&gt;last_wal_receive_lsn)
		{
			log_info(_(&quot;node \&quot;%s\&quot; (ID: %i) has same LSN as current candidate \&quot;%s\&quot; (ID: %i)&quot;),
					 cell-&gt;node_info-&gt;node_name,
					 cell-&gt;node_info-&gt;node_id,
					 candidate_node-&gt;node_name,
					 candidate_node-&gt;node_id);
            #priority å¯¹æ¯”
			if (cell-&gt;node_info-&gt;priority &gt; candidate_node-&gt;priority)
			{
				log_info(_(&quot;node \&quot;%s\&quot; (ID: %i) has higher priority (%i) than current candidate \&quot;%s\&quot; (ID: %i) (%i)&quot;),
						 cell-&gt;node_info-&gt;node_name,
						 cell-&gt;node_info-&gt;node_id,
						 cell-&gt;node_info-&gt;priority,
						 candidate_node-&gt;node_name,
						 candidate_node-&gt;node_id,
						 candidate_node-&gt;priority);

				candidate_node = cell-&gt;node_info;
			}
			else if (cell-&gt;node_info-&gt;priority == candidate_node-&gt;priority)
			{
				if (cell-&gt;node_info-&gt;node_id &lt; candidate_node-&gt;node_id)
				{
					log_info(_(&quot;node \&quot;%s\&quot; (ID: %i) has same priority but lower node_id than current candidate \&quot;%s\&quot; (ID: %i)&quot;),
							 cell-&gt;node_info-&gt;node_name,
							 cell-&gt;node_info-&gt;node_id,
							 candidate_node-&gt;node_name,
							 candidate_node-&gt;node_id);

					candidate_node = cell-&gt;node_info;
				}
			}
			else
			{
				log_info(_(&quot;node \&quot;%s\&quot; (ID: %i) has lower priority (%i) than current candidate \&quot;%s\&quot; (ID: %i) (%i)&quot;),
						 cell-&gt;node_info-&gt;node_name,
						 cell-&gt;node_info-&gt;node_id,
						 cell-&gt;node_info-&gt;priority,
						 candidate_node-&gt;node_name,
						 candidate_node-&gt;node_id,
						 candidate_node-&gt;priority);
			}
		}
	}
    # ç½‘ç»œåˆ†åŒºï¼Œé™çº§ã€‚
	if (primary_location_seen == false)
	{
		log_notice(_(&quot;no nodes from the primary location \&quot;%s\&quot; visible - assuming network split&quot;),
				   upstream_node_info.location);
		log_detail(_(&quot;node will enter degraded monitoring state waiting for reconnect&quot;));

		monitoring_state = MS_DEGRADED;
		INSTR_TIME_SET_CURRENT(degraded_monitoring_start);

		reset_node_voting_status();

		termPQExpBuffer(&amp;nodes_with_primary_visible);

		return ELECTION_CANCELLED;
	}
    # ä¸»èŠ‚ç‚¹ä»å¯è§
	if (nodes_with_primary_still_visible &gt; 0)
	{
		log_info(_(&quot;%i nodes can see the primary&quot;),
				   nodes_with_primary_still_visible);

		log_detail(_(&quot;following nodes can see the primary:\n%s&quot;),
				   nodes_with_primary_visible.data);
		#ä¸»èŠ‚ç‚¹å¯è§æ€§å…±è¯†
		if (config_file_options.primary_visibility_consensus == true)
		{
			log_notice(_(&quot;cancelling failover as some nodes can still see the primary&quot;));
			monitoring_state = MS_DEGRADED;
			INSTR_TIME_SET_CURRENT(degraded_monitoring_start);

			reset_node_voting_status();

			termPQExpBuffer(&amp;nodes_with_primary_visible);

			return ELECTION_CANCELLED;
		}
	}

	termPQExpBuffer(&amp;nodes_with_primary_visible);

	log_info(_(&quot;visible nodes: %i; total nodes: %i; no nodes have seen the primary within the last %i seconds&quot;),
			 stats.visible_nodes,
			 stats.shared_upstream_nodes,
			 (config_file_options.monitor_interval_secs * 2));
	# åŒçº§èŠ‚ç‚¹ä¸­å¤§éƒ¨åˆ†ä¸å¯è§ï¼Œä¸å‚ä¸é€‰ä¸¾
	if (stats.visible_nodes &lt;= (stats.shared_upstream_nodes / 2.0))
	{
		log_notice(_(&quot;unable to reach a qualified majority of nodes&quot;));
		log_detail(_(&quot;node will enter degraded monitoring state waiting for reconnect&quot;));

		monitoring_state = MS_DEGRADED;
		INSTR_TIME_SET_CURRENT(degraded_monitoring_start);

		reset_node_voting_status();

		return ELECTION_CANCELLED;
	}

	log_notice(_(&quot;promotion candidate is \&quot;%s\&quot; (ID: %i)&quot;),
			   candidate_node-&gt;node_name,
			   candidate_node-&gt;node_id);
   # æ–°é€‰å‡ºçš„èŠ‚ç‚¹ä¸ºå½“å‰èŠ‚ç‚¹
	if (candidate_node-&gt;node_id == local_node_info.node_id)
	{
		/*
		 * If &quot;failover_validation_command&quot; is set, execute that command
		 * and decide the result based on the command's output
		 */
      # éªŒè¯failover_validation_command è„šæœ¬çš„æ‰§è¡Œ
		if (config_file_options.failover_validation_command[0] != '\0')
		{
			return execute_failover_validation_command(candidate_node, &amp;stats);
		}
		# å½“å‰èŠ‚ç‚¹å®£å¸ƒèƒœå‡ºï¼Œä¸ºä¸»èŠ‚ç‚¹
		return ELECTION_WON;
	}

	return ELECTION_LOST;
}if (primary_location_seen == false)
	{
		log_notice(_(&quot;no nodes from the primary location \&quot;%s\&quot; visible - assuming network split&quot;),
				   upstream_node_info.location);
		log_detail(_(&quot;node will enter degraded monitoring state waiting for reconnect&quot;));

		monitoring_state = MS_DEGRADED;
		INSTR_TIME_SET_CURRENT(degraded_monitoring_start);

		reset_node_voting_status();

		termPQExpBuffer(&amp;nodes_with_primary_visible);

		return ELECTION_CANCELLED;
	}

	if (nodes_with_primary_still_visible &gt; 0)
	{
		log_info(_(&quot;%i nodes can see the primary&quot;),
				   nodes_with_primary_still_visible);

		log_detail(_(&quot;following nodes can see the primary:\n%s&quot;),
				   nodes_with_primary_visible.data);

		if (config_file_options.primary_visibility_consensus == true)
		{
			log_notice(_(&quot;cancelling failover as some nodes can still see the primary&quot;));
			monitoring_state = MS_DEGRADED;
			INSTR_TIME_SET_CURRENT(degraded_monitoring_start);

			reset_node_voting_status();

			termPQExpBuffer(&amp;nodes_with_primary_visible);

			return ELECTION_CANCELLED;
		}
	}
</code></pre><h3 id="æ€»ç»“">æ€»ç»“</h3>
<p><code>é€‰ä¸¾ç»“æœçŠ¶æ€</code></p>
<pre><code>ELECTION_NOT_CANDIDAT
ELECTION_WON
ELECTION_LOST
ELECTION_CANCELLED
ELECTION_RERUN
</code></pre><p>æ ¹æ®location æˆ– winessèŠ‚ç‚¹å†³å®šé›†ç¾¤æ˜¯å¦å¤„äºç½‘ç»œåˆ†åŒºçŠ¶æ€ï¼Œè¿›å…¥é€‰ä¸¾æˆ–é™çº§æ¨¡å¼ã€‚</p>
<p>å½“åªæœ‰ä¸€ä¸ªä¸€çº§ä»èŠ‚ç‚¹</p>
<ul>
<li>ä»èŠ‚ç‚¹åŸä¸»èŠ‚ç‚¹ä½ç½®ç›¸åŒç›´æ¥é€‰ä¸¾æˆåŠŸã€‚</li>
<li>ä»èŠ‚ç‚¹ä¸åŸä¸»èŠ‚ç‚¹ä½ç½®ä¸åŒä¸”æ²¡æœ‰è§è¯èŠ‚ç‚¹åˆ™é™çº§ã€‚</li>
</ul>
<p>ä¸å‚ä¸é€‰ä¸¾çš„èŠ‚ç‚¹</p>
<ul>
<li>Priority=0</li>
<li>repmgr.confä¸­failoverå‚æ•°è®¾ç½®ä¸ºmanual</li>
<li>wal å¤„äº pause çŠ¶æ€å°†è¢«resumeã€‚ä½†resumeå¤±è´¥</li>
</ul>
<p>Repmgré€‰ä¸¾å€™é€‰å¤‡èŠ‚ç‚¹ä¼šä»¥ä»¥ä¸‹é¡ºåºé€‰ä¸¾ï¼šLSN-&gt; Priority-&gt; Node_IDã€‚</p>
<h2 id="æµç¨‹å›¾">æµç¨‹å›¾</h2>
<p>
        <img class="mx-auto" alt="" src="/images/repmgrd.png" />   
    </p>
<h2 id="åŠŸèƒ½å¢å¼º">åŠŸèƒ½å¢å¼º</h2>
<p>å¦‚ä½•å°†repmgrdçœŸæ­£æŠ•å…¥åˆ°ç”Ÿäº§ä¸­ï¼ŒçœŸæ­£çš„è½åœ°ã€‚é¢å¯¹æŸäº›CASESæ—¶ä»èƒ½æ»¡è¶³HAè¦æ±‚</p>
<h3 id="virtual-ip"><strong>Virtual IP</strong></h3>
<ul>
<li>æ³¨å†Œä¸»èŠ‚ç‚¹æ—¶ï¼Œç»‘å®švip</li>
<li>Failover &amp; Switchoveræ—¶ åˆ©ç”¨failover_validation_commandäº‹ä»¶é‡æ–°ç»‘å®švip</li>
<li>æ•´ä¸ªé›†ç¾¤é‡å¯æ—¶ï¼Œè¯†åˆ«å‡ºä¸»èŠ‚ç‚¹ç»‘å®švip</li>
</ul>
<h3 id="ä¸»èŠ‚ç‚¹å¼‚å¸¸åæ¢å¤å¤„ç†">ä¸»èŠ‚ç‚¹å¼‚å¸¸åæ¢å¤å¤„ç†</h3>
<ul>
<li>ä¸»èŠ‚ç‚¹ç½‘ç»œé—®é¢˜ï¼Œå¦‚ç½‘ç»œé˜²ç«å¢™ç­‰åŸå› ã€‚PostgresqlæœåŠ¡ä»åœ¨è¿è¡Œï¼Œå¹¶å¯å†™ã€‚</li>
</ul>
<pre><code>è®¾ç½®å‚æ•° child_nodes_connected_min_count
è§¦å‘äº‹ä»¶ child_nodes_disconnect_command ä¸­å®šä¹‰å›è°ƒæ–¹æ³•å°†ä¸»èŠ‚ç‚¹é™çº§ä¸ºåªè¯»ï¼Œæˆ–å…³é—­ã€‚
</code></pre><ul>
<li>
<p>å¼‚å¸¸æ¢å¤æ—¶ï¼Œç½‘ç»œé‡æ–°æ¢å¤è¿æ¥ã€‚</p>
<p>æ‰¾å‡ºé›†ç¾¤æ•…éšœè½¬ç§»åæ–°ä¸»èŠ‚ç‚¹ï¼Œ æ–¹æ³• libpq ä¸­å¯å†™å¤šä¸ªhostsã€‚</p>
<p>pg_rewind å¯¹é½æ—¶é—´çº¿</p>
<p>rejoin æ–°é›†ç¾¤</p>
</li>
<li>
<p>æ–­ç”µ ï¼Œä¸èƒ½åšä»»ä½•å¤„ç†</p>
</li>
<li>
<p>ç”µåŠ›æ¢å¤ã€‚æœåŠ¡é‡å¯ï¼Œæ£€æµ‹ä»åº“æ•°é‡å¦‚æœä¸º0 æš‚æ—¶ä¸æä¾›æœåŠ¡ã€‚ç­‰å¾…ä¸€æ®µæ—¶é—´ stop service -&gt; rejoiné›†ç¾¤</p>
</li>
</ul>
<h3 id="ä»èŠ‚ç‚¹æ•…éšœåŠæ¢å¤">ä»èŠ‚ç‚¹æ•…éšœåŠæ¢å¤</h3>
<ul>
<li>å½“ä»èŠ‚ç‚¹å‘ç”Ÿæ•…éšœæ—¶ä¸ä¼šå¼•èµ·æ•…éšœè½¬ç§»ã€‚å½“éœ€è¦æ³¨æ„å½“ä»èŠ‚ç‚¹æ•…éšœæ¢å¤åwalæ—¥å¿—ä¼šè½åä¸ä¸»åº“ã€‚</li>
</ul>
<h3 id="å¯¹å¤–æœåŠ¡ç®¡ç†">å¯¹å¤–æœåŠ¡ç®¡ç†</h3>
<p>åº”ç”¨åœ¨é€šå¸¸æƒ…å†µä¸‹ä¸ä¼šç›´æ¥è¿æ¥æ•°æ®åº“ï¼Œæ¯”å¦‚é€šè¿‡dnsï¼Œhaproxyç­‰ä¸­é—´ç®¡ç†æœåŠ¡è¿›è¡Œè´Ÿè½½å‡è¡¡å’Œè§£è€¦ã€‚</p>
<p>åœ¨æ•°æ®åº“å‘ç”Ÿæ•…éšœè½¬ç§»æ—¶ï¼Œå¯¹åº”ç”¨ç¨‹åºæ¥è¯´å°½é‡åšåˆ°ä¸éœ€å˜åŒ–ï¼Œæ— æ„Ÿã€‚</p>
<p>æ–°å¢ä¸€ä¸ªç‹¬ç«‹ä¸ç°æœ‰æœåŠ¡ä¹‹å¤–çš„æœåŠ¡ã€‚</p>
<h4 id="ä¸»è¦åŠŸèƒ½">ä¸»è¦åŠŸèƒ½</h4>
<p>æä¾›ä¸€ä¸ªä¸ƒå±‚httpè¯·æ±‚, åŒ…æ‹¬è®¿é—®æƒé™éªŒè¯</p>
<p><code>è¿”å›å€¼</code>: æœåŠ¡å·²ç»æ­£å¸¸è¿è¡Œçš„æ—¶é—´ ps:ä¸Šå±‚è´Ÿè½½å‡è¡¡ç”¨æˆ·å¯å‚è€ƒè¯¥å€¼è¿›è¡Œæƒé™åˆ†é…ã€‚å¦‚èŠ‚ç‚¹åˆšæ¥å…¥é›†ç¾¤ç¼“å­˜æ•°æ®å°šæœªå‡†å¤‡å……åˆ†ï¼Œå»ºè®®ä¸šåŠ¡æµé‡é€æ­¥æ¥å…¥ã€‚</p>
<p><code>è¿”å›ç </code>: 200 , å…¶ä»–</p>
<p><code>ä¸»åº“</code>  è®¿é—®åœ°å€ ip:port/master ?xxx</p>
<p>â€‹      å¦‚è¿”å›ç ä¸º200ï¼Œå½“å‰èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹å¹¶ä¸”æœåŠ¡æ­£å¸¸ã€‚</p>
<p>â€‹      å…¶ä»–è¿”å›ç ,æš‚æ—¶ä¸èƒ½æä¾›å†™æœåŠ¡</p>
<p>â€‹	  ä¸»è¦åˆ¤æ–­é€»è¾‘: PGæœåŠ¡å¯è¿æ¥æ€§ï¼Œä¸‹æ¸¸èŠ‚ç‚¹ä¸ªæ•°</p>
<p><code>ä»åº“</code> è®¿é—®åœ°å€ ip:port/replocation ?xxx</p>
<p>â€‹      ä¸»è¦åˆ¤æ–­é€»è¾‘: PGæœåŠ¡å¯è¿æ¥æ€§ï¼Œè½åä¸»èŠ‚ç‚¹çš„walå·®å€¼</p>
<h4 id="å¯è§£å†³çš„é—®é¢˜">å¯è§£å†³çš„é—®é¢˜</h4>
<ul>
<li>
<p>vip ä¸èƒ½è·¨ç½‘æ®µç®¡ç†</p>
</li>
<li>
<p>åœ¨Postgresqlå¯¹å¤–æä¾›æœåŠ¡æ—¶è¿›è¡Œå¥åº·çŠ¶æ€æ£€æµ‹ã€‚å¦‚æœä¸æ»¡è¶³éœ€æ±‚ï¼Œåœæ­¢å¯¹åº”ç”¨æä¾›æœåŠ¡ï¼Œå¾…æ¢å¤ååœ¨æä¾›æœåŠ¡</p>
</li>
</ul>
<h2 id="æ•…éšœåˆ‡æ¢æ—¶é—´é¢„ä¼°">æ•…éšœåˆ‡æ¢æ—¶é—´é¢„ä¼°</h2>
<p>switchover &amp; failover: æ•…éšœå‘ç”Ÿåæ£€æµ‹åˆ‡æ¢çš„æ€»æ—¶é—´é¢„ä¼°</p>
<p>ä¸»è¦å‚è€ƒå› ç´ :</p>
<ul>
<li>
<p>monitor_interval_secs æ£€æµ‹ä¸Šæ¸¸èŠ‚ç‚¹æ—¶é—´é—´éš” é»˜è®¤2ç§’</p>
</li>
<li>
<p>connection_check_type æ£€æµ‹ç±»å‹ æ¯æ¬¡æ£€æµ‹çš„timeout</p>
</li>
<li>
<p>reconnect_attempts é‡è¿å°è¯•æ¬¡æ•° é»˜è®¤6æ¬¡</p>
</li>
<li>
<p>reconnect_interval é‡è¿å°è¯•é—´éš”æ—¶é—´</p>
</li>
</ul>
<h2 id="åªæœ‰ä¸¤ä¸ªèŠ‚ç‚¹">åªæœ‰ä¸¤ä¸ªèŠ‚ç‚¹</h2>
<p>ä¸»è¦é¢ä¸´é—®é¢˜: ä¸¤ä¸ªèŠ‚ç‚¹ä¸»è¦æ˜¯å½“å‘ç”Ÿç½‘ç»œæ•…éšœæ—¶ï¼Œè€Œépostgresæ•°æ®åº“åº”ç”¨é—®é¢˜æ—¶ã€‚ä»åº“æ— æ³•åˆ¤æ–­æ˜¯ç½‘ç»œè¿˜æ˜¯ä¸»åº“å‘ç”Ÿäº†æ•…éšœã€‚è§è¯èŠ‚ç‚¹ä¸»è¦æ˜¯ä¸ºäº†è§£å†³è¿™æ ·çš„é—®é¢˜ã€‚</p>
<p>è§£å†³æ€è·¯: æ¨¡æ‹Ÿè§è¯èŠ‚ç‚¹ã€‚åœ¨ä»åº“æ— æ³•ä¸ä¸»åº“é€šä¿¡æ—¶ï¼Œping ä¸€ä¸ªå…¶ä»–èŠ‚ç‚¹ã€‚æˆ–ping ç½‘å…³æˆ–è‡ªå·±çš„ipã€‚ å½“pingå¤±è´¥æ—¶è®¤ä¸ºå‘ç”Ÿäº†ç½‘ç»œé—®é¢˜ã€‚</p>
<p>å…·ä½“å®ç°: é…ç½® <code>failover_validation_command</code></p>
<p>â€‹	failover_validation_command.sh</p>
<pre><code>#! bin/bash
ping -c 5 {{ inventory_hostname }}
if [ $? -eq 0 ]; then
	echo &quot;ping $ip  success!&quot;
	return 0
else
	echo &quot;ping  $ip fail!&quot;
	return 1
fi
</code></pre>
        </div>

        


        

<div class="post-archive">
    <h2>å…¶ä»–æ–‡ç« </h2>
    <ul class="listing">
        
        <li><a href="/linux/linux_tunning/">Linux ä¼˜åŒ–æŒ‡å—</a></li>
        
        <li><a href="/monitor/nginx-log-exporter/">prometheus-nginxlog-exporteræ„å»ºNginxæ—¥å¿—ç›‘æ§</a></li>
        
        <li><a href="/postgres/logical-replication_failover/">é€»è¾‘å¤åˆ¶æ•…éšœè½¬ç§»</a></li>
        
    </ul>
</div>



        <div class="post-meta meta-tags">
            
            æ²¡æœ‰æ ‡ç­¾
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "your github repo"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2018 - 2023 <a href="https://zhangeamon.top"> By Eamon</a>
        
        | <a rel="nofollow" target="_blank" href="http://www.beian.miit.gov.cn/">è¾½ICPå¤‡2022000054å·-1</a>
        
    </div>
    <br />
  
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>






    <script src='/js/douban.js'></script>


                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://zhangeamon.top/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://zhangeamon.top">
      <button type="submit" class="submit icon-search"></button>
</form>

    </section>
    
    <section class="widget">
        <h3 class="widget-title">æœ€è¿‘æ–‡ç« </h3>
<ul class="widget-list">
    
    <li>
        <a href="https://zhangeamon.top/python/pip/" title="python pip">python pip</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/postgres/repmgrd/" title="repmgrdä»‹ç»">repmgrdä»‹ç»</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/linux/linux_tunning/" title="Linux ä¼˜åŒ–æŒ‡å—">Linux ä¼˜åŒ–æŒ‡å—</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/monitor/nginx-log-exporter/" title="prometheus-nginxlog-exporteræ„å»ºNginxæ—¥å¿—ç›‘æ§">prometheus-nginxlog-exporteræ„å»ºNginxæ—¥å¿—ç›‘æ§</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/postgres/logical-replication_failover/" title="é€»è¾‘å¤åˆ¶æ•…éšœè½¬ç§»">é€»è¾‘å¤åˆ¶æ•…éšœè½¬ç§»</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/linux/nice/" title="nice, ionice, cpulimit">nice, ionice, cpulimit</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/linux/backlog-config/" title="Linux backlog/somaxconn å†…æ ¸å‚æ•°">Linux backlog/somaxconn å†…æ ¸å‚æ•°</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/storage/minio_ec/" title="Minioå­˜å‚¨ç±»åˆ«">Minioå­˜å‚¨ç±»åˆ«</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/postgres/wal_lsn/" title="LSN å’Œ walæ—¥å¿—æ–‡ä»¶åå¯¹åº”å…³ç³»">LSN å’Œ walæ—¥å¿—æ–‡ä»¶åå¯¹åº”å…³ç³»</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/middleware/kafka_install/" title="Kafkaé›†ç¾¤å®‰è£…">Kafkaé›†ç¾¤å®‰è£…</a>
    </li>
    
</ul>

    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories'>åˆ†ç±»</a></h3>
<ul class="widget-list">
    
    <li><a href="https://zhangeamon.top/categories/ansible/">ansible (4)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/docker/">docker (1)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/etcd/">etcd (1)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/haproxy/">haproxy (2)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/kafka/">kafka (1)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/kvm/">kvm (1)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/linux/">linux (21)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/minio/">minio (2)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/mysql/">mysql (4)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/nginx/">nginx (2)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/postgres/">postgres (48)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/python/">python (18)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/rabbitmq/">rabbitmq (2)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/redis/">redis (9)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/tidb/">tidb (5)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">ä¸­é—´ä»¶ (8)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E5%AD%98%E5%82%A8/">å­˜å‚¨ (2)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E5%AE%89%E5%85%A8/">å®‰å…¨ (3)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E6%95%B0%E4%BB%93/">æ•°ä»“ (3)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E7%9B%91%E6%8E%A7/">ç›‘æ§ (3)</a></li>
    
</ul>

    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags.html'>æ ‡ç­¾</a></h3>
<div class="tagcloud">
    
    <a href="https://zhangeamon.top/tags/%E4%BC%98%E5%8C%96/">ä¼˜åŒ–</a>
    
    <a href="https://zhangeamon.top/tags/%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/">é…ç½®ç®¡ç†</a>
    
    <a href="https://zhangeamon.top/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/">é«˜å¯ç”¨</a>
    
</div>

    </section>

    
<section class="widget">
    <h3 class="widget-title">å‹æƒ…é“¾æ¥</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="http://www.cnblogs.com/zhangeamon" title="å†å²åšå®¢">å†å²åšå®¢</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">å…¶å®ƒ</h3>
        <ul class="widget-list">
            <li><a href="https://zhangeamon.top/index.xml">æ–‡ç«  RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
   
</body>

</html>
