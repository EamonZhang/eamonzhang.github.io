<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <title>æ•°æ®åº“é«˜å¯ç”¨pgautofailover | Let&#39;s go ğŸŒ ğŸŒ ğŸŒ</title>
    <meta property="og:title" content="æ•°æ®åº“é«˜å¯ç”¨pgautofailover - Let&#39;s go ğŸŒ ğŸŒ ğŸŒ">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2022-07-11T15:15:51&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2022-07-11T15:15:51&#43;08:00'>
        
    <meta name="Keywords" content="postgres ã€pythonã€pg ã€linix ã€dockerã€ kubernetesã€ cloudã€hadoopã€promethues ">
    <meta name="description" content="æ•°æ®åº“é«˜å¯ç”¨pgautofailover">
        
    <meta name="author" content="Eamon">
    <meta property="og:url" content="https://zhangeamon.top/postgres/pgautofailover/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    
    
    <script type="text/javascript" src="/js/jquery.min.js"></script>
   
    
    
    
    
    
    
        <link rel="stylesheet" href='/css/douban.css'>
    
        <link rel="stylesheet" href='/css/other.css'>
    
   
        <a href=https://github.com/eamonzhang><img style="position: absolute; top: 0; left: 0; border: 0;" src="/images/forkme_left_red_aa0000.png" alt="Fork me on GitHub" data-canonical-src="/images/forkme_left_red_aa0000.png"></a>

   
        <script>
          var _hmt = _hmt || [];
            (function() {
            var hm = document.createElement("script");
            <!-- hm.src = "https://hm.baidu.com/hm.js?1f6605a363a50554aa03adcc685b7699"; -->
            hm.src = "https://hm.baidu.com/hm.js?0010600e9ae6ff8f5814bb7ec6b36072";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
          })();
       </script>
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://zhangeamon.top">
                        Let&#39;s go ğŸŒ ğŸŒ ğŸŒ
                    </a>
                
                <p class="description">Let&#39;s build our own cloud native together  </p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="" href="https://zhangeamon.top">é¦–é¡µ</a>
                    
                    <a  href="https://zhangeamon.top/archives" title="å½’æ¡£">å½’æ¡£</a>
                    
                    <a  href="https://zhangeamon.top/postgresql" title="Postgres">Postgres</a>
                    
                    <a  href="https://zhangeamon.top/linux" title="Linux">Linux</a>
                    
                    <a  href="https://zhangeamon.top/about/me" title="å…³äº">å…³äº</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    <style type="text/css">
    .post-toc {
        position: fixed;
        width: 200px;
        margin-left: -210px;
        padding: 5px 10px;
        font-family: Athelas, STHeiti, Microsoft Yahei, serif;
        font-size: 12px;
        border: 1px solid rgba(0, 0, 0, .07);
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.98);
        background-clip: padding-box;
        -webkit-box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        word-wrap: break-word;
        white-space: nowrap;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        z-index: 999;
        cursor: pointer;
        max-height: 70%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .post-toc .post-toc-title {
        width: 100%;
        margin: 0 auto;
        font-size: 20px;
        font-weight: 400;
        text-transform: uppercase;
        text-align: center;
    }

    .post-toc .post-toc-content {
        font-size: 15px;
    }

    .post-toc .post-toc-content>nav>ul {
        margin: 10px 0;
    }

    .post-toc .post-toc-content ul {
        padding-left: 20px;
        list-style: square;
        margin: 0.5em;
        line-height: 1.8em;
    }

    .post-toc .post-toc-content ul ul {
        padding-left: 15px;
        display: none;
    }

    @media print,
    screen and (max-width:1057px) {
        .post-toc {
            display: none;
        }
    }
</style>
<div class="post-toc" style="position: absolute; top: 188px;">
    <h2 class="post-toc-title">ç›®å½•</h2>
    <div class="post-toc-content">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#ä¸€ä¸ªç®€å•çš„æ¶æ„">ä¸€ä¸ªç®€å•çš„æ¶æ„</a></li>
    <li><a href="#é›†ç¾¤æ­å»º">é›†ç¾¤æ­å»º</a>
      <ul>
        <li><a href="#ç¯å¢ƒè¯´æ˜">ç¯å¢ƒè¯´æ˜</a></li>
        <li><a href="#ä»é›¶å¼€å§‹å»ºè®¾">ä»é›¶å¼€å§‹å»ºè®¾</a></li>
        <li><a href="#ç°æœ‰æ•°æ®åº“æ¥ç®¡">ç°æœ‰æ•°æ®åº“æ¥ç®¡</a></li>
      </ul>
    </li>
    <li><a href="#é›†ç¾¤ç®¡ç†">é›†ç¾¤ç®¡ç†</a>
      <ul>
        <li><a href="#çŠ¶æ€æŸ¥çœ‹">çŠ¶æ€æŸ¥çœ‹</a></li>
        <li><a href="#æ‰‹åŠ¨switch">æ‰‹åŠ¨switch</a></li>
        <li><a href="#è‡ªåŠ¨failover">è‡ªåŠ¨failover</a></li>
        <li><a href="#ç»´æŠ¤æ¨¡å¼">ç»´æŠ¤æ¨¡å¼</a></li>
        <li><a href="#å¢å‡èŠ‚ç‚¹">å¢å‡èŠ‚ç‚¹</a></li>
        <li><a href="#åˆ‡æ¢ç­–ç•¥æœºåˆ¶">åˆ‡æ¢ç­–ç•¥æœºåˆ¶</a></li>
      </ul>
    </li>
    <li><a href="#å¤šé›†ç¾¤ç®¡ç†">å¤šé›†ç¾¤ç®¡ç†</a>
      <ul>
        <li><a href="#å¤šé›†ç¾¤ç®¡ç†è¯´æ˜">å¤šé›†ç¾¤ç®¡ç†è¯´æ˜</a></li>
        <li><a href="#å…·ä½“å®ç°æ¡ˆä¾‹">å…·ä½“å®ç°æ¡ˆä¾‹</a></li>
      </ul>
    </li>
    <li><a href="#ç›‘æ§èŠ‚ç‚¹é«˜å¯ç”¨">ç›‘æ§èŠ‚ç‚¹é«˜å¯ç”¨</a></li>
    <li><a href="#å®¢æˆ·ç«¯é«˜å¯ç”¨">å®¢æˆ·ç«¯é«˜å¯ç”¨</a></li>
    <li><a href="#å¸¸ç”¨å‘½ä»¤">å¸¸ç”¨å‘½ä»¤</a></li>
    <li><a href="#å®‰å…¨åŠæƒé™">å®‰å…¨åŠæƒé™</a></li>
  </ul>
</nav>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var postToc = $(".post-toc");
        if (postToc.length) {
            var leftPos = $("#main").offset().left;
            if(leftPos<220){
                postToc.css({"width":leftPos-10,"margin-left":(0-leftPos)})
            }

            var t = postToc.offset().top - 20,
                a = {
                    start: {
                        position: "absolute",
                        top: t
                    },
                    process: {
                        position: "fixed",
                        top: 20
                    },
                };
            $(window).scroll(function () {
                var e = $(window).scrollTop();
                e < t ? postToc.css(a.start) : postToc.css(a.process)
            })
        }
    })
</script>

    <article class="post">
        <header>
            <h1 class="post-title">æ•°æ®åº“é«˜å¯ç”¨pgautofailover</h1>
        </header>
        <date class="post-meta meta-date">
            2022å¹´7æœˆ11æ—¥
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='/categories/postgres'>postgres</a></span>
            
        </div>
        
        
        
        <div class="clear" style="display: none">
            <div class="toc-article">
                <div class="toc-title">æ–‡ç« ç›®å½•</div>
            </div>
        </div>
        
        <div class="post-content">
            <h1 id="pg_auto_failover-å®è·µ">pg_auto_failover å®è·µ</h1>
<h2 id="ä¸€ä¸ªç®€å•çš„æ¶æ„">ä¸€ä¸ªç®€å•çš„æ¶æ„</h2>
<p>citusåŒæºpostgresé«˜å¯ç”¨æ–¹æ¡ˆ</p>
<p>è§’è‰²:</p>
<ul>
<li>ä¸»èŠ‚ç‚¹ (master)</li>
<li>å¤åˆ¶èŠ‚ç‚¹ (slave)</li>
<li>ç›‘æ§èŠ‚ç‚¹ (monitor)</li>
</ul>
<h2 id="é›†ç¾¤æ­å»º">é›†ç¾¤æ­å»º</h2>
<h3 id="ç¯å¢ƒè¯´æ˜">ç¯å¢ƒè¯´æ˜</h3>
<h4 id="è½¯ä»¶ç‰ˆæœ¬">è½¯ä»¶ç‰ˆæœ¬</h4>
<ul>
<li>postgresql 14.4</li>
<li>pg_auto_failover 1.6.4</li>
<li>centos 7</li>
</ul>
<h4 id="ç½‘ç»œç¯å¢ƒ">ç½‘ç»œç¯å¢ƒ</h4>
<table>
<thead>
<tr>
<th style="text-align:center">IP</th>
<th style="text-align:center">è½¯ä»¶</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">10.10.2.11</td>
<td style="text-align:center">monitor</td>
</tr>
<tr>
<td style="text-align:center">10.10.2.12</td>
<td style="text-align:center">master</td>
</tr>
<tr>
<td style="text-align:center">10.10.2.13</td>
<td style="text-align:center">replication</td>
</tr>
</tbody>
</table>
<h3 id="ä»é›¶å¼€å§‹å»ºè®¾">ä»é›¶å¼€å§‹å»ºè®¾</h3>
<p>â€‹	æ²¡æœ‰ä»»ä½•å†å²åŒ…è¢±ï¼ŒåŒ…æ‹¬æ•°æ®åº“è‡ªèº«çš„æ­å»º</p>
<p>â€‹	<strong>æ‰‹åŠ¨å®‰è£…</strong></p>
<p>â€‹     åœ¨æ‰€æœ‰çš„èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</p>
<pre><code>-- æ•°æ®åº“å®‰è£…
sudo yum install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm
sudo yum install -y postgresql14-server
</code></pre><pre><code># install pg_auto_failover
curl https://install.citusdata.com/community/rpm.sh | sudo bash
yum install pg_auto_failover_14.x86_64 -y

# confirm installation
/usr/pgsql-14/bin/pg_autoctl --version
</code></pre><p>â€‹     åˆ›å»ºmonitorèŠ‚ç‚¹</p>
<pre><code>--åˆ›å»ºç›‘æ§èŠ‚ç‚¹
su - postgres -c &quot;/usr/pgsql-14/bin/pg_autoctl create monitor \
   --hostname node0 \
   --auth trust \
   --ssl-self-signed \
   --pgdata /var/lib/pgsql/14/data/ \
   --pgctl /usr/pgsql-14/bin/pg_ctl &quot;

--å¯åŠ¨ç›‘æ§èŠ‚ç‚¹æœåŠ¡
/usr/pgsql-14/bin/pg_autoctl -q show systemd --pgdata &quot;/var/lib/pgsql/14/data&quot; | tee /etc/systemd/system/pgautofailover.service

systemctl start pgautofailover

-- æŸ¥çœ‹nodeè¿æ¥monitor ä¿¡æ¯
/usr/pgsql-14/bin/pg_autoctl show uri --formation monitor --pgdata /var/lib/pgsql/14/data/

postgres://autoctl_node@node0:5432/pg_auto_failover?sslmode=require

</code></pre><p>â€‹		åˆ›å»ºæ•°æ®åº“ä¸»èŠ‚ç‚¹</p>
<pre><code>-- åˆ›å»ºæ•°æ®åº“èŠ‚ç‚¹
su - postgres -c &quot;/usr/pgsql-14/bin/pg_autoctl create postgres \
    --hostname node1 \
    --name node1 \
    --pgctl /usr/pgsql-14/bin/pg_ctl \
    --pgdata /var/lib/pgsql/14/data/ \
    --auth trust \
    --ssl-self-signed \
    --monitor 'postgres://autoctl_node@node0:5432/pg_auto_failover?sslmode=require' \
    &quot;
    
</code></pre><pre><code>åˆ›å»ºèŠ‚ç‚¹è¯´æ˜ï¼Œåœ¨create postgresåï¼Œå°†åœ¨æœ¬åœ°ç”Ÿæˆé…ç½®ä¿¡æ¯ã€‚å…·ä½“å¯æŸ¥çœ‹
su - postgres -c &quot;/usr/pgsql-14/bin/pg_autoctl show file   --pgdata /var/lib/pgsql/14/data/&quot;
</code></pre><pre><code> ```
 -- systemd ç®¡ç†æœåŠ¡
 su - postgres -c &quot;/usr/pgsql-14/bin/pg_autoctl -q show systemd --pgdata /var/lib/pgsql/14/data &quot;  &gt; /etc/systemd/system/pgautofailover.service
 
 -- å¯åŠ¨æœåŠ¡
 systemctl start pgautofailover
 ```
</code></pre>
<p>â€‹		åˆ›å»ºæ•°æ®åº“ä»èŠ‚ç‚¹</p>
<pre><code>-- åœ¨å¦ä¸€ä¸ªèŠ‚ç‚¹åˆ›å»ºä»åº“
su - postgres -c &quot;/usr/pgsql-14/bin/pg_autoctl create postgres \
    --hostname node2 \
    --name node2 \
    --pgctl /usr/pgsql-14/bin/pg_ctl \
    --pgdata /var/lib/pgsql/14/data/ \
    --auth trust \
    --ssl-self-signed \
    --monitor 'postgres://autoctl_node@node0:5432/pg_auto_failover?sslmode=require' \
    &quot;
</code></pre><pre><code>-- systemd ç®¡ç†æœåŠ¡
su - postgres -c &quot;/usr/pgsql-14/bin/pg_autoctl -q show systemd --pgdata /var/lib/pgsql/14/data &quot;  &gt; /etc/systemd/system/pgautofailover.service

-- å¯åŠ¨æœåŠ¡
system start pgautofailover
</code></pre><pre><code>-- åœ¨monitorèŠ‚ç‚¹æŸ¥çœ‹çŠ¶æ€
/usr/pgsql-14/bin/pg_autoctl   show state --pgdata /var/lib/pgsql/14/data/

  Name |  Node |  Host:Port |       TLI: LSN |   Connection |      Reported State |      Assigned State
-------+-------+------------+----------------+--------------+---------------------+--------------------
node1 |     1 | node1:5432 |   1: 0/500BD90 |   read-write |             primary |             primary
 node2 |   111 | node2:5432 |   1: 0/500BD90 |    read-only |           secondary |           secondary

</code></pre><pre><code>-- åœ¨ç›‘æ§ç‚¹åˆ é™¤postgres
su - postgres -c &quot;/usr/pgsql-14/bin/pg_autoctl drop node  --destroy --force --name node2 &quot;
</code></pre><h3 id="ç°æœ‰æ•°æ®åº“æ¥ç®¡">ç°æœ‰æ•°æ®åº“æ¥ç®¡</h3>
<p>â€‹	ä¸å½±å“ç°æœ‰æ•°æ®åº“ä¸šåŠ¡ï¼Œä½¿å…¶å…·æœ‰é«˜å¯ç”¨èƒ½åŠ›</p>
<p>â€‹    ä¸ä»é›¶å¼€å§‹åˆ›å»ºé›†ç¾¤ä¸åŒçš„æ˜¯ï¼Œåœ¨create postgresé˜¶æ®µï¼Œæ ¹æ®    &ndash;pgdata ç›®å½•æ‰€æŒ‡å®šçš„ pg_controldata æ¥åˆ¤æ–­æ•°æ®åº“æ•°   æ®ç›®å½•ç°æœ‰æƒ…å†µã€‚åŒ…æ‹¬æ˜¯å¦éœ€è¦åˆå§‹åŒ–æ•°æ®åº“ï¼ŒåŠç°æœ‰æ•°æ®åº“çŠ¶æ€</p>
<h2 id="é›†ç¾¤ç®¡ç†">é›†ç¾¤ç®¡ç†</h2>
<h3 id="çŠ¶æ€æŸ¥çœ‹">çŠ¶æ€æŸ¥çœ‹</h3>
<pre><code>/usr/pgsql-14/bin/pg_autoctl   show state --pgdata /var/lib/pgsql/14/data/
</code></pre><h3 id="æ‰‹åŠ¨switch">æ‰‹åŠ¨switch</h3>
<pre><code>/usr/pgsql-14/bin/pg_autoctl  perform switchover --formation default --group 0  --pgdata /var/lib/pgsql/14/data/
</code></pre><h3 id="è‡ªåŠ¨failover">è‡ªåŠ¨failover</h3>
<h4 id="èŠ‚ç‚¹å¤±è´¥">èŠ‚ç‚¹å¤±è´¥</h4>
<pre><code>- ä¸»èŠ‚ç‚¹å¤±è´¥
  When the primary node is unhealthy, and only when the secondary node is itself in good health, then the primary node is asked to transition to the DRAINING state, and the attached secondary is asked to transition to the state PREPARE_PROMOTION. In this state, the secondary is asked to catch-up with the WAL traffic from the primary, and then report success.

The monitor then continues orchestrating the promotion of the standby: it stops the primary (implementing STONITH in order to prevent any data loss), and promotes the secondary into being a primary now.

Depending on the exact situation that triggered the primary unhealthy, itâ€™s possible that the secondary fails to catch-up with WAL from it, in that case after the PREPARE_PROMOTION_CATCHUP_TIMEOUT the standby reports success anyway, and the failover sequence continues from the monitor.

When the keeper reports an acceptable WAL difference in the two nodes again, then the replication is upgraded back to being synchronous. While a secondary node is not in the SECONDARY state, secondary promotion is disabled.
ä¸»æœºæ¢å¤åé‡æ–°åŠ å…¥é›†ç¾¤ä¸­ï¼Œå¹¶ä¸”çŠ¶æ€ä¸ºsecondary
</code></pre>
<pre><code>- å¤‡èŠ‚ç‚¹å¤±è´¥
When the secondary node is unhealthy, the monitor assigns to it the state CATCHINGUP, and assigns the state WAIT_PRIMARY to the primary node. When implementing the transition from PRIMARY to WAIT_PRIMARY, the keeper disables synchronous replication.
</code></pre><pre><code>- ç›‘æ§èŠ‚ç‚¹å¤±è´¥
Then the primary and secondary node just work as if you didnâ€™t have setup pg_auto_failover in the first place, as the keeper fails to report local state from the nodes. Also, health checks are not performed. It means that no automated failover may happen, even if needed.
</code></pre><p>å°½é‡é¿å…ç›‘æ§èŠ‚ç‚¹ä¸ä¸»èŠ‚ç‚¹åŒæ—¶å¤±è´¥çš„æƒ…å†µï¼Œå¦‚é¿å…åŒæœºæ¶ï¼ŒåŒæœºæˆ¿ï¼ŒåŒä¸€ä¸ªç½‘ç»œåˆ†åŒºã€‚</p>
<h4 id="ç½‘ç»œé—®é¢˜">ç½‘ç»œé—®é¢˜</h4>
<h3 id="ç»´æŠ¤æ¨¡å¼">ç»´æŠ¤æ¨¡å¼</h3>
<pre><code>$ pg_autoctl enable maintenance
$ pg_autoctl disable maintenance
</code></pre><h3 id="å¢å‡èŠ‚ç‚¹">å¢å‡èŠ‚ç‚¹</h3>
<p>â€‹	æ·»åŠ æ•°æ®åº“èŠ‚ç‚¹</p>
<p>â€‹		 ä¸å‰é¢åŠ å…¥ä»èŠ‚ç‚¹ä¸€è‡´</p>
<p>â€‹     åˆ é™¤æ•°æ®åº“èŠ‚ç‚¹</p>
<pre><code>-- åœ¨ç›‘æ§ç‚¹åˆ é™¤postgres
su - postgres -c &quot;/usr/pgsql-14/bin/pg_autoctl drop node  --destroy --force --name node3 --formation formation_name_003&quot;
</code></pre><h3 id="åˆ‡æ¢ç­–ç•¥æœºåˆ¶">åˆ‡æ¢ç­–ç•¥æœºåˆ¶</h3>
<pre><code> pgautofailover.health_check_max_retries | 2
 pgautofailover.health_check_period      | 20000
 pgautofailover.health_check_retry_delay | 2000
 pgautofailover.health_check_timeout     | 5000
</code></pre><h2 id="å¤šé›†ç¾¤ç®¡ç†">å¤šé›†ç¾¤ç®¡ç†</h2>
<h3 id="å¤šé›†ç¾¤ç®¡ç†è¯´æ˜">å¤šé›†ç¾¤ç®¡ç†è¯´æ˜</h3>
<p>â€‹	å¤šé›†ç¾¤è¿™é‡Œçš„å«ä¹‰æ˜¯ä¸€ä¸ªmonitorç®¡ç†å¤šå¥—é›†ç¾¤</p>
<p>â€‹	ä¸»è¦ç”¨åˆ°çš„ä¸¤ä¸ªæ¦‚å¿µ</p>
<ul>
<li>
<p>formation</p>
</li>
<li>
<p>group</p>
</li>
</ul>
<p><strong>A formation is a logical set of PostgreSQL services that are managed together.</strong></p>
<p><strong>It is possible to operate many formations with a single monitor instance. Each formation has a group of Postgres nodes and the FSM orchestration implemented by the monitor applies separately to each group.</strong></p>
<p>é€šè¿‡è¯´æ˜å¯ä»¥çŸ¥é“ï¼Œåˆ©ç”¨formationå¯ä»¥å®ç°ä¸€ä¸ªmonitorç®¡ç†å¤šå¥—é›†ç¾¤ã€‚</p>
<p><strong>A group consists of a PostgreSQL primary server and a secondary server setup with Hot Standby synchronous replication.</strong></p>
<p><strong>The notion of a formation that contains multiple groups in pg_auto_failover is useful when setting up and managing a whole Citus formation, where the coordinator nodes belong to group zero of the formation, and each Citus worker node becomes its own group and may have Postgres standby nodes.</strong></p>
<p>è¿™é‡Œæä¾›ä¸€ä¸ªæ€è·¯ï¼Œä¸€å¥—citusé›†ç¾¤åœ¨ä¸€ä¸ªformationä¹‹ä¸‹ï¼Œcitusä¸­çš„å¤šä¸ªä¸»ä»èŠ‚ç‚¹é€šè¿‡groupæ¥åŒºåˆ†ã€‚</p>
<h3 id="å…·ä½“å®ç°æ¡ˆä¾‹">å…·ä½“å®ç°æ¡ˆä¾‹</h3>
<h4 id="åˆ©ç”¨formation-ç®¡ç†å¤šå¥—é›†ç¾¤">åˆ©ç”¨formation ç®¡ç†å¤šå¥—é›†ç¾¤</h4>
<pre><code>-- åˆ›å»ºformation , é»˜è®¤ä½¿ç”¨default
/usr/pgsql-14/bin/pg_autoctl create formation \
 --pgdata /var/lib/pgsql/14/data/ \
 --monitor 'postgres://autoctl_node@node0:5432/pg_auto_failover1?sslmode=require' \
 --formation formation_name_003 \
 --kind pgsql \
 --dbname pg_auto_failover
</code></pre><pre><code>--æŸ¥çœ‹ formation ä¿¡æ¯
select * from pgautofailover.formation ;
    formationid     | kind  |      dbname       | opt_secondary | number_sync_standbys 
--------------------+-------+-------------------+---------------+----------------------
 default            | pgsql | postgres          | t             |                    0
 formation_name_003 | pgsql | postgres          | t             |                    0
(2 rows)
</code></pre><pre><code>-- åœ¨åˆ›å»ºæ•°æ®åº“èŠ‚ç‚¹æ—¶æŒ‡å®šformation
su - postgres -c &quot;/usr/pgsql-14/bin/pg_autoctl create postgres \
--hostname node3 \
--formation formation_name_003 \
--name node3 \
--pgctl /usr/pgsql-14/bin/pg_ctl \
--pgdata /var/lib/pgsql/14/data/ \
--auth trust \
--ssl-self-signed \
--monitor 'postgres://autoctl_node@node0:5432/pg_auto_failover?sslmode=require' \ 
&quot;

æ³¨æ„äº‹é¡¹: 
--hostname æœ¬æœºhostï¼Œ
--formation ä¸Šé¢åˆ›å»ºçš„formation ,
--nameèŠ‚ç‚¹åç§° ,
--monitor monitorèŠ‚ç‚¹è¿æ¥ä¿¡æ¯
</code></pre><pre><code>-- æŸ¥çœ‹æ•°æ®åº“èŠ‚ç‚¹æœ¬åœ°é…ç½®æ–‡ä»¶ä½ç½®
su - postgres -c &quot;/usr/pgsql-14/bin/pg_autoctl show file   --pgdata /var/lib/pgsql/14/data/&quot;
</code></pre><pre><code>-- åœ¨monitorèŠ‚ç‚¹æŸ¥çœ‹ æ•°æ®åº“nodeèŠ‚ç‚¹æ³¨å†Œæƒ…å†µ
select formationid,nodeid ,groupid,nodename from pgautofailover.node;
    formationid     | nodeid | groupid | nodename 
--------------------+--------+---------+----------
 formation_name_003 |    120 |       0 | node3
 default            |      1 |       0 | node_1
 default            |    111 |       0 | node2
(3 rows)

</code></pre><h4 id="åˆ©ç”¨group-ç®¡ç†citusä¸­çš„å¤šé›†ç¾¤">åˆ©ç”¨group ç®¡ç†citusä¸­çš„å¤šé›†ç¾¤</h4>
<p>åœ¨åˆ›å»ºpgèŠ‚ç‚¹æ—¶å¹¶æ²¡æœ‰å‚è€ƒç”¨æ¥æŒ‡å®šgroup, æ–‡æ¡£ä¸­æœ‰å¦‚ä¸‹å…³äºgroupçš„æè¿°ã€‚</p>
<p><strong>in a pgsql formation, there can be only one group, with groupId 0</strong></p>
<p><strong>At the moment citus formation kinds are not managed in the Open Source version of pg_auto_failover.</strong></p>
<p>å¾ˆé—æ†¾ï¼Œç°å¼€æºç‰ˆæœ¬å¹¶ä¸æ”¯æŒ citusç±»å‹çš„formationã€‚ ç±»å‹ä¸ºpgsqlçš„formationä¸­åªæ”¯æŒä¸ºé›¶çš„groupã€‚</p>
<p>ç”¨pgautofailoveræ¥ç®¡ç†citus é›†ç¾¤è¿˜æ˜¯ä½¿ç”¨å¤šä¸ªformaton å§</p>
<h2 id="ç›‘æ§èŠ‚ç‚¹é«˜å¯ç”¨">ç›‘æ§èŠ‚ç‚¹é«˜å¯ç”¨</h2>
<pre><code>-- æ•°æ®åº“çš„ä¸»ä»æµå¤åˆ¶ mon1ä¸»èŠ‚ç‚¹,mon2å¤åˆ¶èŠ‚ç‚¹ 
-- åœ¨åˆ›å»ºformation åŠ postgres èŠ‚ç‚¹æ—¶ï¼Œ å°†-- monitor å‚æ•°æŒ‡å®šä¸º
postgres://mon1:5432,mon2:5432,mon3:5432/pg_auto_failover?target_session_attrs=read-write&amp;sslmode=prefer
</code></pre><h2 id="å®¢æˆ·ç«¯é«˜å¯ç”¨">å®¢æˆ·ç«¯é«˜å¯ç”¨</h2>
<pre><code>$ psql -d &quot;postgresql://host1,host2/dbname?target_session_attrs=read-write&quot;
$ psql -d &quot;postgresql://host1:port2,host2:port2/dbname?target_session_attrs=read-write&quot;
$ psql -d &quot;host=host1,host2 port=port1,port2 target_session_attrs=read-write&quot;
</code></pre><h2 id="å¸¸ç”¨å‘½ä»¤">å¸¸ç”¨å‘½ä»¤</h2>
<p><a href="https://pg-auto-failover.readthedocs.io/en/master/ref/manual.html">https://pg-auto-failover.readthedocs.io/en/master/ref/manual.html</a></p>
<h2 id="å®‰å…¨åŠæƒé™">å®‰å…¨åŠæƒé™</h2>

        </div>

        


        

<div class="post-archive">
    <h2>å…¶ä»–æ–‡ç« </h2>
    <ul class="listing">
        
        <li><a href="/postgres/pg_rewrite/">pg_rewrite</a></li>
        
        <li><a href="/postgres/dts/">é€»è¾‘å¤åˆ¶å®ç°æ•°æ®è¿ç§»</a></li>
        
        <li><a href="/postgres/pg_buffercache/">pg_buffercache</a></li>
        
    </ul>
</div>



        <div class="post-meta meta-tags">
            
            æ²¡æœ‰æ ‡ç­¾
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "your github repo"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2018 - 2022 <a href="https://zhangeamon.top"> By Eamon</a>
        
    </div>
    <br />
  
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>






    <script src='/js/douban.js'></script>


                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://zhangeamon.top/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://zhangeamon.top">
      <button type="submit" class="submit icon-search"></button>
</form>

    </section>
    
    <section class="widget">
        <h3 class="widget-title">æœ€è¿‘æ–‡ç« </h3>
<ul class="widget-list">
    
    <li>
        <a href="https://zhangeamon.top/postgres/wal_lsn/" title="LSN å’Œ walæ—¥å¿—æ–‡ä»¶åå¯¹åº”å…³ç³»">LSN å’Œ walæ—¥å¿—æ–‡ä»¶åå¯¹åº”å…³ç³»</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/middleware/kafka_install/" title="Kafkaé›†ç¾¤å®‰è£…">Kafkaé›†ç¾¤å®‰è£…</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/postgres/upset/" title="upset ç”¨æ³•">upset ç”¨æ³•</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/postgres/debezium/" title="åˆ©ç”¨debezium å®ç°æ•°æ®å˜æ›´æ•è·">åˆ©ç”¨debezium å®ç°æ•°æ®å˜æ›´æ•è·</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/postgres/hll/" title="åˆ©ç”¨hllæ•°æ®ç±»å‹è¿›è¡Œæ•°æ®ç»Ÿè®¡">åˆ©ç”¨hllæ•°æ®ç±»å‹è¿›è¡Œæ•°æ®ç»Ÿè®¡</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/postgres/pgautofailover/" title="æ•°æ®åº“é«˜å¯ç”¨pgautofailover">æ•°æ®åº“é«˜å¯ç”¨pgautofailover</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/postgres/pg_rewrite/" title="pg_rewrite">pg_rewrite</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/postgres/dts/" title="é€»è¾‘å¤åˆ¶å®ç°æ•°æ®è¿ç§»">é€»è¾‘å¤åˆ¶å®ç°æ•°æ®è¿ç§»</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/postgres/pg_buffercache/" title="pg_buffercache">pg_buffercache</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/postgres/citus11/" title="citus11 ç®¡ç†æ‰‹å†Œ">citus11 ç®¡ç†æ‰‹å†Œ</a>
    </li>
    
</ul>

    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories'>åˆ†ç±»</a></h3>
<ul class="widget-list">
    
    <li><a href="https://zhangeamon.top/categories/ansible/">ansible (4)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/docker/">docker (1)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/etcd/">etcd (1)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/haproxy/">haproxy (2)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/kafka/">kafka (1)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/kvm/">kvm (1)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/linux/">linux (20)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/mysql/">mysql (4)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/nginx/">nginx (2)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/postgres/">postgres (46)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/python/">python (17)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/rabbitmq/">rabbitmq (2)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/redis/">redis (9)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/tidb/">tidb (5)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">ä¸­é—´ä»¶ (8)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E5%AD%98%E5%82%A8/">å­˜å‚¨ (3)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E5%AE%89%E5%85%A8/">å®‰å…¨ (3)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E6%95%B0%E4%BB%93/">æ•°ä»“ (3)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E7%9B%91%E6%8E%A7/">ç›‘æ§ (3)</a></li>
    
</ul>

    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags.html'>æ ‡ç­¾</a></h3>
<div class="tagcloud">
    
    <a href="https://zhangeamon.top/tags/%E4%BC%98%E5%8C%96/">ä¼˜åŒ–</a>
    
    <a href="https://zhangeamon.top/tags/%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/">é…ç½®ç®¡ç†</a>
    
    <a href="https://zhangeamon.top/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/">é«˜å¯ç”¨</a>
    
</div>

    </section>

    
<section class="widget">
    <h3 class="widget-title">å‹æƒ…é“¾æ¥</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="http://www.cnblogs.com/zhangeamon" title="å†å²åšå®¢">å†å²åšå®¢</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">å…¶å®ƒ</h3>
        <ul class="widget-list">
            <li><a href="https://zhangeamon.top/index.xml">æ–‡ç«  RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
   
</body>

</html>
