<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <title>é”ç­‰å¾… | Let&#39;s go ğŸŒ ğŸŒ ğŸŒ</title>
    <meta property="og:title" content="é”ç­‰å¾… - Let&#39;s go ğŸŒ ğŸŒ ğŸŒ">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2020-03-27T16:27:02&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2020-03-27T16:27:02&#43;08:00'>
        
    <meta name="Keywords" content="postgres ã€pythonã€pg ã€linix ã€dockerã€ kubernetesã€ cloudã€hadoopã€promethues ">
    <meta name="description" content="é”ç­‰å¾…">
        
    <meta name="author" content="Eamon">
    <meta property="og:url" content="https://zhangeamon.top/postgres/lock_wait/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    
    
    <script type="text/javascript" src="/js/jquery.min.js"></script>
   
    
    
    
    
    
    
        <link rel="stylesheet" href='/css/douban.css'>
    
        <link rel="stylesheet" href='/css/other.css'>
    
   
        <a href=https://github.com/eamonzhang><img style="position: absolute; top: 0; left: 0; border: 0;" src="/images/forkme_left_red_aa0000.png" alt="Fork me on GitHub" data-canonical-src="/images/forkme_left_red_aa0000.png"></a>

   
        <script>
          var _hmt = _hmt || [];
            (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?1f6605a363a50554aa03adcc685b7699";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
          })();
       </script>
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://zhangeamon.top">
                        Let&#39;s go ğŸŒ ğŸŒ ğŸŒ
                    </a>
                
                <p class="description">Let&#39;s build our own cloud native together  </p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="" href="https://zhangeamon.top">é¦–é¡µ</a>
                    
                    <a  href="https://zhangeamon.top/archives" title="å½’æ¡£">å½’æ¡£</a>
                    
                    <a  href="https://zhangeamon.top/postgresql" title="Postgres">Postgres</a>
                    
                    <a  href="https://zhangeamon.top/linux" title="Linux">Linux</a>
                    
                    <a  href="https://zhangeamon.top/about/me" title="å…³äº">å…³äº</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    

    <article class="post">
        <header>
            <h1 class="post-title">é”ç­‰å¾…</h1>
        </header>
        <date class="post-meta meta-date">
            2020å¹´3æœˆ27æ—¥
        </date>
        
        
        
        <div class="post-content">
            <h5 id="é”ç­‰å¾…åœºæ™¯">é”ç­‰å¾…åœºæ™¯</h5>
<p>ä¸€ä¸ªäº‹åŠ¡å°šæœªæ‰§è¡Œæäº¤æ—¶æŒæœ‰é”ï¼Œå½“å¦ä¸€ä¸ªäº‹åŠ¡éœ€è¦æŒæœ‰æ”¹è¡Œçš„é”æ—¶åˆ™éœ€è¦ç­‰å¾…ã€‚</p>
<p>Session 1</p>
<pre><code>postgres=# \d+ wt
                                     Table &quot;public.wt&quot;
 Column |  Type   | Collation | Nullable | Default | Storage  | Stats target | Description 
--------+---------+-----------+----------+---------+----------+--------------+-------------
 id     | integer |           |          |         | plain    |              | 
 t      | text    |           |          |         | extended |              | 

postgres=# begin;
BEGIN
postgres=# update wt set t = 'aaaa' where id = 1;
UPDATE 1
postgres=# select pg_backend_pid();
 pg_backend_pid 
----------------
          20034
(1 row)
</code></pre><p>Session 2</p>
<pre><code>postgres=# begin ;
BEGIN
postgres=# update wt set t = 'bbbb' where id = 1;
</code></pre><p>Session 3</p>
<pre><code>select * from pg_stat_activity;

-[ RECORD 3 ]----+----------------------------------------
datid            | 436980
datname          | postgres
pid              | 20476
usesysid         | 10
usename          | postgres
application_name | psql
client_addr      | 
client_hostname  | 
client_port      | -1
backend_start    | 2020-03-27 16:40:50.706409+08
xact_start       | 2020-03-27 16:40:55.515366+08
query_start      | 2020-03-27 16:41:09.139546+08
state_change     | 2020-03-27 16:41:09.13955+08
wait_event_type  | Lock
wait_event       | transactionid
state            | active
backend_xid      | 22112130
backend_xmin     | 22112129
query            | update wt set t = 'bbbb' where id = 1;
backend_type     | client backend
-[ RECORD 4 ]----+----------------------------------------
datid            | 436980
datname          | postgres
pid              | 20034
usesysid         | 10
usename          | postgres
application_name | psql
client_addr      | 192.168.6.78
client_hostname  | 
client_port      | 56464
backend_start    | 2020-03-27 16:33:27.223241+08
xact_start       | 2020-03-27 16:39:46.160577+08
query_start      | 2020-03-27 16:40:41.602471+08
state_change     | 2020-03-27 16:40:41.603281+08
wait_event_type  | Client
wait_event       | ClientRead
state            | idle in transaction
backend_xid      | 22112129
backend_xmin     | 
query            | update wt set t = 'aaaa' where id = 1;
backend_type     | client backend

</code></pre><p>ç¬¬äºŒä¸ªSessionä¸­çš„äº‹åŠ¡åœ¨ç­‰å¾…ç€ç¬¬ä¸€ä¸ªäº‹åŠ¡çš„æäº¤ã€‚</p>
<p>æœªæäº¤äº‹åŠ¡ç‰¹ç‚¹ wait_event = idle in transaction</p>
<p>ç­‰å¾…äº‹åŠ¡ç‰¹ç‚¹ wait_event_type = Lock ,wait_event = transactionid ,state=active</p>
<h4 id="æŸ¥çœ‹æ•°æ®åº“ä¸­çš„é”ç­‰å¾…">æŸ¥çœ‹æ•°æ®åº“ä¸­çš„é”ç­‰å¾…</h4>
<pre><code>with      
t_wait as      
(      
  select a.mode,a.locktype,a.database,a.relation,a.page,a.tuple,a.classid,a.granted,     
  a.objid,a.objsubid,a.pid,a.virtualtransaction,a.virtualxid,a.transactionid,a.fastpath,      
  b.state,b.query,b.xact_start,b.query_start,b.usename,b.datname,b.client_addr,b.client_port,b.application_name     
    from pg_locks a,pg_stat_activity b where a.pid=b.pid and not a.granted     
),     
t_run as     
(     
  select a.mode,a.locktype,a.database,a.relation,a.page,a.tuple,a.classid,a.granted,     
  a.objid,a.objsubid,a.pid,a.virtualtransaction,a.virtualxid,a.transactionid,a.fastpath,     
  b.state,b.query,b.xact_start,b.query_start,b.usename,b.datname,b.client_addr,b.client_port,b.application_name     
    from pg_locks a,pg_stat_activity b where a.pid=b.pid and a.granted     
),     
t_overlap as     
(     
  select r.* from t_wait w join t_run r on     
  (     
    r.locktype is not distinct from w.locktype and     
    r.database is not distinct from w.database and     
    r.relation is not distinct from w.relation and     
    r.page is not distinct from w.page and     
    r.tuple is not distinct from w.tuple and     
    r.virtualxid is not distinct from w.virtualxid and     
    r.transactionid is not distinct from w.transactionid and     
    r.classid is not distinct from w.classid and     
    r.objid is not distinct from w.objid and     
    r.objsubid is not distinct from w.objsubid and     
    r.pid &lt;&gt; w.pid     
  )      
),      
t_unionall as      
(      
  select r.* from t_overlap r      
  union all      
  select w.* from t_wait w      
)      
select locktype,datname,relation::regclass,page,tuple,virtualxid,transactionid::text,classid::regclass,objid,objsubid,     
string_agg(     
'Pid: '||case when pid is null then 'NULL' else pid::text end||chr(10)||     
'Lock_Granted: '||case when granted is null then 'NULL' else granted::text end||' , Mode: '||case when mode is null then 'NULL' else mode::text end||' , FastPath: '||case when fastpath is null then 'NULL' else fastpath::text end||' , VirtualTransaction: '||case when virtualtransaction is null then 'NULL' else virtualtransaction::text end||' , Session_State: '||case when state is null then 'NULL' else state::text end||chr(10)||     
'Username: '||case when usename is null then 'NULL' else usename::text end||' , Database: '||case when datname is null then 'NULL' else datname::text end||' , Client_Addr: '||case when client_addr is null then 'NULL' else client_addr::text end||' , Client_Port: '||case when client_port is null then 'NULL' else client_port::text end||' , Application_Name: '||case when application_name is null then 'NULL' else application_name::text end||chr(10)||      
'Xact_Start: '||case when xact_start is null then 'NULL' else xact_start::text end||' , Query_Start: '||case when query_start is null then 'NULL' else query_start::text end||' , Xact_Elapse: '||case when (now()-xact_start) is null then 'NULL' else (now()-xact_start)::text end||' , Query_Elapse: '||case when (now()-query_start) is null then 'NULL' else (now()-query_start)::text end||chr(10)||      
'SQL (Current SQL in Transaction): '||chr(10)||    
case when query is null then 'NULL' else query::text end,      
chr(10)||'--------'||chr(10)      
order by      
  (  case mode      
    when 'INVALID' then 0     
    when 'AccessShareLock' then 1     
    when 'RowShareLock' then 2     
    when 'RowExclusiveLock' then 3     
    when 'ShareUpdateExclusiveLock' then 4     
    when 'ShareLock' then 5     
    when 'ShareRowExclusiveLock' then 6     
    when 'ExclusiveLock' then 7     
    when 'AccessExclusiveLock' then 8     
    else 0     
  end  ) desc,     
  (case when granted then 0 else 1 end)    
) as lock_conflict    
from t_unionall     
group by     
locktype,datname,relation,page,tuple,virtualxid,transactionid::text,classid,objid,objsubid ;
</code></pre><h4 id="æ¶ˆé™¤é”ç­‰å¾…">æ¶ˆé™¤é”ç­‰å¾…</h4>
<pre><code>select pg_cancel_backend(pid);


select pg_terminate_backend(pid);
</code></pre><h5 id="ç›‘æ§æ–¹æ¡ˆ">ç›‘æ§æ–¹æ¡ˆ</h5>
<p>é•¿äº‹åŠ¡ç›‘æ§</p>
<pre><code>select extract(epoch from max(age(now(), query_start))) from pg_stat_activity where state &lt;&gt; 'idle' and (backend_xid is not null or backend_xmin is not null);
</code></pre><p>é•¿äº‹åŠ¡æŸ¥çœ‹</p>
<pre><code>select * from pg_stat_activity  pg_stat_activity where state &lt;&gt; 'idle' and (backend_xid is not null or backend_xmin is not null) order by query_start asc limit 1;

select * from pg_stat_activity  pg_stat_activity where state &lt;&gt; 'idle' and (backend_xid is not null or backend_xmin is not null) and backend_type = 'client backend' order by query_start asc limit 1;
</code></pre><p>2pc</p>
<pre><code>select * from pg_prepared_statements;
</code></pre><h5 id="æ—¥å¿—è®°å½•">æ—¥å¿—è®°å½•</h5>
<p>å½“å µå¡æ—¶é—´å¤§äºdeadlock (1s) æ—¶</p>
<p>å…¨å±€</p>
<pre><code> set log_lock_waits TO ON;
</code></pre><p>æŒ‡å®šæ•°æ®åº“</p>
<pre><code> alter database dbname set log_lock_waits TO ON;
</code></pre><p>æ—¥å¿—å†…å®¹å¦‚ä¸‹</p>
<pre><code>2020-03-31 09:16:32.704 CST,&quot;postgres&quot;,&quot;postgres&quot;,25436,&quot;[local]&quot;,5e8299b7.635c,5,&quot;UPDATE waiting&quot;,2020-03-31 09:15:35 CST,4/52140,22112144,LOG,00000,&quot;process 25436 still waiting for ShareLock on transaction 22112143 after 1000.162 ms&quot;,&quot;Process holding the lock: 24758. Wait queue: 25436.&quot;,,,,&quot;while updating tuple (0,39) in relation &quot;&quot;wt&quot;&quot;&quot;,&quot;update wt set t = 'bbbb' where id = 1;&quot;,,,&quot;psql&quot;
2020-03-31 09:18:25.946 CST,&quot;postgres&quot;,&quot;postgres&quot;,25436,&quot;[local]&quot;,5e8299b7.635c,6,&quot;UPDATE waiting&quot;,2020-03-31 09:15:35 CST,4/52140,22112144,LOG,00000,&quot;process 25436 acquired ShareLock on transaction 22112143 after 114242.016 ms&quot;,,,,,&quot;while updating tuple (0,39) in relation &quot;&quot;wt&quot;&quot;&quot;,&quot;update wt set t = 'bbbb' where id = 1;&quot;,,,&quot;psql&quot;
2020-03-31 09:18:25.946 CST,&quot;postgres&quot;,&quot;postgres&quot;,25436,&quot;[local]&quot;,5e8299b7.635c,7,&quot;UPDATE&quot;,2020-03-31 09:15:35 CST,4/52140,22112144,LOG,00000,&quot;duration: 114244.352 ms&quot;,,,,,,,,,&quot;psql&quot;
plate_number
</code></pre><p>25436 è¢« 24758 å µå¡</p>
<h5 id="æŸ¥çœ‹è°å µå¡äº†è°">æŸ¥çœ‹è°å µå¡äº†è°</h5>
<pre><code>pg_blocking_pids(pid)
</code></pre>
        </div>

        


        

<div class="post-archive">
    <h2>å…¶ä»–æ–‡ç« </h2>
    <ul class="listing">
        
        <li><a href="/dw/algorithm/">æ•°æ®æŒ–æ˜ç®—æ³•</a></li>
        
        <li><a href="/linux/install-cmd/">è½¯ä»¶å®‰è£…</a></li>
        
        <li><a href="/postgres/install02/">æ•°æ®åº“å®‰è£… Postgres12 Ubuntu18</a></li>
        
    </ul>
</div>



        <div class="post-meta meta-tags">
            
            æ²¡æœ‰æ ‡ç­¾
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "your github repo"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2018 - 2021 <a href="https://zhangeamon.top"> By Eamon</a>
        
    </div>
    <br />
  
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>






    <script src='/js/douban.js'></script>


                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://zhangeamon.top/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://zhangeamon.top">
      <button type="submit" class="submit icon-search"></button>
</form>

    </section>
    
    <section class="widget">
        <h3 class="widget-title">æœ€è¿‘æ–‡ç« </h3>
<ul class="widget-list">
    
    <li>
        <a href="https://zhangeamon.top/redis/automated-keyword/" title="è”æƒ³æœç´¢">è”æƒ³æœç´¢</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/python/push_messages/" title="æ¶ˆæ¯æ¨é€">æ¶ˆæ¯æ¨é€</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/postgres/pg_elk/" title="æ•°æ®åº“æ—¥å¿—åˆ†æ">æ•°æ®åº“æ—¥å¿—åˆ†æ</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/linux/findhidpid/" title="Linux æ‰¾å‡ºéšè—è¿›ç¨‹">Linux æ‰¾å‡ºéšè—è¿›ç¨‹</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/network-security/wazuh/" title="Wazuh åŠŸèƒ½ç®€ä»‹">Wazuh åŠŸèƒ½ç®€ä»‹</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/linux/last/" title="Linux ç³»ç»Ÿç™»é™†è®°å½•">Linux ç³»ç»Ÿç™»é™†è®°å½•</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/linux/ubuntu2004-qa/" title="Ubuntu20.04 è£…æœºå">Ubuntu20.04 è£…æœºå</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/mysql/master-slave/" title="ä¸»ä»å¤åˆ¶">ä¸»ä»å¤åˆ¶</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/mysql/connections/" title="è¿æ¥æ•°ç®¡ç†">è¿æ¥æ•°ç®¡ç†</a>
    </li>
    
    <li>
        <a href="https://zhangeamon.top/redis/pubsub/" title="å‘å¸ƒè®¢é˜…">å‘å¸ƒè®¢é˜…</a>
    </li>
    
</ul>

    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories'>åˆ†ç±»</a></h3>
<ul class="widget-list">
    
    <li><a href="https://zhangeamon.top/categories/ansible/">ansible (4)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/docker/">docker (1)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/etcd/">etcd (1)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/linux/">linux (15)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/mysql/">mysql (4)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/postgres/">postgres (20)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/python/">python (15)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/rabbitmq/">rabbitmq (2)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/redis/">redis (8)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">ä¸­é—´ä»¶ (10)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E5%AD%98%E5%82%A8/">å­˜å‚¨ (3)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E5%AE%89%E5%85%A8/">å®‰å…¨ (2)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E6%95%B0%E4%BB%93/">æ•°ä»“ (3)</a></li>
    
    <li><a href="https://zhangeamon.top/categories/%E7%9B%91%E6%8E%A7/">ç›‘æ§ (2)</a></li>
    
</ul>

    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags.html'>æ ‡ç­¾</a></h3>
<div class="tagcloud">
    
    <a href="https://zhangeamon.top/tags/%E4%BC%98%E5%8C%96/">ä¼˜åŒ–</a>
    
    <a href="https://zhangeamon.top/tags/%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/">é…ç½®ç®¡ç†</a>
    
    <a href="https://zhangeamon.top/tags/%E9%AB%98%E5%8F%AF%E7%94%A8/">é«˜å¯ç”¨</a>
    
</div>

    </section>

    
<section class="widget">
    <h3 class="widget-title">å‹æƒ…é“¾æ¥</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="http://www.cnblogs.com/zhangeamon" title="å†å²åšå®¢">å†å²åšå®¢</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">å…¶å®ƒ</h3>
        <ul class="widget-list">
            <li><a href="https://zhangeamon.top/index.xml">æ–‡ç«  RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
   
</body>

</html>
